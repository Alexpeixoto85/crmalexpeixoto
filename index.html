
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Imobiliário de Luxo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* CSS Incorporado para o sistema de arquivo único */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');


        :root {
            --primary-color: #D4AF37;       /* Dourado Clássico */
            --secondary-color: #2C3E50;     /* Azul Ardósia / Grafite */
            --accent-color: #3498DB;        /* Azul Vibrante para Ações */
            --background-color: #F4F6F9;    /* Cinza Muito Claro */
            --surface-color: #FFFFFF;       /* Branco */
            --text-color: #34495E;          /* Cinza Escuro */
            --text-light-color: #FFF;
            --danger-color: #E74C3C;        /* Vermelho Suave */
            --success-color: #2ECC71;      /* Verde Suave */
            --warning-color: #F39C12;       /* Laranja Suave */
            --font-family: 'Montserrat', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: var(--secondary-color);
            color: var(--text-light-color);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            flex-shrink: 0;
        }

        .logo-container { display: flex; align-items: center; gap: 1rem; }
        #header-logo { max-height: 50px; border-radius: 5px; object-fit: contain; }
        .broker-info h1 { font-size: 1.2rem; font-weight: 600; }
        .broker-info p { font-size: 0.9rem; opacity: 0.8; }

        nav { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .nav-btn {
            background: none;
            border: none;
            color: var(--text-light-color);
            padding: 0.8rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-family: var(--font-family);
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
        }
        .nav-btn:hover { background-color: rgba(255,255,255,0.1); }
        .nav-btn.active { background-color: var(--primary-color); color: var(--secondary-color); font-weight: 700; }
        .nav-btn i { margin-right: 8px; }

        .header-tools .calculator-link {
            color: var(--text-light-color);
            font-size: 1.5rem;
            text-decoration: none;
            transition: color 0.3s;
        }
        .header-tools .calculator-link:hover { color: var(--primary-color); }

        main {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .panel { display: none; animation: fadeIn 0.5s; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 1.5rem;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }
        
        h3, .form-section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--secondary-color);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }
        .modal-body h3, .modal-body .form-section-title { margin-top: 1rem; }


        .toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        input[type="text"], input[type="url"], input[type="number"], input[type="date"], input[type="time"], input[type="email"], select, textarea {
            padding: 0.8rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
            font-family: var(--font-family);
            flex-grow: 1;
            background-color: #fff; /* Garante fundo branco */
        }
        select:disabled {
            background-color: #eee;
            cursor: not-allowed;
        }
        .toolbar > input[type="text"] {
             min-width: 250px;
        }

        .btn-primary, .btn-secondary, .btn-danger, .btn-link, .btn-success {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            font-family: var(--font-family);
            text-align: center;
            white-space: nowrap;
        }
        .btn-primary { background-color: var(--primary-color); color: var(--secondary-color); }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-secondary { background-color: var(--secondary-color); color: var(--text-light-color); }
        .btn-secondary:hover { filter: brightness(1.3); }
        .btn-danger { background-color: var(--danger-color); color: var(--text-light-color); }
        .btn-danger:hover { filter: brightness(1.1); }
        .btn-success { background-color: var(--success-color); color: var(--text-light-color); }
        .btn-success:hover { filter: brightness(1.1); }
        .btn-link { background: none; color: var(--secondary-color); text-decoration: underline; padding: 0; }
        button i, a i { margin-right: 8px; }

        .table-container {
            background-color: var(--surface-color);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #eee; }
        td { white-space: normal; word-break: break-word; }
        th { white-space: nowrap; }
        th { background-color: #f8f9fa; font-weight: 600; color: var(--secondary-color); }
        tbody tr:hover { background-color: #f1f1f1; }
        .action-buttons { display:flex; gap: 0.8rem; white-space: nowrap; }
        .action-buttons button, .action-buttons a { background: none; border: none; cursor: pointer; font-size: 1.1rem; color: var(--secondary-color); padding: 0; }
        .action-buttons button:hover, .action-buttons a:hover { color: var(--primary-color); }

        .funnel-filters { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .funnel-filter-btn {
            background-color: #e0e0e0;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .funnel-filter-btn.active { background-color: var(--secondary-color); color: white; }

        .settings-grid, .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }
        
        /* ===== SEÇÃO FINANCEIRA REESTRUTURADA ===== */
        .financial-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .financial-panel-header h2 { margin-bottom: 0; }
        .financial-panel-header .header-buttons { display: flex; gap: 1rem; flex-wrap: wrap; }
        .financial-grid-container {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .financial-card {
            background-color: var(--surface-color);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            grid-column: span 12; /* Padrão para telas pequenas */
        }
        .financial-card h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            opacity: 0.9;
            font-weight: 600;
        }
        .metric-card-content { display: flex; align-items: center; gap: 1.5rem; }
        .metric-icon {
            font-size: 2.5rem; color: var(--primary-color); background-color: #fdf6e3;
            padding: 1rem; border-radius: 50%; width: 60px; height: 60px;
            display: flex; justify-content: center; align-items: center;
        }
        .metric-card .metric-value { font-size: 1.8rem; font-weight: 700; color: var(--secondary-color); line-height: 1.2; }
        .chart-card { min-height: 350px; display: flex; flex-direction: column; }
        .chart-card canvas { flex-grow: 1; }
        @media (min-width: 600px) { .financial-card.metric-card { grid-column: span 6; } }
        @media (min-width: 992px) {
            .financial-card.metric-card { grid-column: span 3; }
            .financial-card.chart-card { grid-column: span 6; }
            .financial-card.bi-card { grid-column: span 12; }
        }

        .settings-card, .dashboard-card {
            background-color: var(--surface-color);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .settings-card h3, .dashboard-card h3 { margin-bottom: 1rem; color: var(--secondary-color); }
        .settings-card input, .settings-card select { width: 100%; margin-bottom: 1rem; }
        .settings-card button { width: 100%; margin-top: 0.5rem; }
        .settings-card hr { border: 0; border-top: 1px solid #eee; margin: 1rem 0; }

        /* ===== ESTILOS PARA FUNIL ARRASTÁVEL ===== */
        #funnel-editor .stage-item, #portfolio-list .portfolio-item, #amenities-list .amenity-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.5rem; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 0.5rem;
            user-select: none;
            background-color: var(--surface-color);
        }
        #funnel-editor .stage-item, #portfolio-list .portfolio-item { cursor: move; }

        #funnel-editor .stage-item.dragging, #portfolio-list .portfolio-item.dragging { opacity: 0.5; background-color: #eaf2f8; }
        #funnel-editor input { margin: 0 0.5rem; flex-grow: 1; }
        #funnel-editor .stage-item button, #amenities-list .amenity-list-item button { background: none; border: none; color: var(--danger-color); cursor: pointer; }
        .drag-over-indicator { height: 2px; background: var(--accent-color); margin: 4px 0; border-radius: 1px; }

        /* ===== MODAIS ===== */
        .modal-container, .alert-modal-container {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6);
            justify-content: center; align-items: center;
        }
        .modal-container.active, .alert-modal-container.active { display: flex; }
        .modal-content, .alert-modal-content {
            background-color: #fefefe; margin: auto; padding: 2rem;
            border-radius: 10px; width: 90%;
            position: relative; animation: slideDown 0.5s;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-content { max-width: 800px; }
        .alert-modal-content { max-width: 500px; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header, .alert-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2, .alert-modal-header h2 { margin-bottom: 0; border: none; }
        .modal-close-btn, .alert-modal-close-btn { font-size: 2rem; font-weight: bold; cursor: pointer; background: none; border: none; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        .modal-footer { margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem; }
        .alert-modal-body p { margin-bottom: 1rem; line-height: 1.6; }
        .alert-modal-body i { color: var(--warning-color); margin-right: 10px; }
        
        /* ===== INÍCIO: NOVOS ESTILOS PARA VARIAÇÕES DE IMÓVEIS ===== */
        #variation-manager-container {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        .variation-item {
            background: var(--surface-color);
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .variation-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        .variation-item-header span { font-size: 1.1rem; }
        .variation-item-body .form-grid {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Mais colunas, menores */
            gap: 1rem;
        }
        .variation-item-body .form-group {
            margin-bottom: 0; /* Remove margem dupla */
        }
        .variation-item-body .form-group label {
            font-size: 0.8rem; /* Labels menores */
        }
        .variation-item-body input[type="number"] {
            padding: 0.6rem; /* Campos menores */
        }
        .variation-form-toggle {
            background: #f1f1f1;
            padding: 1rem;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            color: var(--secondary-color);
        }
        #add-variation-form {
            display: none;
            background: #fdfdfd;
            border: 1px dashed var(--primary-color);
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
        }
        #add-variation-form .form-grid {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        #add-variation-form .form-group.full-width { grid-column: span 2; }
        @media (min-width: 992px) {
            #add-variation-form .form-grid { grid-template-columns: 2fr 1fr 1fr; }
            #add-variation-form .form-group.full-width { grid-column: 1 / -1; }
            #add-variation-form .form-grid-payment {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
                grid-column: 1 / -1;
            }
        }
        /* ===== FIM: NOVOS ESTILOS PARA VARIAÇÕES DE IMÓVEIS ===== */


        /* Estilos para cards de BI e Fichas de Visualização */
        .metric-value { font-size: 2rem; font-weight: 700; color: var(--primary-color); }
        .metric-label { font-size: 1rem; opacity: 0.8; }
        .bi-insight { margin-top: 1rem; font-size: 0.9rem; }
        .bi-insight strong { color: var(--secondary-color); }
        .record-details h3, .report-section h3 { color: var(--secondary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; margin-top: 20px; font-size: 1.2rem; }
        .record-details p { line-height: 1.8; margin-bottom: 0.5rem; }
        .record-details strong { color: #333; }
        .record-details a { color: var(--accent-color); font-size: 1.5rem; text-decoration: none; }
        .record-details .main-image { max-width: 100%; border-radius: 8px; margin-bottom: 1rem; }
        .record-details .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; margin-top: 1rem; border-radius: 8px;}
        .record-details .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        
        /* Análise Financeira & Relatório de Funil */
        .analysis-result { background-color: #f8f9fa; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
        .analysis-result h4 { color: var(--secondary-color); }
        .analysis-result p { margin: 0.5rem 0; }
        .analysis-result .highlight-success { color: var(--success-color); font-weight: 700; font-size: 1.2rem; }
        .analysis-result .highlight-danger { color: var(--danger-color); font-weight: 700; font-size: 1.2rem; }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .report-card { background: #f8f9fa; padding: 1rem; border-radius: 5px; text-align: center; }
        .report-card .value { font-size: 1.5rem; font-weight: 700; color: var(--secondary-color); }
        .report-card .label { font-size: 0.9rem; }
        .report-section ul { list-style-position: inside; padding-left: 10px; }
        
        /* ===== INÍCIO: NOVO ESTILO PARA COMPATIBILIDADE ===== */
        .compatibility-score-container {
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 3px solid var(--warning-color);
        }
        .compatibility-score-container h3 {
            margin: 0 0 0.5rem 0;
            padding: 0;
            border: none;
            color: var(--secondary-color);
        }
        .compatibility-score-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--warning-color);
        }
        .compatibility-score-container.success { border-color: var(--success-color); }
        .compatibility-score-container.success .compatibility-score-value { color: var(--success-color); }
        .compatibility-score-container.danger { border-color: var(--danger-color); }
        .compatibility-score-container.danger .compatibility-score-value { color: var(--danger-color); }
        /* ===== FIM: NOVO ESTILO PARA COMPATIBILIDADE ===== */


        /* ===== INÍCIO: ESTILOS DA AGENDA-CALENDÁRIO ===== */
        #calendar-container {
            background-color: var(--surface-color);
            padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        #calendar-header button { background: none; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; padding: 0.5rem 1rem; }
        #month-year { font-size: 1.5rem; font-weight: 600; color: var(--secondary-color); }
        #calendar-grid, #weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; }
        #weekdays div { font-weight: bold; padding: 0.5rem 0; color: var(--secondary-color); }
        .calendar-day {
            border: 1px solid #eee; min-height: 120px; padding: 5px;
            display: flex; flex-direction: column; cursor: pointer; transition: background-color: 0.3s;
        }
        .calendar-day:hover { background-color: #f9f9f9; }
        .day-number { font-weight: bold; align-self: flex-start; }
        .calendar-day.other-month .day-number { opacity: 0.4; }
        .calendar-day.today .day-number {
            background-color: var(--primary-color); color: var(--secondary-color);
            border-radius: 50%; width: 28px; height: 28px;
            display: flex; justify-content: center; align-items: center;
        }
        .events-container { margin-top: 5px; flex-grow: 1; overflow-y: auto; max-height: 85px; }
        .event-pill {
    font-size: 0.75rem;
    padding: 3px 5px;
    margin-bottom: 3px;
    border-radius: 3px;
    background-color: var(--secondary-color);
    color: white;
    white-space: normal;     /* Permite a quebra de linha */
    overflow: visible;       /* Garante que o conteúdo não seja cortado */
    text-overflow: clip;     /* Remove o "..." */
    word-break: break-word;  /* Força a quebra de palavras longas */
}
        .event-pill i { margin-right: 4px; }
        .event-pill.event-pill-income { background-color: var(--success-color); }
        .event-pill.event-pill-expense { background-color: var(--danger-color); }
        .event-pill.completed { background-color: #6c757d; text-decoration: line-through; }
        .event-pill.overdue { background-color: var(--warning-color); }
        .day-events-list .event-item {
            background-color: #fff; border-left: 5px solid var(--secondary-color);
            padding: 1rem; margin-bottom: 1rem; border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .day-events-list .event-item.overdue { border-left-color: var(--danger-color); }
        .day-events-list .event-item.completed { text-decoration: line-through; opacity: 0.6; border-left-color: var(--success-color); }
        .day-events-list .birthday-item { border-left-color: #FFC107; }
        /* ===== FIM: ESTILOS DA AGENDA-CALENDÁRIO ===== */
        
        /* ===== INÍCIO: ESTILOS PARA DOCUMENTOS PDF ===== */
#pdf-generator {
    position: absolute; left: -9999px; top: -9999px;
    width: 210mm;
    background: white;
    color: #333;
}
.pdf-document-container {
    font-family: 'Roboto', sans-serif;
    font-size: 10pt; /* Reduzido de 11pt para caber mais texto */
    line-height: 1.3; /* Reduzido de 1.5 para aproximar as linhas */
    padding: 10mm; /* Margens reduzidas (era 15mm) */
}
.pdf-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    border-bottom: 2px solid #D4AF37;
    padding-bottom: 5mm; /* Espaçamento reduzido (era 8mm) */
    margin-bottom: 7mm; /* Espaçamento reduzido (era 10mm) */
}
.pdf-header-logo {
    max-width: 40mm; /* Logo reduzida (era 50mm) */
    max-height: 20mm; /* Logo reduzida (era 25mm) */
    object-fit: contain;
}
.pdf-header-info {
    text-align: right;
    font-size: 9pt;
}
.pdf-header-info h1 {
    font-family: 'Montserrat', sans-serif;
    font-size: 14pt;
    color: #2C3E50;
    margin: 0 0 5px 0;
}
.pdf-content h1, .pdf-content h2, .pdf-content h3 {
    font-family: 'Montserrat', sans-serif;
    color: #2C3E50;
    margin-top: 6mm; /* Espaçamento reduzido (era 8mm) */
    margin-bottom: 3mm; /* Espaçamento reduzido (era 5mm) */
    padding-bottom: 2mm;
    border-bottom: 1px solid #eee;
}
.pdf-content h1 { font-size: 14pt; text-align: center; } /* Fonte reduzida (era 16pt) */
.pdf-content h2 { font-size: 12pt; } /* Fonte reduzida (era 13pt) */
.pdf-content h3 { font-size: 11pt; margin-top: 5mm; margin-bottom: 2mm; border-bottom: none; } /* Espaçamento reduzido */
.pdf-content p { text-align: justify; margin-bottom: 2mm; } /* Espaçamento reduzido (era 4mm) */
.pdf-signatures { margin-top: 10mm; } /* Espaçamento reduzido (era 20mm) */
.pdf-signature-line {
    margin-top: 15mm; /* Espaçamento reduzido (era 20mm) */
    border-top: 1px solid #555;
    width: 70%;
    margin-left: auto;
    margin-right: auto;
    text-align: center;
    padding-top: 2mm;
    font-size: 10pt;
}
.pdf-centered-text { text-align: center; }
.receipt-value-box {
    background-color: #f4f6f9;
    border: 1px solid #ddd;
    padding: 8mm; /* Reduzido de 10mm */
    margin: 6mm 0; /* Reduzido de 8mm */
    text-align: center;
}
.receipt-value-box .value {
    font-size: 16pt; /* Reduzido de 18pt */
}
.receipt-value-box .value-in-words {
    font-size: 10pt;
    margin-top: 2mm; /* Reduzido de 3mm */
}
 /* ===== FIM: NOVOS ESTILOS PARA DOCUMENTOS PDF ===== */

        /* ===== INÍCIO: NOVO TEMPLATE DE PORTFÓLIO ===== */
        .portfolio-page-v2 {
            width: 210mm;
            height: 297mm;
            padding: 12mm;
            background-color: white;
            color: var(--text-color);
            font-family: 'Montserrat', sans-serif;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        .portfolio-v2-header {
    display: flex;
    align-items: center; /* Centraliza verticalmente */
    padding: 4mm 8mm; /* Adiciona um espaço interno */
    border: 2px solid var(--secondary-color);
    background-color: var(--secondary-color); /* ADICIONA A FAIXA AZUL */
}
        .portfolio-v2-broker-info { 
            text-align: center; /* Centraliza o texto */
            flex-grow: 1; /* Faz o bloco ocupar o espaço central */
        }
        .portfolio-v2-broker-info h1 {
    font-size: 22pt;
    color: var(--primary-color); /* Cor Dourada */
    margin: 0;
    font-weight: 700;
}
        .portfolio-v2-broker-info p {
    font-size: 9pt;
    margin: 2px 0 0 0;
    color: var(--text-light-color); /* Cor Branca */
}
        .portfolio-v2-logo {
            max-height: 15mm;
            max-width: 40mm;
            object-fit: contain;
        }
        .portfolio-v2-title {
            text-align: center;
            margin: 8mm 0;
        }
        .portfolio-v2-title h2 {
            font-size: 22pt;
            color: var(--secondary-color);
            margin: 0;
            font-weight: 700;
        }
        .portfolio-v2-title p {
            font-size: 11pt;
            margin-top: 2mm;
        }
        .portfolio-v2-image-gallery {
            display: grid;
            grid-template-columns: 2fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 4mm;
            height: 85mm;
            margin-bottom: 8mm;
        }
        .portfolio-v2-main-image {
            grid-column: 1 / 2;
            grid-row: 1 / 3;
            background-size: cover;
            background-position: center;
            border-radius: 4px;
        }
        .portfolio-v2-secondary-image-1, .portfolio-v2-secondary-image-2 {
            background-size: cover;
            background-position: center;
            border-radius: 4px;
        }
        .portfolio-v2-content-area {
            display: flex;
            gap: 8mm;
            flex-grow: 1;
        }
        .portfolio-v2-details {
            width: 55%;
        }
        .portfolio-v2-amenities {
            width: 45%;
        }
        .portfolio-v2-details h3, .portfolio-v2-amenities h3 {
            font-size: 12pt;
            color: var(--secondary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 2mm;
            margin-bottom: 4mm;
        }
        .portfolio-v2-description {
            font-size: 9.5pt;
            line-height: 1.6;
            text-align: justify;
        }
        .portfolio-v2-key-info {
            margin-top: 5mm;
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 4mm;
            font-size: 10pt;
        }
        .portfolio-v2-key-info p { margin: 0 0 2mm 0; }
        .portfolio-v2-amenities-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3mm 5mm;
            font-size: 9.5pt;
        }
        .portfolio-v2-amenity-item {
            display: flex;
            align-items: center;
            gap: 3mm;
        }
        .portfolio-v2-amenity-item i {
            color: var(--primary-color);
            width: 18px;
            text-align: center;
        }
        .portfolio-v2-footer {
            margin-top: auto;
            padding-top: 5mm;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            font-size: 8pt;
        }
        .portfolio-v2-motivational-text {
            font-style: italic;
            color: #555;
            width: 80%;
        }
        .portfolio-v2-page-number {
            color: #777;
        }
        /* ===== FIM: NOVO TEMPLATE DE PORTFÓLIO ===== */

        /* Galeria de Imagens */
        #image-gallery-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        #image-gallery-modal.active { display: flex; }
        #gallery-image-container { position: relative; width: 90%; height: 80%; }
        #gallery-image-container img { width: 100%; height: 100%; object-fit: contain; }
        .gallery-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.5); color: white; border: none;
            font-size: 2.5rem; cursor: pointer; padding: 0 1rem;
        }
        #gallery-prev { left: 10px; }
        #gallery-next { right: 10px; }
        .gallery-tool {
            position: absolute; top: 15px;
            background: rgba(0,0,0,0.5); color: white; border: none;
            font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 5px;
        }
        #gallery-close { right: 15px; }
        #gallery-fullscreen { right: 70px; }
        #gallery-counter { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); color: white; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px;}

        /* Thumbnails de upload */
        #prop-image-previews, #note-image-previews { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .img-preview-container { position: relative; }
        .img-preview-container img { width: 100px; height: 100px; object-fit: cover; border-radius: 5px; }
        .remove-img-btn {
            position: absolute; top: -5px; right: -5px;
            background: var(--danger-color); color: white;
            border: none; border-radius: 50%;
            width: 20px; height: 20px; font-size: 12px;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
        }
        .main-image-selector {
            position: absolute; bottom: 5px; left: 5px;
            color: #ccc; cursor: pointer; font-size: 1.2rem;
            text-shadow: 0 0 3px black; transition: color 0.2s;
        }
        .main-image-selector:hover { color: #e0e0e0; }
        .main-image-selector.active { color: var(--primary-color); }

        /* Gráfico do Funil */
        #funnel-chart-container {
            background-color: var(--surface-color);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-top: 2rem;
        }
        #funnel-chart {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 300px;
            border-left: 2px solid #ccc;
            border-bottom: 2px solid #ccc;
            padding: 10px 0;
        }
        .funnel-bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 15%;
            height: 100%;
            justify-content: flex-end;
        }
        .funnel-bar {
            width: 80%;
            border-radius: 5px 5px 0 0;
            transition: height 0.5s ease-out;
            position: relative;
            display: flex;
            justify-content: center;
        }
        .funnel-bar-label {
            position: absolute;
            top: -25px;
            font-weight: bold;
            color: var(--secondary-color);
        }
        .funnel-stage-name {
            margin-top: 10px;
            font-size: 0.9rem;
            text-align: center;
        }

        /* ===== NOVOS ESTILOS PARA DIFERENCIAIS ===== */
        .amenities-container {
             background-color: #f8f9fa;
             padding: 1rem;
             border-radius: 5px;
        }
        .amenities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 1rem; /* Espaço para o campo de adicionar */
        }
        .amenity-item {
            display: flex;
            align-items: center;
        }
        .amenity-item input[type="checkbox"] {
            margin-right: 10px;
        }
        .amenity-item label {
            font-weight: normal;
            font-size: 0.9rem;
        }
        .add-amenity-toolbar {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
            border-top: 1px solid #ddd;
            padding-top: 1rem;
        }
         .add-amenity-toolbar input, .add-amenity-toolbar textarea { flex-grow: 1; }
         .add-amenity-toolbar button { flex-shrink: 0; }

        .amenities-display-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .amenity-display-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            font-size: 0.95rem;
        }
        .amenity-display-item i {
            color: var(--primary-color);
            width: 20px;
            text-align: center;
        }

        /* Estilos para campos de formulário ocultáveis */
        .hidden-field {
            display: none;
        }
        
        /* ===== NOVOS ESTILOS PARA RELATÓRIO DE PLANTÃO ===== */
        .attended-client-item {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr auto;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            background-color: #fdfdfd;
        }
        .attended-client-item .form-group {
            margin-bottom: 0;
        }
        .attended-client-item .form-group label {
            display: none; /* O placeholder já informa */
        }
        .attended-client-item button {
            align-self: center; /* Centraliza o botão verticalmente */
            margin-top: 0; /* Remove margem superior se houver */
        }
        #attended-clients-list {
            margin-bottom: 1rem;
        }
        .pdf-duty-report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8mm;
        }
        .pdf-duty-report-table th, .pdf-duty-report-table td {
            border: 1px solid #ddd;
            padding: 3mm;
            text-align: left;
            font-size: 10pt;
        }
        .pdf-duty-report-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        /* ===== NOVOS ESTILOS PARA Informes e Notas ===== */
        .info-card {
            background-color: var(--surface-color);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        .info-card-header {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }
        .info-card-thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
            flex-shrink: 0;
        }
        .info-card-title-section h3 {
            color: var(--secondary-color);
            margin-bottom: 0.8rem;
        }
        .info-card-content {
            flex-grow: 1;
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-color);
            margin-top: 1rem;
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
        }
        .info-card-footer {
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        .info-card-footer button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--secondary-color);
        }
        .info-card-footer button:hover {
            color: var(--primary-color);
        }
        .view-note-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 1rem;
        }
        .view-note-gallery img {
            width: 100%;
            height: auto;
            border-radius: 5px;
            object-fit: cover;
            cursor: pointer;
        }

        /* ===== NOVOS ESTILOS PARA DASHBOARD E CLIENTES ===== */
        .dashboard-card ul { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; }
        .dashboard-card li { margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px solid #eee; }
        .dashboard-card li:last-child { border-bottom: none; }
        .dashboard-event-item, .financial-alert-item { cursor: pointer; transition: color 0.2s; }
        .dashboard-event-item:hover, .financial-alert-item:hover { color: var(--primary-color); }
        .financial-alert-item.overdue { color: var(--danger-color); font-weight: bold; }
        .financial-alert-item .alert-details { font-size: 0.8rem; opacity: 0.8; display: block; }
        .status-realizado { font-weight: bold; color: var(--success-color); font-size: 0.8em; }
        #quick-actions-toast {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            background-color: var(--secondary-color); color: white;
            padding: 10px 20px; border-radius: 5px;
            z-index: 9999; display: none;
            animation: fadeInOut 3s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; } 5% { opacity: 1; }
            95% { opacity: 1; } 100% { opacity: 0; }
        }
        .payment-status-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #eee;
        }

        /* ===== INÍCIO: ESTILOS DE IMPRESSÃO E QR CODE ===== */
        .qr-code-for-print {
            display: none; /* Oculto por padrão na tela */
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .printable-document {
                font-family: 'Roboto', sans-serif;
                font-size: 11pt;
                line-height: 1.5;
                padding: 15mm;
                color: #000;
            }
            .printable-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                border-bottom: 2px solid #D4AF37;
                padding-bottom: 8mm;
                margin-bottom: 10mm;
            }
            .printable-header-logo {
                max-width: 50mm;
                max-height: 25mm;
                object-fit: contain;
            }
            .printable-header-info h1 {
                font-family: 'Montserrat', sans-serif;
                font-size: 14pt;
                color: #2C3E50;
                margin: 0 0 5px 0;
            }
            .printable-header-info p {
                margin: 0;
                font-size: 9pt;
            }
            .printable-document h1, .printable-document h2, .printable-document h3 {
                font-family: 'Montserrat', sans-serif;
                color: #2C3E50;
                margin-top: 8mm;
                margin-bottom: 5mm;
                padding-bottom: 2mm;
                border-bottom: 1px solid #eee;
                page-break-after: avoid;
            }
            .printable-document .record-details {
                border: none;
                box-shadow: none;
                padding: 0;
            }
            .printable-document .record-details .main-image {
                max-width: 80%;
                display: block;
                margin-left: auto;
                margin-right: auto;
            }
            .printable-document .toolbar, .printable-document .modal-footer {
                display: none !important;
            }
            .printable-document .analysis-result {
                background-color: #f8f9fa !important;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
            .printable-document .report-grid {
                display: flex;
                justify-content: space-around;
            }
            .printable-document .report-card {
                border: 1px solid #ccc;
            }
            .printable-document a {
                text-decoration: none;
                color: #000;
            }
            
            /* REGRAS DO QR CODE PARA IMPRESSÃO */
            .link-for-screen {
                display: none; /* Oculta o link de texto na impressão */
            }
            .qr-code-for-print {
                display: block !important; /* Exibe a seção do QR code na impressão */
                margin-top: 15px;
                page-break-inside: avoid;
            }
            #property-qr-code-container img { /* O QR Code é gerado como uma imagem */
                display: block !important;
                visibility: visible !important;
                margin: 5px 0 0 0;
            }
            /* Remove a regra genérica de '::after' para links dentro da área de impressão */
            .printable-document a::after {
                content: ""; 
            }
        }
        /* ===== FIM: ESTILOS DE IMPRESSÃO ===== */
/* ===== INÍCIO: ESTILOS DO PAINEL FINANCEIRO (ProspectoPro4) ===== */
        .financial-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            padding-top: 15px;
            margin-bottom: 2rem;
        }
        .financial-metric {
            text-align: center;
            padding: 20px;
            background-color: var(--surface-color); /* Adaptado para o MeuCRM6 */
            border-radius: 8px;
            border-bottom: 4px solid var(--primary-color); /* Adaptado para o MeuCRM6 */
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .financial-metric h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 10px;
            opacity: 0.9;
        }
        .financial-metric .financial-amount {
            font-size: 2rem; /* Aumentado para 2rem */
            font-weight: 700;
            font-family: 'Roboto', 'Courier New', monospace;
            margin-bottom: 8px;
        }
        /* Cores adaptadas para as variáveis do MeuCRM6 */
        .financial-metric .financial-amount.success { color: var(--success-color); }
        .financial-metric .financial-amount.danger { color: var(--danger-color); }
        .financial-metric .financial-amount.info { color: var(--secondary-color); }
        /* ===== FIM: ESTILOS DO PAINEL FINANCEIRO (ProspectoPro4) ===== */

    </style>
</head>
<body>

    <header>
        <div class="logo-container">
            <img id="header-logo" src="https://via.placeholder.com/150x50.png?text=Sua+Logo" alt="Logo">
            <div class="broker-info">
                <h1 id="header-broker-name">Nome do Corretor</h1>
                <p id="header-broker-creci">CRECI: 00000</p>
            </div>
        </div>
        <nav>
            <button class="nav-btn active" data-panel="dashboard"><i class="fas fa-tachometer-alt"></i></button>
            <button class="nav-btn" data-panel="clients"><i class="fas fa-users"></i> Clientes</button>
            <button class="nav-btn" data-panel="properties"><i class="fas fa-building"></i> Imóveis</button>
            <button class="nav-btn" data-panel="agenda"><i class="fas fa-calendar-alt"></i> Agenda</button>
            <button class="nav-btn" data-panel="duty-reports"><i class="fas fa-clipboard-list"></i> Plantões</button>
            <button class="nav-btn" data-panel="informacoes"><i class="fas fa-book-open"></i> Notas</button>
            <button class="nav-btn" data-panel="documents"><i class="fas fa-file-contract"></i> Docs</button>
            <button class="nav-btn" data-panel="financial"><i class="fas fa-chart-line"></i> Fin</button>
            <button class="nav-btn" data-panel="links"><i class="fas fa-link"></i> </button>
            <button class="nav-btn" data-panel="settings"><i class="fas fa-cog"></i> </button>
            <a href="https://alexpeixoto85.github.io/relat-riopro/" target="_blank" class="nav-btn">
    <i class="fas fa-file-alt"></i>
</a>
        </nav>
        <div class="header-tools">
    <a href="https://alexpeixoto85.github.io/finan-aspropessoal/" target="_blank" class="calculator-link" title="Acessar Sistema Financeiro">
        <i class="fas fa-dollar-sign"></i>
    </a>
    <a href="https://alexpeixoto85.github.io/planoprofinal/" target="_blank" class="calculator-link" title="Calculadora Financeira">
        <i class="fas fa-calculator"></i>
    </a>
</div>
    </header>

    <main>
        <div id="panel-dashboard" class="panel active">
            <h2>Dashboard</h2>
            <div id="dashboard-content" class="dashboard-grid"></div>
            <div id="funnel-chart-container">
                 <h3>Funil</h3>
                 <div id="funnel-chart"></div>
            </div>
        </div>

        <div id="panel-clients" class="panel">
            <h2>Gestão de Clientes</h2>
            <div class="toolbar">
                <input type="text" id="client-search" placeholder="Buscar por nome, contato ou CPF...">
                <select id="client-source-filter" style="flex-grow: 0; min-width: 180px;">
                    <option value="all">Todas as Origens</option>
                    <option value="imobiliária">Imobiliária</option>
                    <option value="plantão">Plantão</option>
                    <option value="construtora">Construtora</option>
                    <option value="patrocinado">Patrocinado</option>
                    <option value="ação de rua">Ação de Rua</option>
                    <option value="indicação">Indicação</option>
                </select>
                <button id="add-client-btn" class="btn-primary"><i class="fas fa-plus"></i> Novo Cliente</button>
                <button id="mass-whatsapp-btn" class="btn-secondary"><i class="fab fa-whatsapp"></i> Envio em Massa</button>
                <button id="export-clients-excel" class="btn-success"><i class="fas fa-file-excel"></i> Exportar Vista Atual</button>
            </div>
            <div id="funnel-filter-buttons" class="funnel-filters"></div>
            <div class="table-container">
                <table id="clients-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-clients"></th>
                            <th>Nome</th>
                            <th>Contato</th>
                            <th>Etapa do Funil</th>
                            <th>Imóvel / Variação</th>
                            <th>Compat.</th>
                            <th>Comissão</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="panel-properties" class="panel">
            <h2>Gestão de Imóveis (Empreendimentos)</h2>
            <div class="toolbar">
                <input type="text" id="property-search" placeholder="Buscar por nome ou localização...">
                <button id="add-property-btn" class="btn-primary"><i class="fas fa-plus"></i> Novo Imóvel</button>
                <button id="generate-portfolio-btn" class="btn-secondary"><i class="fas fa-book-open"></i> Gerar Portfólio</button>
                <button id="export-properties-excel" class="btn-success"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
            </div>
            <div class="table-container">
                <table id="properties-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-properties"></th>
                            <th>Nome do Empreendimento</th>
                            <th>Localização</th>
                            <th>Variações (Unidades)</th>
                            <th>Valor (a partir de)</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="panel-agenda" class="panel">
            <div class="toolbar">
                 <h2>Agenda de Compromissos</h2>
                 <button id="add-event-btn" class="btn-primary" style="margin-left: auto;"><i class="fas fa-plus"></i> Novo Compromisso</button>
            </div>
            <div id="calendar-container">
                <div id="calendar-header">
                    <button id="prev-month-btn"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="month-year"></h3>
                    <button id="next-month-btn"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="weekdays"></div>
                <div id="calendar-grid"></div>
            </div>
        </div>

        <div id="panel-duty-reports" class="panel">
            <h2>Relatórios de Plantão</h2>
            <div class="toolbar">
                <button id="add-duty-report-btn" class="btn-primary"><i class="fas fa-plus"></i> Novo Relatório de Plantão</button>
            </div>
            <div class="table-container">
                <table id="duty-reports-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Local</th>
                            <th>Clientes Atendidos</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="panel-informacoes" class="panel">
            <h2>Informes e Notas</h2>
            <div class="toolbar">
                <input type="text" id="info-search" placeholder="Buscar por título ou conteúdo...">
                <button id="add-info-btn" class="btn-primary"><i class="fas fa-plus"></i> Nova Informação</button>
            </div>
            <div id="info-cards-container" class="dashboard-grid">
                </div>
        </div>

        <div id="panel-documents" class="panel">
            <h2>Gestão de Documentos</h2>
            <div class="toolbar">
                <button id="add-contract-btn" class="btn-primary"><i class="fas fa-plus"></i> Gerar Contrato</button>
                <button id="add-receipt-btn" class="btn-success"><i class="fas fa-receipt"></i> Gerar Recibo</button>
            </div>
            <div class="table-container">
                <table id="documents-table">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Cliente(s)</th>
                            <th>Imóvel</th>
                            <th>Valor</th>
                            <th>Data</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="panel-financial" class="panel">
            <div class="financial-panel-header">
                <h2>Financeiro e Business Intelligence</h2>
                <div class="header-buttons">
                    <button id="generate-financial-report-btn" class="btn-secondary"><i class="fas fa-file-invoice-dollar"></i> Gerar Relatório</button>
                    <button id="add-income-btn" class="btn-success"><i class="fas fa-plus"></i> Nova Receita</button>
                    <button id="add-expense-btn" class="btn-danger"><i class="fas fa-minus"></i> Nova Despesa</button>
                </div>
            </div>
            <div class="financial-dashboard" id="financial-bi-content">

    <div class="financial-metric">
        <h4>Receita Realizada (Recebida)</h4>
        <p id="bi-realized-revenue" class="financial-amount success">R$ 0,00</p>
    </div>

    <div class="financial-metric">
        <h4>Despesa Realizada (Paga)</h4>
        <p id="bi-realized-expense" class="financial-amount danger">R$ 0,00</p>
    </div>

    <div class="financial-metric">
        <h4>Saldo Atual</h4>
        <p id="bi-balance" class="financial-amount info">R$ 0,00</p>
    </div>

    <div class="financial-metric" id="card-pending-payments" style="cursor: pointer;" title="Ver todos os lançamentos pendentes">
    <h4>A Vencer (Próx. 30 dias)</h4>
    <p id="bi-future-revenue" class="financial-amount success" style="font-size: 1.2rem; margin-bottom: 0;">R$ 0,00</p>
    <p id="bi-future-expense" class="financial-amount danger" style="font-size: 1.2rem; margin-top: 5px;">R$ 0,00</p>
</div>

</div>
            <h3>Lançamentos Financeiros</h3>
<div class="toolbar">
    <input type="text" id="financial-search" placeholder="Buscar por descrição ou categoria...">
</div>
            <div class="table-container">
                <table id="financial-records-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descrição</th>
                            <th>Categoria</th>
                            <th>Tipo</th>
                            <th>Valor</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="panel-links" class="panel">
            <h2></h2>
            <div class="toolbar">
                <button id="add-link-btn" class="btn-primary"><i class="fas fa-plus"></i> Novo Link</button>
            </div>
            <div class="table-container">
                <table id="links-table">
                    <thead>
                        <tr>
                            <th>Título</th>
                            <th>URL</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="panel-settings" class="panel">
            <h2></h2>
            <div class="settings-grid">
                <div class="settings-card">
                    <h3>Dados do Corretor</h3>
                    <input type="text" id="setting-broker-name" placeholder="Seu Nome Completo">
                    <input type="text" id="setting-broker-creci" placeholder="Seu CRECI">
                    <input type="text" id="setting-broker-phone" placeholder="Seu Telefone (com 55 e DDD)">
                    <label for="setting-logo-upload">Logo Marca:</label>
                    <input type="file" id="setting-logo-upload" accept="image/*">
                    <button id="save-broker-info" class="btn-primary">Salvar Dados</button>
                </div>
                <div class="settings-card">
                    <h3>Metas e Padrões</h3>
                    <label>Meta Mensal de Leads:</label>
                    <input type="number" id="setting-leads-goal" placeholder="Ex: 50">
                    <label>Meta de Faturamento Mensal (R$):</label>
                    <input type="number" id="setting-revenue-goal" placeholder="Ex: 50000">
                    <label>Comissão Padrão (%):</label>
                    <input type="number" id="setting-default-commission" placeholder="Ex: 5">
                     <button id="save-goals" class="btn-primary">Salvar Metas</button>
                </div>
                <div class="settings-card">
                    <h3>Gestão do Funil de Vendas (Arraste para reordenar)</h3>
                    <div id="funnel-editor"></div>
                    <div class="toolbar">
                        <input type="text" id="new-stage-name" placeholder="Nome da etapa">
                        <input type="number" id="new-stage-prob" placeholder="Prob. de Venda (%)">
                    </div>
                    <button id="add-stage-btn" class="btn-secondary">Adicionar Etapa</button>
                </div>
                 <div class="settings-card">
                    <h3>Gestão de Diferenciais</h3>
                    <div id="amenities-list" style="max-height: 250px; overflow-y: auto; margin-bottom: 1rem;"></div>
                    </div>
                <div class="settings-card">
                    <h3>Gerenciamento de Dados</h3>
                    <label>Importar Planilha (Clientes ou Imóveis):</label>
                    <div class="toolbar">
                        <input type="file" id="import-excel" accept=".xlsx">
                        <select id="import-type">
                            <option value="clients">Clientes</option>
                            <option value="properties">Imóveis</option>
                        </select>
                    </div>
                     <button id="import-btn" class="btn-secondary">Importar Planilha</button>
                    <button id="download-template-btn" class="btn-link">Baixar Modelo de Planilha</button>
                    <hr>
                    <button id="export-backup-btn" class="btn-secondary">Exportar Backup Completo (JSON)</button>
                    <button id="export-properties-btn" class="btn-secondary" style="background-color: #27ae60; border-color: #27ae60;">Exportar APENAS Imóveis (JSON)</button>
                    <label>Importar Backup (JSON):</label>
                    <input type="file" id="import-backup" accept=".json">
                    <button id="import-backup-btn" class="btn-secondary">Importar Backup</button>
                    <hr>
<label>Importar APENAS Imóveis (JSON):</label>
<input type="file" id="import-properties" accept=".json">
<button id="import-properties-btn" class="btn-secondary" style="background-color: #27ae60; border-color: #27ae60;">Importar Imóveis</button>
                    <hr>
                    <button id="delete-duplicates-btn" class="btn-danger">Excluir Clientes Duplicados</button>
                    <button id="clear-system-btn" class="btn-danger">Limpar Todo o Sistema</button>
                </div>
            </div>
        </div>
    </main>
    
    <div id="modal-container" class="modal-container">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            </div>
            <div id="modal-body"></div>
            <div class="modal-footer">
                <button id="modal-cancel-btn" class="btn-secondary">Cancelar</button>
                <button id="modal-save-btn" class="btn-primary">Salvar</button>
            </div>
        </div>
    </div>

    <div id="alert-modal-container" class="alert-modal-container">
        <div class="alert-modal-content">
            <div class="alert-modal-header">
                <h2 id="alert-modal-title"></h2>
                <button id="alert-modal-close-btn" class="alert-modal-close-btn">&times;</button>
            </div>
            <div id="alert-modal-body" class="alert-modal-body"></div>
        </div>
    </div>
    
    <div id="pdf-generator"></div>

    <div id="print-area" class="print-area"></div>

    <div id="quick-actions-toast"></div>
    
    <div id="image-gallery-modal">
        <div id="gallery-image-container">
            <img id="gallery-current-image" src="" alt="Imagem do Imóvel">
            <button id="gallery-prev" class="gallery-nav"><i class="fas fa-chevron-left"></i></button>
            <button id="gallery-next" class="gallery-nav"><i class="fas fa-chevron-right"></i></button>
            <button id="gallery-close" class="gallery-tool" title="Fechar"><i class="fas fa-times"></i></button>
            <button id="gallery-fullscreen" class="gallery-tool" title="Tela Cheia"><i class="fas fa-expand"></i></button>
            <div id="gallery-counter"></div>
        </div>
    </div>

    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
    // =================================================================================
    // SCRIPT COMPLETO DO SISTEMA CRM (ARQUIVO ÚNICO)
    // =================================================================================
    document.addEventListener('DOMContentLoaded', () => {
	// =================================================================================
// BANCO DE MENSAGENS E EMOJIS PARA WHATSAPP
// =================================================================================
const messageTemplates = [
    "Olá, [nome]! Tenho ótimas novidades sobre imóveis que podem te interessar. Quando podemos conversar?",
    "Oi, [nome], tudo bem? Passando para saber se ainda está buscando o imóvel dos seus sonhos. Tenho algumas opções excelentes!",
    "Que tal encontrar seu novo lar, [nome]? Tenho umas oportunidades imperdíveis que acabaram de chegar para mim.",
    "Olá, [nome]! Como vai a busca pelo imóvel ideal? Gostaria de te apresentar algumas novidades que combinam com seu perfil.",
    "Oi, [nome]! Pensando em você, separei alguns imóveis incríveis. Acredito que um deles seja a sua cara!"
];

const emojis = [
    "🏡", "🏢", "🔑", "🏠", "🏘️", "🏙️", "✨", "⭐", "🚀"
];

// Função auxiliar para criar uma pausa (delay)
const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));
// =================================================================================

        // ==========================================
        // BANCO DE DADOS (INDEXEDDB COM DEXIE.JS)
        // ==========================================
        const dexieDb = new Dexie('CRMLuxoDatabase');
        dexieDb.version(1).stores({
            dataStore: 'id' // 'id' será a chave primária (usaremos um ID fixo: 1)
        });
    
        // ==========================================
        // ELEMENTOS DO DOM
        // ==========================================
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalFooter = document.querySelector('.modal-footer');

        const alertModalContainer = document.getElementById('alert-modal-container');
        const alertModalTitle = document.getElementById('alert-modal-title');
        const alertModalBody = document.getElementById('alert-modal-body');

        let currentEditingId = null; 
        let currentEntityType = ''; 
        let tempPropertyImages = [];
        let tempMainImageIndex = -1;
        let tempNoteImages = []; 
        let currentCalendarDate = new Date();
        let currentPaymentDateToConfirm = null;
        let financialFilterState = 'all'; // 'all', 'upcoming'
        
        // ==========================================
        // INÍCIO: NOVAS VARIÁVEIS DE ESTADO
        // ==========================================
        // Armazena as variações do imóvel *enquanto* o modal está aberto
        let tempPropertyVariations = []; 
        // ==========================================
        // FIM: NOVAS VARIÁVEIS DE ESTADO
        // ==========================================
    
        // ==========================================
        // ESTADO INICIAL E MANIPULAÇÃO DE DADOS
        // ==========================================
        let db = {};
    
        const defaultDb = {
            settings: {
                brokerName: 'Nome do Corretor',
                brokerCreci: 'CRECI: 00000',
                brokerPhone: '5582999998888',
                logoUrl: 'https://via.placeholder.com/150x50.png?text=Sua+Logo',
                goals: { leads: 50, revenue: 50000, },
                defaultCommission: 5,
            },
            funnelStages: [
                { id: 1, name: 'Lead', probability: 5 },
                { id: 2, name: 'Contato Realizado', probability: 20 },
                { id: 3, name: 'Visita Agendada', probability: 50 },
                { id: 4, name: 'Proposta Enviada', probability: 75 },
                { id: 5, name: 'Venda', probability: 100 },
            ],
            amenities: [
                { name: 'Piscina Adulto', icon: 'fas fa-swimmer' },
                { name: 'Piscina Infantil', icon: 'fas fa-child' },
                { name: 'Piscina com Raia', icon: 'fas fa-water' },
                { name: 'Piscina', icon: 'fas fa-swimming-pool' },
                { name: 'Playground', icon: 'fas fa-puzzle-piece' },
                { name: 'Salão de Festas', icon: 'fas fa-birthday-cake' },
                { name: 'Espaço Gourmet', icon: 'fas fa-utensils' },
                { name: 'Espaço Kids', icon: 'fas fa-shapes' },
                { name: 'Pet Place', icon: 'fas fa-paw' },
                { name: 'Bicicletário', icon: 'fas fa-bicycle' },
                { name: 'Academia', icon: 'fas fa-dumbbell' },
                { name: 'CFTV', icon: 'fas fa-video' },
                { name: 'Varanda Gourmet', icon: 'fas fa-cloud-meatball' },
                { name: 'Wi-fi nas áreas de lazer', icon: 'fas fa-wifi' }
            ],
            clients: [],
            properties: [], // Agora um 'property' é um 'Empreendimento'
            events: [],
            usefulLinks: [],
            contracts: [],
            financialRecords: [],
            performanceSnapshots: [],
            dutyReports: [],
            knowledgeBase: [],
        };
    
        const saveData = async () => {
            try {
                await dexieDb.dataStore.put({ id: 1, data: db });
            } catch (error)
                {
                console.error("Falha ao salvar os dados no IndexedDB:", error);
                alert("Ocorreu um erro crítico ao tentar salvar os dados. Suas alterações recentes podem não ter sido salvas.");
            }
        };
const generatePaymentsArray = (record) => {
    // ======================= INÍCIO DA ADIÇÃO =======================
    // 1. Lemos o status temporário que foi salvo no Passo 2.
    // Se ele não existir (por ex, em uma migração de dados antigos),
    // o padrão continua sendo 'pending'.
    const initialStatus = record._tempNewStatus || 'pending';
    // ======================== FIM DA ADIÇÃO =========================

    const payments = [];
    const startDate = new Date(record.startDate + 'T00:00:00');
    const installments = record.recurrence === 'monthly' ? 1200 : (record.totalInstallments || 1); 

    for (let i = 0; i < installments; i++) {
        const paymentDate = new Date(startDate);
        paymentDate.setMonth(startDate.getMonth() + i);
        payments.push({
            date: paymentDate.toISOString().slice(0, 10),
            // ======================= MUDANÇA =========================
            status: initialStatus // <-- 2. Usamos o status que lemos (paid ou pending)
            // =========================================================
        });
    }

    // ======================= INÍCIO DA ADIÇÃO =======================
    // 3. Limpamos a propriedade temporária para que ela não seja
    // salva acidentalmente no banco de dados.
    delete record._tempNewStatus;
    // ======================== FIM DA ADIÇÃO =========================

    return payments;
};

        const loadData = async () => {
            const oldData = localStorage.getItem('crmImobiliarioData');
            if (oldData) {
                 // ... (código de migração do localStorage, sem alterações) ...
            } else {
                const storedData = await dexieDb.dataStore.get(1);
                if (storedData) {
                    console.log("Dados carregados do IndexedDB.");
                    db = { ...defaultDb, ...storedData.data };
                } else {
                    console.log("Nenhum dado encontrado. Inicializando com o padrão.");
                    db = JSON.parse(JSON.stringify(defaultDb));
                    await saveData();
                }
            }

            if (!db.financialRecords) db.financialRecords = [];
            if (!db.performanceSnapshots) db.performanceSnapshots = [];
            if (!db.amenities) db.amenities = defaultDb.amenities;
            if (!db.dutyReports) db.dutyReports = [];
            if (!db.knowledgeBase) db.knowledgeBase = [];
            
            db.knowledgeBase.forEach(note => {
                if (note.images === undefined) note.images = [];
                if (note.videos === undefined) note.videos = [];
            });
            db.clients.forEach(c => { if (c.lastContact === undefined) c.lastContact = null; });

            let needsSave = false;
            
            // =========================================================
            // INÍCIO: MIGRAÇÃO PARA ESTRUTURA DE VARIAÇÕES
            // =========================================================
            let needsMigration = false;
            db.properties.forEach(prop => {
                if (prop.variations === undefined) { // Se não tiver a chave 'variations', precisa migrar
                    needsMigration = true;
                    console.log(`Migrando imóvel: ${prop.name}`);
                    
                    // 1. Cria o array de variações
                    prop.variations = [];
                    
                    // 2. Se o imóvel antigo tinha um preço, cria uma "Variação Padrão" com esses dados
                    if (prop.listPrice || prop.evalPrice) {
                        prop.variations.push({
                            id: Date.now() + Math.random(),
                            name: 'Unidade Padrão (Migrada)',
                            listPrice: prop.listPrice || 0,
                            evalPrice: prop.evalPrice || 0,
                            discount: 0,
                            sinal: prop.sinal || 0,
                            deliveryDate: prop.deliveryDate || '',
                            areaPrivativa: prop.areaPrivativa || 0,
                            parcelasEntrada: prop.parcelasEntrada || '',
                            parcelasSemestrais: prop.parcelasSemestrais || '',
                            devFinancing: prop.devFinancing || '',
                            condoFee: prop.condoFee || 0,
                            // Adiciona os novos campos vazios
                            entradaParcelas: '',
                            entradaValor: '',
                            intercaladasParcelas: '',
                            intercaladaValor: '',
                            chaves: ''
                        });
                    }
                    
                    // 3. Remove os campos antigos do objeto principal
                    delete prop.listPrice;
                    delete prop.evalPrice;
                    delete prop.sinal;
                    delete prop.deliveryDate;
                    delete prop.areaPrivativa;
                    delete prop.parcelasEntrada;
                    delete prop.parcelasSemestrais;
                    delete prop.devFinancing;
                    delete prop.condoFee;
                    delete prop.otherInfo; // 'otherInfo' também era específico
                }
            });
            
            if (needsMigration) {
                console.log("Salvando dados após migração para 'Variações'.");
                needsSave = true; // Garante que será salvo
            }
            // =========================================================
            // FIM: MIGRAÇÃO PARA ESTRUTURA DE VARIAÇÕES
            // =========================================================


            db.financialRecords.forEach(record => {
                if (!record.payments) {
                    console.log(`Migrando lançamento financeiro antigo: ${record.description}`);
                    record.payments = generatePaymentsArray(record);
                    needsSave = true;
                }
            });
            
            if (needsSave) {
                console.log("Salvando dados após migrações.");
                await saveData();
            }
        };
    
        // ==========================================
        // FUNÇÕES UTILITÁRIAS
        // ==========================================
        const formatCurrency = (value) => Number(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatDate = (dateString) => dateString ? new Date(dateString + 'T00:00:00').toLocaleDateString('pt-BR') : ''; // Correção de fuso
        const getAgeInMonths = (birthdateString) => {
            if (!birthdateString) return null;
            const birthDate = new Date(birthdateString + 'T00:00:00'); // Correção de fuso
            const today = new Date();
            if (isNaN(birthDate.getTime())) return null;
            return (today.getFullYear() - birthDate.getFullYear()) * 12 + (today.getMonth() - birthDate.getMonth());
        };
       
        const numberToWords = (n) => {
            if (n === null || n === undefined) return '';
            let num = n.toFixed(2).toString().split('.');
            let inteiros = parseInt(num[0]);
            let centavos = parseInt(num[1]);

            const a = ['','um','dois','três','quatro','cinco','seis','sete','oito','nove','dez','onze','doze','treze','catorze','quinze','dezesseis','dezessete','dezoito','dezenove'];
            const b = ['','','vinte','trinta','quarenta','cinquenta','sessenta','setenta','oitenta','noventa'];
            const c = ['','cem','duzentos','trezentos','quatrocentos','quinhentos','seiscentos','setecentos','oitocentos','novecentos'];
            
            const extenso = (number) => {
                if (isNaN(number) || number === 0) return '';
                if (number < 20) return a[number];
                if (number < 100) return b[Math.floor(number/10)] + (number % 10 !== 0 ? ' e ' + a[number % 10] : '');
                if (number < 1000) {
                    if (number === 100) return 'cem';
                    return c[Math.floor(number/100)] + (number % 100 !== 0 ? ' e ' + extenso(number % 100) : '');
                }
                if (number < 1000000) {
                    const mil = Math.floor(number / 1000);
                    return (mil === 1 ? 'mil' : extenso(mil) + ' mil') + (number % 1000 !== 0 ? ' ' + extenso(number % 1000) : '');
                }
                return 'valor muito alto'; // Limitação simples
            };

            let strInteiros = extenso(inteiros);
            let strCentavos = extenso(centavos);

            let resultado = '';
            if (inteiros > 0) {
                resultado += strInteiros + (inteiros === 1 ? ' real' : ' reais');
            }
            if (centavos > 0) {
                if (inteiros > 0) resultado += ' e ';
                resultado += strCentavos + (centavos === 1 ? ' centavo' : ' centavos');
            }
            if (resultado === '') return 'zero reais';

            return resultado.charAt(0).toUpperCase() + resultado.slice(1);
        };
// ==========================================
// NOVA FUNÇÃO: VERIFICAR CLIENTES ESTAGNADOS
// ==========================================
const getStaleClientsForArchiving = () => {
    const staleClients = [];
    // Pega o ID da primeira etapa do funil (Ex: 'Lead') para não sugerir arquivamento de leads novos
    const firstStageId = db.funnelStages[0]?.id; 

    db.clients.forEach(client => {
        // 1. Verifica se o cliente tem um histórico E se tem 3 ou mais contatos
        if (client.contactHistory && client.contactHistory.length >= 3) {

            // 2. Pega os dois últimos contatos registrados
            const lastContact = client.contactHistory[client.contactHistory.length - 1];
            const secondLastContact = client.contactHistory[client.contactHistory.length - 2];

            // 3. Verifica se a etapa do funil é a MESMA entre os dois últimos contatos
            //    E também impede que clientes na primeira etapa sejam arquivados
            if (lastContact.stageId === secondLastContact.stageId && client.stageId !== firstStageId) {
                staleClients.push(client);
            }
        }
    });
    return staleClients;
};


        // ==========================================
        // NAVEGAÇÃO E RENDERIZAÇÃO GERAL
        // ==========================================
        const navButtons = document.querySelectorAll('.nav-btn');
        const panels = document.querySelectorAll('.panel');
    
        const switchPanel = (panelId) => {
            panels.forEach(p => p.classList.remove('active'));
            document.getElementById(`panel-${panelId}`)?.classList.add('active');
            navButtons.forEach(b => b.classList.remove('active'));
            document.querySelector(`.nav-btn[data-panel="${panelId}"]`)?.classList.add('active');
            
            switch(panelId) {
                case 'dashboard': renderDashboard(); break;
                case 'clients': renderClientsTable(); renderFunnelFilters(); break;
                case 'properties': renderPropertiesTable(); break;
                case 'agenda': renderAgendaCalendar(); break;
                case 'duty-reports': renderDutyReportsTable(); break;
                case 'informacoes': renderKnowledgeBase(); break;
                case 'documents': renderDocumentsTable(); break;
                case 'financial': renderFinancialBI(); renderFinancialRecordsTable(document.getElementById('financial-search')?.value || ''); break;
                case 'links': renderLinksTable(); break;
                case 'settings': renderSettings(); break;
            }
        };
    
        navButtons.forEach(button => {
if (button.dataset.panel === 'financial') {
    button.addEventListener('click', () => {
        financialFilterState = 'all'; // Reseta o filtro ao clicar no nav
    });
}
            button.addEventListener('click', () => switchPanel(button.dataset.panel));
        });
    
        const updateHeader = () => {
            document.getElementById('header-broker-name').textContent = db.settings.brokerName;
            document.getElementById('header-broker-creci').textContent = db.settings.brokerCreci;
            document.getElementById('header-logo').src = db.settings.logoUrl;
        };
    
        // ==========================================
        // MODAIS (GERAL, ALERTA)
        // ==========================================
        const openModal = (title, bodyHtml, entityType, id = null, showFooter = true) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = bodyHtml;
            currentEditingId = id;
            currentEntityType = entityType;
            modalFooter.style.display = showFooter ? 'flex' : 'none';
            modalContainer.classList.add('active');
            
            // =========================================================
            // INÍCIO: NOVOS OUVINTES DE MODAL
            // =========================================================
            if (entityType === 'property') {
                // Ouvintes de Imagens (como antes)
                document.getElementById('prop-images')?.addEventListener('change', handleImageSelection);
                document.getElementById('prop-image-previews')?.addEventListener('click', handleImagePreviewActions);
                
                // Novos Ouvintes para Variações
                document.getElementById('variation-manager-container')?.addEventListener('click', handleVariationManagerClick);
                
                // Renderiza as variações temporárias (ao editar)
                renderVariationList(); 
            }
            if (entityType === 'client') {
                // Novo Ouvinte para dropdowns dependentes de cliente
                const propSelect = document.getElementById('client-propertyId');
                const variationSelect = document.getElementById('client-variationId');
                
                if (propSelect && variationSelect) {
                    propSelect.addEventListener('change', () => {
                        const propId = propSelect.value;
                        variationSelect.innerHTML = '<option value="">Selecione a variação...</option>';
                        variationSelect.disabled = true;

                        if (propId) {
                            const prop = db.properties.find(p => p.id == propId);
                            if (prop && prop.variations && prop.variations.length > 0) {
                                prop.variations.forEach(v => {
                                    const finalPrice = v.listPrice - (v.discount || 0);
                                    variationSelect.innerHTML += `<option value="${v.id}">${v.name} - ${formatCurrency(finalPrice)}</option>`;
                                });
                                variationSelect.disabled = false;
                            } else {
                                variationSelect.innerHTML = '<option value="">Empreendimento sem variações</option>';
                            }
                        }
                    });
                    
                    // Se estiver editando um cliente, precisamos pré-popular
                    if (currentEditingId) {
                        const client = db.clients.find(c => c.id == currentEditingId);
                        if (client && client.propertyId) {
                            propSelect.value = client.propertyId;
                            // Dispara o evento 'change' para popular o dropdown de variações
                            propSelect.dispatchEvent(new Event('change'));
                            
                            // Precisamos de um pequeno delay para o DOM atualizar antes de setar a variação
                            setTimeout(() => {
                                if (client.variationId) {
                                    variationSelect.value = client.variationId;
                                }
                            }, 50); // 50ms é seguro
                        }
                    }
                }
            }
            // =========================================================
            // FIM: NOVOS OUVINTES DE MODAL
            // =========================================================

            if (entityType === 'knowledgeBase') {
                 document.getElementById('note-images')?.addEventListener('change', handleNoteImageSelection);
                 document.getElementById('note-image-previews')?.addEventListener('click', handleNoteImagePreviewActions);
            }
             if (entityType === 'dutyReport') {
                document.getElementById('add-attended-client-btn')?.addEventListener('click', addAttendedClientRow);
                document.getElementById('attended-clients-list')?.addEventListener('click', handleAttendedClientActions);
            }
            if (entityType === 'financialRecord' && document.getElementById('confirm-payment-btn')) {
                 document.getElementById('confirm-payment-btn').addEventListener('click', confirmPayment);
            }
            if (entityType === 'portfolio') {
                modalSaveBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Gerar Portfólio PDF';
            } else if (entityType === 'contract' || entityType === 'receipt') {
                modalSaveBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Gerar e Salvar';
            }
            else {
                modalSaveBtn.innerHTML = 'Salvar';
            }
        };
    
        const closeModal = () => {
            modalContainer.classList.remove('active');
            modalTitle.textContent = '';
            modalBody.innerHTML = '';
            currentEditingId = null;
            currentEntityType = '';
            tempPropertyImages = [];
            tempMainImageIndex = -1;
            tempNoteImages = [];
            tempPropertyVariations = []; // Limpa as variações temporárias
            currentPaymentDateToConfirm = null;
        };
    
        document.getElementById('modal-close-btn').addEventListener('click', closeModal);
        document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
        
        const openAlertModal = (title, message) => {
            alertModalTitle.textContent = title;
            alertModalBody.innerHTML = message;
            alertModalContainer.classList.add('active');
        };
        const closeAlertModal = () => alertModalContainer.classList.remove('active');
        document.getElementById('alert-modal-close-btn').addEventListener('click', closeAlertModal);

        // ==========================================
        // SISTEMA DE ALERTA DE INICIALIZAÇÃO
        // ==========================================
        const checkStartupAlerts = () => {
            const firstStageId = db.funnelStages[0]?.id;
            const uncontactedLeads = firstStageId ? db.clients.filter(c => c.stageId === firstStageId).length : 0;

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const pendingTasks = db.events.filter(e => {
                if (e.completed || !e.date) return false;
                const eventDate = new Date(e.date + 'T00:00:00');
                return eventDate < today;
            }).length;

            let alertMessage = '';
            if (uncontactedLeads > 0) {
                alertMessage += `<p><i class="fas fa-user-clock"></i> Você tem <strong>${uncontactedLeads} lead(s)</strong> na primeira etapa do funil aguardando contato.</p>`;
            }
            if (pendingTasks > 0) {
                alertMessage += `<p><i class="fas fa-exclamation-triangle"></i> Você tem <strong>${pendingTasks} tarefa(s) pendente(s)</strong> na sua agenda.</p>`;
            }

            if (alertMessage) {
                openAlertModal('Lembretes Importantes', alertMessage);
            }
        };

        // ==========================================
        // GESTÃO DE CLIENTES
        // ==========================================
        const getClientFormHtml = (client = {}) => {
            const funnelOptions = db.funnelStages.map(stage => 
                `<option value="${stage.id}" ${client.stageId == stage.id ? 'selected' : ''}>${stage.name}</option>`
            ).join('');

            // Pega todos os Empreendimentos
            const propertyOptions = db.properties.map(prop => {
                // Adiciona ícone visual no dropdown se for pré-lançamento
                const prefix = prop.status === 'pre-lancamento' ? '⏳ ' : '';
                return `<option value="${prop.id}" ${client.propertyId == prop.id ? 'selected' : ''}>${prefix}${prop.name}</option>`
            }).join('');
            
            const leadSources = ["imobiliária", "plantão", "construtora", "patrocinado", "ação de rua", "indicação"];
            const sourceOptions = leadSources.map(source => 
                `<option value="${source}" ${client.leadSource === source ? 'selected' : ''}>${source.charAt(0).toUpperCase() + source.slice(1)}</option>`
            ).join('');
            
            return `
                <div class="form-grid">
                    <div class="form-group"><label for="client-name">Nome Completo</label><input type="text" id="client-name" value="${client.name || ''}"></div>
                    <div class="form-group"><label for="client-phone">Contato (WhatsApp)</label><input type="text" id="client-phone" value="${client.phone || ''}"></div>
                    <div class="form-group"><label for="client-email">E-mail</label><input type="email" id="client-email" value="${client.email || ''}"></div>
                    <div class="form-group"><label for="client-cpf">CPF</label><input type="text" id="client-cpf" value="${client.cpf || ''}"></div>
                    <div class="form-group"><label for="client-birthdate">Data de Nascimento</label><input type="date" id="client-birthdate" value="${client.birthdate || ''}"></div>
                    <div class="form-group"><label for="client-income">Renda (R$)</label><input type="number" id="client-income" value="${client.income || ''}"></div>

                    <div class="form-group" style="display: flex; align-items: center; justify-content: flex-start; gap: 10px;">
                        <input type="checkbox" id="client-formal-work" ${client.hasFormalWork ? 'checked' : ''} style="width: auto; flex-grow: 0; margin-top: 10px;">
                        <label for="client-formal-work" style="margin-bottom: 0; margin-top: 10px;">Possui 3+ anos de carteira assinada?</label>
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; justify-content: flex-start; gap: 10px;">
                        <input type="checkbox" id="client-has-property" ${client.alreadyOwnsProperty ? 'checked' : ''} style="width: auto; flex-grow: 0; margin-top: 10px;">
                        <label for="client-has-property" style="margin-bottom: 0; margin-top: 10px;">Já possui imóvel no nome?</label>
                    </div>
                    
                    <div class="form-group"><label for="client-commission">Comissão Personalizada (%)</label><input type="number" id="client-commission" placeholder="Padrão: ${db.settings.defaultCommission}%" value="${client.commission || ''}"></div>
                    <div class="form-group"><label for="client-stageId">Etapa do Funil</label><select id="client-stageId">${funnelOptions}</select></div>
                    <div class="form-group"><label for="client-lead-source">Origem do Lead</label><select id="client-lead-source"><option value="">Selecione...</option>${sourceOptions}</select></div>

                    <div class="form-group full-width" style="background-color: #f8f9fa; padding: 1rem; border-radius: 5px;">
                        <label style="font-size: 1.1rem; color: var(--secondary-color); margin-bottom: 1rem; display: block;">Imóvel de Interesse</label>
                        
                        <div style="background-color: #fff3cd; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107; margin-bottom: 15px;">
                            <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-bottom: 0;">
                                <input type="checkbox" id="client-waiting-list" ${client.waitingList ? 'checked' : ''} style="width: auto; flex-grow: 0;">
                                <label for="client-waiting-list" style="margin-bottom: 0; font-weight: bold; color: #856404;">Colocar em Lista de Espera (Pré-lançamento)</label>
                            </div>
                            <small style="display:block; margin-top:5px; color: #856404;">Marque se o imóvel é um Pré-lançamento. Você será avisado quando virar Lançamento.</small>
                        </div>

                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group">
                                <label for="client-propertyId">1. Empreendimento</label>
                                <select id="client-propertyId"><option value="">Selecione...</option>${propertyOptions}</select>
                            </div>
                            <div class="form-group">
                                <label for="client-variationId">2. Variação / Unidade</label>
                                <select id="client-variationId" disabled>
                                    <option value="">Primeiro, selecione um empreendimento</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="client-property-value" value="0">

                    <div class="form-group full-width" style="background-color: #f8f9fa; padding: 1rem; border-radius: 5px; margin-top: 1rem;">
                        <label style="font-size: 1.1rem; color: var(--secondary-color); margin-bottom: 1rem; display: block;">Dados do Cônjuge (Opcional)</label>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group">
                                <label for="spouse-name">Nome do Cônjuge</label>
                                <input type="text" id="spouse-name" value="${client.spouseName || ''}">
                            </div>
                            <div class="form-group">
                                <label for="spouse-cpf">CPF do Cônjuge</label>
                                <input type="text" id="spouse-cpf" value="${client.spouseCpf || ''}">
                            </div>
                            <div class="form-group">
                                <label for="spouse-birthdate">Data de Nasc. Cônjuge</label>
                                <input type="date" id="spouse-birthdate" value="${client.spouseBirthdate || ''}">
                            </div>
                            <div class="form-group">
                                <label for="spouse-income">Renda do Cônjuge (R$)</label>
                                <input type="number" id="spouse-income" value="${client.spouseIncome || ''}">
                            </div>
                            <div class="form-group" style="display: flex; align-items: center; justify-content: flex-start; gap: 10px; grid-column: 1 / -1;">
                                <input type="checkbox" id="client-spouse-composes-income" ${client.spouseComposesIncome ? 'checked' : ''} style="width: auto; flex-grow: 0; margin-top: 10px;">
                                <label for="client-spouse-composes-income" style="margin-bottom: 0; margin-top: 10px;">Cônjuge compõe renda para simulação?</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="client-notes">Observações</label>
                        <textarea id="client-notes" rows="3">${client.notes || ''}</textarea>
                    </div>
                </div>
            `;
        };
    
        document.getElementById('add-client-btn').addEventListener('click', () => {
            openModal('Cadastrar Novo Cliente', getClientFormHtml(), 'client');
        });
    
        const renderClientsTable = (filter = '', stageFilter = null, sourceFilter = null) => {
            const tbody = document.querySelector('#clients-table tbody');
            tbody.innerHTML = '';
            
            let filteredClients = db.clients.filter(c => 
                (c.name || '').toLowerCase().includes(filter.toLowerCase()) || 
                (c.phone || '').includes(filter) || 
                (c.cpf || '').includes(filter)
            );
            
            if (stageFilter) {
                filteredClients = filteredClients.filter(c => c.stageId == stageFilter);
            }

            if (sourceFilter) {
                filteredClients = filteredClients.filter(c => c.leadSource === sourceFilter);
            }
    
            if (filteredClients.length === 0) {
                // =========================================================
                // INÍCIO: MUDANÇA NA TABELA DE CLIENTES (COLSPAN)
                // =========================================================
                tbody.innerHTML = '<tr><td colspan="8">Nenhum cliente encontrado.</td></tr>'; return;
                // =========================================================
                // FIM: MUDANÇA NA TABELA DE CLIENTES
                // =========================================================
            }
    
            filteredClients.forEach(client => {
                const stage = db.funnelStages.find(s => s.id === client.stageId);
                
                // =========================================================
                // INÍCIO: NOVAS LÓGICAS DA TABELA DE CLIENTES
                // =========================================================
                let property = null;
                let variation = null;
                let interestHtml = 'N/A';
                let compatibilityHtml = 'N/A';
                let commissionValue = 0;
                
                if (client.propertyId) {
                    property = db.properties.find(p => p.id == client.propertyId);
                }
                if (property && client.variationId) {
                    variation = property.variations.find(v => v.id == client.variationId);
                }

                if (property && variation) {
                    interestHtml = `${property.name} <br><small>(${variation.name})</small>`;
                    const propertyValue = variation.listPrice - (variation.discount || 0);
                    const commission = client.commission || db.settings.defaultCommission;
                    commissionValue = (propertyValue * commission) / 100;

                    // Calcula a Compatibilidade
                    const analysis = calculateFinancing(client, variation, property);
                    if (analysis.compatibilityScore) {
                         const score = analysis.compatibilityScore.toFixed(0);
                         let color = 'var(--danger-color)';
                         if (score >= 80) color = 'var(--success-color)';
                         else if (score >= 60) color = 'var(--warning-color)';
                         
                         compatibilityHtml = `<strong style="color: ${color}; font-size: 1.1rem;">${score}%</strong>`;
                    } else {
                        compatibilityHtml = `<i class="fas fa-exclamation-triangle" title="${analysis.error}"></i>`;
                    }
                    
                } else if (property) {
                     interestHtml = `${property.name} <br><small>(Variação não definida)</small>`;
                }
                
                // =========================================================
                // FIM: NOVAS LÓGICAS DA TABELA DE CLIENTES
                // =========================================================

                tbody.innerHTML += `
                    <tr>
                        <td><input type="checkbox" class="client-checkbox" data-phone="${client.phone}"></td>
                        <td>${client.name}</td>
                        <td>${client.phone}</td>
                        <td>${stage ? stage.name : 'N/A'}</td>
                        <td>${interestHtml}</td>
                        <td>${compatibilityHtml}</td>
                        <td>${formatCurrency(commissionValue)}</td>
                        <td class="action-buttons">
                            <button title="Visualizar Ficha" data-action="view" data-id="${client.id}"><i class="fas fa-eye"></i></button>
                            <button title="Imprimir Ficha" data-action="print" data-id="${client.id}"><i class="fas fa-print"></i></button>
                            <button title="Análise de Financiamento" data-action="analyze" data-id="${client.id}"><i class="fas fa-search-dollar"></i></button>
                            <a href="https://wa.me/${(client.phone || '').replace(/\D/g, '')}" target="_blank" title="Contatar" data-action="contact" data-id="${client.id}"><i class="fab fa-whatsapp"></i></a>
                            <button title="Editar" data-action="edit" data-id="${client.id}"><i class="fas fa-edit"></i></button>
                            <button title="Excluir" data-action="delete" data-id="${client.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        };
        
        const triggerClientTableRender = () => {
            const searchValue = document.getElementById('client-search').value;
            const stageValue = document.querySelector('.funnel-filter-btn.active')?.dataset.stageId;
            const sourceValue = document.getElementById('client-source-filter').value;
            renderClientsTable(
                searchValue,
                stageValue === 'all' ? null : stageValue,
                sourceValue === 'all' ? null : sourceValue
            );
        };

        document.getElementById('client-search').addEventListener('input', triggerClientTableRender);
        document.getElementById('client-source-filter').addEventListener('change', triggerClientTableRender);
    
        document.querySelector('#clients-table tbody').addEventListener('click', e => {
            const button = e.target.closest('button, a');
            if (!button) return;
            const id = button.dataset.id;
            const action = button.dataset.action;
    
            if (action === 'edit') {
                const client = db.clients.find(c => c.id == id);
                openModal('Editar Cliente', getClientFormHtml(client), 'client', id);
            } else if (action === 'delete') {
                if (confirm(`Deseja realmente excluir o cliente?`)) {
                    db.clients = db.clients.filter(c => c.id != id);
                    saveData();
                    triggerClientTableRender();
                }
            } else if (action === 'print') {
                const client = db.clients.find(c => c.id == id);
                const clientHtml = getClientDetailsHtml(id);
                const title = `Ficha do Cliente: ${client.name}`;
                printContent(clientHtml, title);
            } else if (action === 'analyze') {
                handleFinancingAnalysis(id);
            } else if (action === 'view') {
                 const client = db.clients.find(c => c.id == id);
                 const clientHtml = getClientDetailsHtml(id);
                 const modalBodyHtml = `
                    <div class="record-details" data-client-id="${id}">${clientHtml}</div>
                    <div class="modal-footer" style="display:flex; justify-content: flex-end; margin-top: 1rem;">
                        <button class="btn-primary" id="print-modal-btn"><i class="fas fa-print"></i> Imprimir</button>
                    </div>`;
                 openModal(`Ficha de ${client.name}`, modalBodyHtml, 'view', null, false);
                 document.getElementById('print-modal-btn').addEventListener('click', () => {
                    printContent(clientHtml, `Ficha do Cliente: ${client.name}`);
                 });
            } else if (action === 'contact') {
    const client = db.clients.find(c => c.id == id);
    if (client) {
        // Atualiza a data do último contato (para exibição na tabela)
        client.lastContact = new Date().toISOString().slice(0, 10);

        // INÍCIO DA NOVA LÓGICA: Adiciona ao histórico de contatos
        if (!client.contactHistory) {
            client.contactHistory = []; // Cria o histórico se não existir
        }

        client.contactHistory.push({
            date: client.lastContact,
            stageId: client.stageId // Salva qual era a etapa do funil NESTE contato
        });
        // FIM DA NOVA LÓGICA

        saveData();
        triggerClientTableRender();
    }
}
        });
        
        const renderFunnelFilters = () => {
            const container = document.getElementById('funnel-filter-buttons');
            container.innerHTML = '<button class="funnel-filter-btn active" data-stage-id="all">Todos</button>';
            db.funnelStages.forEach(stage => {
                container.innerHTML += `<button class="funnel-filter-btn" data-stage-id="${stage.id}">${stage.name}</button>`;
            });
        };

        document.getElementById('funnel-filter-buttons').addEventListener('click', e => {
            if(e.target.tagName === 'BUTTON'){
                document.querySelectorAll('.funnel-filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                triggerClientTableRender();
            }
        });

        document.getElementById('mass-whatsapp-btn').addEventListener('click', async () => {
    const selected = document.querySelectorAll('.client-checkbox:checked');
    if (selected.length === 0) {
        alert('Selecione pelo menos um cliente para o envio.');
        return;
    }

    if (!confirm(`Você está prestes a iniciar o envio de mensagens para ${selected.length} cliente(s) com pausas aleatórias entre eles. Deseja continuar?`)) {
        return;
    }

    // O loop 'for...of' nos permite usar 'await' (a pausa) dentro dele.
    for (const checkbox of selected) {
        const phone = (checkbox.dataset.phone || '').replace(/\D/g, '');
        const client = db.clients.find(c => (c.phone || '').replace(/\D/g, '') === phone);

        if (client) {
            const randomMessageIndex = Math.floor(Math.random() * messageTemplates.length);
            const randomEmojiIndex = Math.floor(Math.random() * emojis.length);

            let baseMessage = messageTemplates[randomMessageIndex];
            const emoji = emojis[randomEmojiIndex];

            const personalizedMessage = baseMessage.replace(/\[nome\]/gi, client.name.split(' ')[0]) + ' ' + emoji;

            const url = `https://wa.me/${phone}?text=${encodeURIComponent(personalizedMessage)}`;
            window.open(url, '_blank');

            client.lastContact = new Date().toISOString().slice(0, 10);

            // --- A MÁGICA ACONTECE AQUI ---
            // Define um tempo de espera aleatório entre 3 e 7 segundos
            const delay = 3000 + Math.random() * 4000; // 3000ms base + até 4000ms aleatórios
            console.log(`Aguardando ${Math.round(delay/1000)} segundos antes do próximo envio...`);

            // Executa a pausa
            await sleep(delay);
        }
    }

    // Ao final de todos os envios, salva os dados
    alert(`Envio para ${selected.length} cliente(s) finalizado!`);
    saveData();
    triggerClientTableRender();
});
        
        document.getElementById('select-all-clients').addEventListener('change', e => {
            document.querySelectorAll('.client-checkbox').forEach(cb => cb.checked = e.target.checked);
        });
        
        // ==========================================
        // GESTÃO DE IMÓVEIS (AGORA EMPREENDIMENTOS)
        // ==========================================
        
        // =========================================================
        // INÍCIO: FORMULÁRIO DE IMÓVEL TOTALMENTE REFEITO
        // =========================================================
        

        const renderVariationList = () => {
            const container = document.getElementById('variation-list-container');
            if (!container) return;
            
            container.innerHTML = ''; // Limpa a lista
            
            if (tempPropertyVariations.length === 0) {
                container.innerHTML = '<p style="text-align:center; opacity: 0.7;">Nenhuma variação cadastrada para este empreendimento.</p>';
            }

            tempPropertyVariations.forEach((variation, index) => {
                const finalPrice = variation.listPrice - (variation.discount || 0);
                container.innerHTML += `
                    <div class="variation-item" data-index="${index}">
                        <div class="variation-item-header">
                            <span>${variation.name} (${formatCurrency(finalPrice)})</span>
                            <div class="action-buttons">
                                <button title="Editar Variação" data-action="edit-variation"><i class="fas fa-edit"></i></button>
                                <button title="Excluir Variação" data-action="delete-variation"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="variation-item-body">
                            <p style="font-size: 0.9rem; line-height: 1.5;">
                                <strong>Sinal:</strong> ${formatCurrency(variation.sinal || 0)} | 
                                <strong>Entrada:</strong> ${variation.entradaParcelas || 0}x de ${formatCurrency(variation.entradaValor || 0)} | 
                                <strong>Interc:</strong> ${variation.intercaladasParcelas || 0}x de ${formatCurrency(variation.intercaladaValor || 0)} | 
                                <strong>Chaves:</strong> ${formatCurrency(variation.chaves || 0)}
                            </p>
                        </div>
                    </div>
                `;
            });
        };

        const getPropertyFormHtml = (prop = {}) => {
            // 1. Configura as imagens (como antes)
            tempPropertyImages = prop.images ? [...prop.images] : [];
            tempMainImageIndex = (prop.mainImageIndex !== undefined && prop.mainImageIndex < tempPropertyImages.length) ? prop.mainImageIndex : -1;

            // 2. Configura as variações temporárias
            tempPropertyVariations = prop.variations ? JSON.parse(JSON.stringify(prop.variations)) : [];

            // 3. Checkboxes de diferenciais (como antes)
            const savedAmenities = prop.amenities || [];
            const amenitiesCheckboxes = db.amenities.map(amenity => `
                <div class="amenity-item">
                    <input type="checkbox" id="amenity-${amenity.name.replace(/\s/g, '-')}" name="amenities" value="${amenity.name}" ${savedAmenities.includes(amenity.name) ? 'checked' : ''}>
                    <label for="amenity-${amenity.name.replace(/\s/g, '-')}">${amenity.name}</label>
                </div>
            `).join('');
            
            // 4. Monta o HTML do formulário
            return `
                <div class="form-section-title">Dados do Empreendimento</div>
                <div class="form-grid">
                    <div class="form-group"><label for="prop-name">Nome do Empreendimento</label><input type="text" id="prop-name" value="${prop.name || ''}"></div>
                    
                    <div class="form-group">
                        <label for="prop-status">Status da Obra</label>
                        <select id="prop-status" style="font-weight: bold; color: var(--secondary-color);">
                            <option value="pronto" ${prop.status === 'pronto' ? 'selected' : ''}>Pronto para Morar</option>
                            <option value="lancamento" ${prop.status === 'lancamento' ? 'selected' : ''}>🚀 Lançamento</option>
                            <option value="pre-lancamento" ${prop.status === 'pre-lancamento' ? 'selected' : ''}>⏳ Pré-Lançamento</option>
                        </select>
                    </div>

                    <div class="form-group"><label for="prop-location">Localização</label><input type="text" id="prop-location" value="${prop.location || ''}"></div>
                    <div class="form-group"><label for="prop-link">Link (Tour Virtual, Site)</label><input type="url" id="prop-link" value="${prop.link || ''}"></div>
                    <div class="form-group full-width"><label for="prop-video-link">Link do Vídeo (YouTube, Vimeo)</label>
                    <input type="url" id="prop-video-link" value="${
                        (url => {
                            if (!url) return '';
                            if (url.includes('youtube.com/embed/')) return `https://www.youtube.com/watch?v=${url.split('embed/')[1]}`;
                            if (url.includes('player.vimeo.com/video/')) return `https://vimeo.com/${url.split('video/')[1]}`;
                            return url;
                        })(prop.videoLink) || ''
                    }">
                    </div>
                    <div class="form-group full-width"><label for="prop-description">Descrição Textual</label><textarea id="prop-description" placeholder="Use este campo para um texto de marketing, detalhes sobre o empreendimento...">${prop.description || ''}</textarea></div>
                    
                    <div class="form-group full-width">
                        <label>Diferenciais e Comodidades</label>
                        <div class="amenities-container">
                            <input type="text" id="amenity-search-input" placeholder="Buscar diferencial..." style="margin-bottom: 10px; width: 100%;">
                            <div id="amenities-grid" class="amenities-grid">${amenitiesCheckboxes}</div>
                            <div class="add-amenity-toolbar">
                                <textarea id="new-amenity-input" placeholder="Cole uma lista de diferenciais (um por linha) ou digite um novo item para adicionar." rows="4"></textarea>
                                <button type="button" id="add-amenity-btn" class="btn-secondary" style="align-self: flex-start;"><i class="fas fa-cogs"></i> Processar</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="prop-images">Fotos do Imóvel (até 20) - Clique na estrela (⭐) para definir a foto principal do portfólio.</label>
                        <input type="file" id="prop-images" multiple accept="image/*">
                        <div id="prop-image-previews"></div>
                    </div>
                </div>

                <div class="form-section-title">Variações (Unidades / Plantas)</div>
                <div id="variation-manager-container">
                    <div id="variation-list-container">
                        </div>
                    
                    <div id="add-variation-form-toggle" class="variation-form-toggle">
                        <i class="fas fa-plus"></i> Adicionar Nova Variação
                    </div>

                    <div id="add-variation-form">
                        <h4>Nova Variação</h4>
                        <div class="form-grid">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="variation-name">Nome da Variação</label>
                                <input type="text" id="variation-name" placeholder="Ex: Apto 101, 75m² ou Cobertura">
                            </div>
                            <div class="form-group"><label for="variation-list-price">Valor de Tabela (R$)</label><input type="number" id="variation-list-price"></div>
                            <div class="form-group"><label for="variation-discount">Desconto (R$)</label><input type="number" id="variation-discount" value="0"></div>
                            <div class="form-group"><label for="variation-eval-price">Valor de Avaliação (R$)</label><input type="number" id="variation-eval-price"></div>
                            <div class="form-group"><label for="variation-area">Área (m²)</label><input type="number" id="variation-area"></div>
                            <div class="form-group"><label for="variation-delivery-date">Data Entrega</label><input type="date" id="variation-delivery-date"></div>
                        </div>
                        <h5 style="margin-top: 1rem; margin-bottom: 0.5rem; color: #555;">Plano de Pagamento Construtora</h5>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                            <div class="form-group"><label for="variation-sinal">Sinal (R$)</label><input type="number" id="variation-sinal"></div>
                            <div class="form-group"><label for="variation-entrada-parcelas">Nº Parcelas Entrada</label><input type="number" id="variation-entrada-parcelas" placeholder="Ex: 36"></div>
                            <div class="form-group"><label for="variation-entrada-valor">Valor Parcela (R$)</label><input type="number" id="variation-entrada-valor" placeholder="Ex: 2000"></div>
                            <div class="form-group"><label for="variation-intercaladas-parcelas">Nº Intercaladas</label><input type="number" id="variation-intercaladas-parcelas" placeholder="Ex: 6"></div>
                            <div class="form-group"><label for="variation-intercalada-valor">Valor Intercalada (R$)</label><input type="number" id="variation-intercalada-valor" placeholder="Ex: 10000"></div>
                            <div class="form-group"><label for="variation-chaves">Chaves (R$)</label><input type="number" id="variation-chaves"></div>
                        </div>
                        <div class="toolbar" style="justify-content: flex-end; margin-bottom: 0; margin-top: 1rem;">
                            <button type="button" id="cancel-add-variation-btn" class="btn-secondary">Cancelar</button>
                            <button type="button" id="save-variation-btn" class="btn-primary">Salvar Variação</button>
                        </div>
                    </div>
                </div>
            `;
        };

        const handleVariationManagerClick = (e) => {
            const formToggle = e.target.closest('#add-variation-form-toggle');
            const form = document.getElementById('add-variation-form');
            const cancelBtn = e.target.closest('#cancel-add-variation-btn');
            const saveBtn = e.target.closest('#save-variation-btn');
            const deleteBtn = e.target.closest('button[data-action="delete-variation"]');
            const editBtn = e.target.closest('button[data-action="edit-variation"]');

            if (formToggle) {
                form.style.display = 'block';
                formToggle.style.display = 'none';
                clearVariationForm();
            }

            if (cancelBtn) {
                form.style.display = 'none';
                document.getElementById('add-variation-form-toggle').style.display = 'block';
                clearVariationForm();
            }

            if (saveBtn) {
                const variationData = {
                    id: parseFloat(saveBtn.dataset.editingId) || Date.now() + Math.random(),
                    name: document.getElementById('variation-name').value,
                    listPrice: parseFloat(document.getElementById('variation-list-price').value) || 0,
                    discount: parseFloat(document.getElementById('variation-discount').value) || 0,
                    evalPrice: parseFloat(document.getElementById('variation-eval-price').value) || 0,
                    area: parseFloat(document.getElementById('variation-area').value) || 0,
                    deliveryDate: document.getElementById('variation-delivery-date').value,
                    sinal: parseFloat(document.getElementById('variation-sinal').value) || 0,
                    entradaParcelas: parseInt(document.getElementById('variation-entrada-parcelas').value) || '',
                    entradaValor: parseFloat(document.getElementById('variation-entrada-valor').value) || '',
                    intercaladasParcelas: parseInt(document.getElementById('variation-intercaladas-parcelas').value) || '',
                    intercaladaValor: parseFloat(document.getElementById('variation-intercalada-valor').value) || '',
                    chaves: parseFloat(document.getElementById('variation-chaves').value) || 0,
                };

                if (!variationData.name || variationData.listPrice <= 0) {
                    alert('Por favor, preencha pelo menos o Nome e o Valor de Tabela da variação.');
                    return;
                }

                if (saveBtn.dataset.editingId) {
                    // Editando
                    const index = tempPropertyVariations.findIndex(v => v.id == variationData.id);
                    if (index > -1) {
                        tempPropertyVariations[index] = variationData;
                    }
                } else {
                    // Adicionando novo
                    tempPropertyVariations.push(variationData);
                }
                
                renderVariationList();
                form.style.display = 'none';
                document.getElementById('add-variation-form-toggle').style.display = 'block';
                clearVariationForm();
            }
            
            if (deleteBtn) {
                if (confirm('Tem certeza que deseja excluir esta variação?')) {
                    const index = parseInt(deleteBtn.closest('.variation-item').dataset.index, 10);
                    tempPropertyVariations.splice(index, 1);
                    renderVariationList();
                }
            }
            
            if (editBtn) {
                const index = parseInt(editBtn.closest('.variation-item').dataset.index, 10);
                const variationData = tempPropertyVariations[index];
                
                document.getElementById('variation-name').value = variationData.name;
                document.getElementById('variation-list-price').value = variationData.listPrice;
                document.getElementById('variation-discount').value = variationData.discount;
                document.getElementById('variation-eval-price').value = variationData.evalPrice;
                document.getElementById('variation-area').value = variationData.area;
                document.getElementById('variation-delivery-date').value = variationData.deliveryDate;
                document.getElementById('variation-sinal').value = variationData.sinal;
                document.getElementById('variation-entrada-parcelas').value = variationData.entradaParcelas;
                document.getElementById('variation-entrada-valor').value = variationData.entradaValor;
                document.getElementById('variation-intercaladas-parcelas').value = variationData.intercaladasParcelas;
                document.getElementById('variation-intercalada-valor').value = variationData.intercaladaValor;
                document.getElementById('variation-chaves').value = variationData.chaves;
                
                document.getElementById('save-variation-btn').dataset.editingId = variationData.id;
                document.getElementById('save-variation-btn').textContent = "Atualizar Variação";
                
                form.style.display = 'block';
                document.getElementById('add-variation-form-toggle').style.display = 'none';
            }
        };

        const clearVariationForm = () => {
            document.getElementById('variation-name').value = '';
            document.getElementById('variation-list-price').value = '';
            document.getElementById('variation-discount').value = '0';
            document.getElementById('variation-eval-price').value = '';
            document.getElementById('variation-area').value = '';
            document.getElementById('variation-delivery-date').value = '';
            document.getElementById('variation-sinal').value = '';
            document.getElementById('variation-entrada-parcelas').value = '';
            document.getElementById('variation-entrada-valor').value = '';
            document.getElementById('variation-intercaladas-parcelas').value = '';
            document.getElementById('variation-intercalada-valor').value = '';
            document.getElementById('variation-chaves').value = '';
            
            const saveBtn = document.getElementById('save-variation-btn');
            delete saveBtn.dataset.editingId;
            saveBtn.textContent = "Salvar Variação";
        };

        // =========================================================
        // FIM: FORMULÁRIO DE IMÓVEL TOTALMENTE REFEITO
        // =========================================================
        
        const renderPropertyPreviews = () => {
            const container = document.getElementById('prop-image-previews');
            if (!container) return;
            container.innerHTML = tempPropertyImages.map((imgData, index) => `
                <div class="img-preview-container">
                    <img src="${imgData}" alt="Pré-visualização ${index + 1}">
                    <button class="remove-img-btn" data-index="${index}">&times;</button>
                    <i class="fas fa-star main-image-selector ${index === tempMainImageIndex ? 'active' : ''}" data-index="${index}" title="Definir como foto principal"></i>
                </div>
            `).join('');
        };

        const handleImageSelection = (event) => {
            const files = event.target.files;
            if (!files) return;
            
            const totalImages = tempPropertyImages.length + files.length;
            if (totalImages > 20) {
                alert('Você pode enviar no máximo 20 imagens.');
                return;
            }

            const imagePromises = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                imagePromises.push(new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 1024;
                            const scaleSize = (img.width > MAX_WIDTH) ? MAX_WIDTH / img.width : 1;
                            canvas.width = img.width * scaleSize;
                            canvas.height = img.height * scaleSize;

                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                            const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.75); 
                            resolve(compressedDataUrl);
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                }));
            }

            Promise.all(imagePromises).then(images => {
                tempPropertyImages = [...tempPropertyImages, ...images];
                if(tempMainImageIndex === -1 && tempPropertyImages.length > 0) tempMainImageIndex = 0;
                renderPropertyPreviews();
            }).catch(error => {
                console.error("Erro ao processar imagens:", error);
                alert("Ocorreu um erro ao carregar e comprimir as imagens.");
            });
        };
        
        const handleImagePreviewActions = (event) => {
            if (event.target.classList.contains('remove-img-btn')) {
                const index = parseInt(event.target.dataset.index, 10);
                tempPropertyImages.splice(index, 1);
                // Ajusta o índice da imagem principal se necessário
                if (tempMainImageIndex === index) {
                    tempMainImageIndex = tempPropertyImages.length > 0 ? 0 : -1;
                } else if (tempMainImageIndex > index) {
                    tempMainImageIndex--;
                }
                renderPropertyPreviews();
            } else if (event.target.classList.contains('main-image-selector')) {
                const index = parseInt(event.target.dataset.index, 10);
                tempMainImageIndex = index;
                renderPropertyPreviews();
            }
        };

        document.getElementById('add-property-btn').addEventListener('click', () => {
            openModal('Cadastrar Novo Empreendimento', getPropertyFormHtml(), 'property');
            renderPropertyPreviews();
        });

        // =========================================================
        // INÍCIO: TABELA DE IMÓVEIS ATUALIZADA
        // =========================================================
        const renderPropertiesTable = (filter = '') => {
            const tbody = document.querySelector('#properties-table tbody');
            tbody.innerHTML = '';
            const filtered = db.properties.filter(p => 
                (p.name || '').toLowerCase().includes(filter.toLowerCase()) || 
                (p.location || '').toLowerCase().includes(filter.toLowerCase())
            );
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">Nenhum imóvel (empreendimento) encontrado.</td></tr>'; return;
            }
            filtered.forEach(prop => {
                const variationsCount = prop.variations?.length || 0;
                let startingPrice = 0;
                if (variationsCount > 0) {
                    const prices = prop.variations.map(v => v.listPrice - (v.discount || 0));
                    startingPrice = Math.min(...prices);
                }

                tbody.innerHTML += `
                    <tr>
                        <td><input type="checkbox" class="property-checkbox" data-id="${prop.id}"></td>
                        <td>${prop.name}</td>
                        <td>${prop.location}</td>
                        <td>${variationsCount} ${variationsCount === 1 ? 'variação' : 'variações'}</td>
                        <td>${startingPrice > 0 ? `a partir de ${formatCurrency(startingPrice)}` : 'N/A'}</td>
                        <td class="action-buttons">
                             ${prop.images && prop.images.length > 0 ? `<button title="Ver Fotos" data-action="gallery" data-id="${prop.id}"><i class="fas fa-camera"></i></button>` : ''}
                            <button title="Visualizar Ficha" data-action="view" data-id="${prop.id}"><i class="fas fa-eye"></i></button>
                            <button title="Imprimir Ficha" data-action="print" data-id="${prop.id}"><i class="fas fa-print"></i></button>
                            <button title="Editar" data-action="edit" data-id="${prop.id}"><i class="fas fa-edit"></i></button>
                            <button title="Excluir" data-action="delete" data-id="${prop.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        };
        // =========================================================
        // FIM: TABELA DE IMÓVEIS ATUALIZADA
        // =========================================================

        document.getElementById('property-search').addEventListener('input', e => renderPropertiesTable(e.target.value));

        document.querySelector('#properties-table tbody').addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.dataset.id;
            const action = button.dataset.action;
    
            if (action === 'edit') {
                const prop = db.properties.find(p => p.id == id);
                openModal('Editar Empreendimento', getPropertyFormHtml(prop), 'property', id);
                renderPropertyPreviews();
            } else if (action === 'delete') {
                if (confirm(`Deseja realmente excluir o empreendimento "${db.properties.find(p=>p.id==id)?.name}" e todas as suas variações?`)) {
                    db.properties = db.properties.filter(p => p.id != id);
                    saveData();
                    renderPropertiesTable();
                }
            } else if (action === 'print') {
                const prop = db.properties.find(p => p.id == id);
                const forClient = confirm('Gerar versão para o cliente? (Ocultará valor de avaliação)');
                const propHtml = getPropertyDetailsHtml(id, forClient);
                const title = `Ficha do Imóvel: ${prop.name}`;
                printContent(propHtml, title);
            } else if (action === 'gallery') {
                openImageGallery({ entity: 'property', id: id });
            } else if (action === 'view') {
                 const prop = db.properties.find(p => p.id == id);
                 const propHtml = getPropertyDetailsHtml(id);
                 const modalBodyHtml = `
                    <div class="record-details">${propHtml}</div>
                    <div class="modal-footer" style="display:flex; justify-content: flex-end; margin-top: 1rem;">
                        <button class="btn-primary" id="print-modal-btn"><i class="fas fa-print"></i> Imprimir</button>
                    </div>`;
                 openModal(`Ficha de ${prop.name}`, modalBodyHtml, 'view', null, false);
                 document.getElementById('print-modal-btn').addEventListener('click', () => {
                    const forClient = confirm('Gerar versão para o cliente? (Ocultará valor de avaliação)');
                    const propPrintHtml = getPropertyDetailsHtml(id, forClient);
                    printContent(propPrintHtml, `Ficha do Imóvel: ${prop.name}`);
                 });
            }
        });

        document.getElementById('select-all-properties').addEventListener('change', e => {
            document.querySelectorAll('.property-checkbox').forEach(cb => cb.checked = e.target.checked);
        });
        
        // =========================================================
        // INÍCIO: LÓGICA PARA DIFERENCIAIS DINÂMICOS
        // =========================================================
        const getIconForAmenity = (name) => {
            const lowerName = name.toLowerCase();
            const iconMap = {
                'piscina': 'fas fa-swimming-pool', 'swimmer': 'fas fa-swimmer',
                'playground': 'fas fa-puzzle-piece', 'festa': 'fas fa-birthday-cake',
                'gourmet': 'fas fa-utensils', 'kids': 'fas fa-shapes',
                'criança': 'fas fa-child', 'pet': 'fas fa-paw',
                'bicicleta': 'fas fa-bicycle', 'academia': 'fas fa-dumbbell',
                'ginástica': 'fas fa-dumbbell', 'câmera': 'fas fa-video',
                'cftv': 'fas fa-video', 'segurança': 'fas fa-shield-alt',
                'reciclagem': 'fas fa-recycle', 'coleta': 'fas fa-recycle',
                'lazer': 'fas fa-dice', 'varanda': 'fas fa-archway',
                'ar condicionado': 'fas fa-wind', 'água': 'fas fa-tint',
                'wi-fi': 'fas fa-wifi', 'internet': 'fas fa-wifi',
                'luz': 'fas fa-lightbulb', 'energia': 'fas fa-bolt',
                'descarga': 'fas fa-toilet', 'cozinha': 'fas fa-utensils',
                'granito': 'fas fa-gem', 'mármore': 'fas fa-gem',
                'piso': 'fas fa-layer-group', 'churrasqueira': 'fas fa-cloud-meatball',
                'quadra': 'fas fa-futbol', 'esporte': 'fas fa-running',
                'jardim': 'fas fa-leaf', 'cinema': 'fas fa-film',
                'sauna': 'fas fa-hot-tub', 'escritório': 'fas fa-briefcase',
                'coworking': 'fas fa-briefcase', 'lavanderia': 'fas fa-tshirt',
                'portaria': 'fas fa-door-closed', 'elevador': 'fas fa-caret-square-up'
            };

            for (const keyword in iconMap) {
                if (lowerName.includes(keyword)) {
                    return iconMap[keyword];
                }
            }
            return 'fas fa-check-square'; // Default icon
        };
        
        modalBody.addEventListener('click', e => {
            if (e.target.id !== 'add-amenity-btn') return;

            const input = document.getElementById('new-amenity-input');
            const grid = document.getElementById('amenities-grid');
            const pastedText = input.value.trim();

            if (!pastedText) {
                alert('Por favor, digite ou cole os itens na caixa de texto.');
                return;
            }

            const itemsToProcess = pastedText.split('\n')
                                             .map(item => item.trim())
                                             .filter(item => item.length > 0);

            let newItemsWereAddedToDB = false;

            itemsToProcess.forEach(itemName => {
                const existingAmenity = db.amenities.find(a => a.name.toLowerCase() === itemName.toLowerCase());
                
                if (existingAmenity) {
                    const checkboxId = `amenity-${existingAmenity.name.replace(/\s/g, '-')}`;
                    const checkbox = document.getElementById(checkboxId);
                    if (checkbox) checkbox.checked = true;
                } else {
                    const newAmenity = { name: itemName, icon: getIconForAmenity(itemName) };
                    db.amenities.push(newAmenity);
                    newItemsWereAddedToDB = true;

                    const newAmenityId = `amenity-${itemName.replace(/\s/g, '-')}`;
                    const newItemHtml = `
                        <div class="amenity-item">
                            <input type="checkbox" id="${newAmenityId}" name="amenities" value="${itemName}" checked>
                            <label for="${newAmenityId}">${itemName}</label>
                        </div>
                    `;
                    grid.insertAdjacentHTML('beforeend', newItemHtml);
                }
            });

            if (newItemsWereAddedToDB) saveData(); 

            input.value = '';
            alert(`${itemsToProcess.length} item(ns) processado(s) com sucesso!`);
        });
        
        modalBody.addEventListener('input', e => {
            if (e.target.id === 'amenity-search-input') {
                const searchTerm = e.target.value.toLowerCase();
                const amenitiesGrid = document.getElementById('amenities-grid');
                if (!amenitiesGrid) return;

                const items = amenitiesGrid.querySelectorAll('.amenity-item');
                items.forEach(item => {
                    const label = item.querySelector('label');
                    if (label) {
                        const labelText = label.textContent.toLowerCase();
                        item.style.display = labelText.includes(searchTerm) ? 'flex' : 'none';
                    }
                });
            }
        });

        // ==========================================
        // GALERIA DE IMAGENS (AGORA GENÉRICA)
        // ==========================================
        const galleryModal = document.getElementById('image-gallery-modal');
        const galleryImage = document.getElementById('gallery-current-image');
        const galleryContainer = document.getElementById('gallery-image-container');
        const galleryCounter = document.getElementById('gallery-counter');
        let currentImageIndex = 0;
        let currentImages = [];

        const openImageGallery = (options) => {
            let imagesToShow = [];
            let startIndex = options.startIndex || 0;

            if (options.entity === 'property') {
                const property = db.properties.find(p => p.id == options.id);
                if (property && property.images && property.images.length > 0) {
                    imagesToShow = property.images;
                }
            } else if (options.entity === 'note') {
                const note = db.knowledgeBase.find(n => n.id == options.id);
                if (note && note.images && note.images.length > 0) {
                    imagesToShow = note.images;
                }
            }

            if (imagesToShow.length === 0) return;
            
            currentImages = imagesToShow;
            currentImageIndex = startIndex;
            updateGalleryView();
            galleryModal.classList.add('active');
        };

        const updateGalleryView = () => {
            galleryImage.src = currentImages[currentImageIndex];
            galleryCounter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
        };

        const changeImage = (direction) => {
            currentImageIndex += direction;
            if (currentImageIndex >= currentImages.length) { currentImageIndex = 0; }
            if (currentImageIndex < 0) { currentImageIndex = currentImages.length - 1; }
            updateGalleryView();
        };
        
        document.getElementById('gallery-next').addEventListener('click', () => changeImage(1));
        document.getElementById('gallery-prev').addEventListener('click', () => changeImage(-1));
        document.getElementById('gallery-close').addEventListener('click', () => galleryModal.classList.remove('active'));
        document.getElementById('gallery-fullscreen').addEventListener('click', () => {
            if (!document.fullscreenElement) {
                galleryContainer.requestFullscreen().catch(err => {
                    alert(`Erro ao entrar em tela cheia: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        });
        
        // ==========================================
        // GESTÃO DA AGENDA (CALENDÁRIO)
        // ==========================================
        const getEventFormHtml = (event = {}, date = '') => {
            const clientOptions = db.clients.map(client => 
                `<option value="${client.id}" ${event.clientId == client.id ? 'selected' : ''}>${client.name}</option>`
            ).join('');

            return `
                <div class="form-grid">
                    <div class="form-group"><label for="event-title">Título</label><input type="text" id="event-title" value="${event.title || ''}"></div>
                    <div class="form-group"><label for="event-client">Associar ao Cliente (Opcional)</label><select id="event-client"><option value="">Nenhum</option>${clientOptions}</select></div>
                    <div class="form-group"><label for="event-date">Data</label><input type="date" id="event-date" value="${event.date || date}"></div>
                    <div class="form-group"><label for="event-time">Hora</label><input type="time" id="event-time" value="${event.time || ''}"></div>
                    <div class="form-group">
                        <label for="event-recurrence">Recorrência</label>
                        <select id="event-recurrence" onchange="document.getElementById('event-end-date-group').style.display = this.value === 'none' ? 'none' : 'block'">
                            <option value="none" ${!event.recurrence || event.recurrence === 'none' ? 'selected' : ''}>Nunca</option>
                            <option value="daily" ${event.recurrence === 'daily' ? 'selected' : ''}>Diariamente</option>
                            <option value="weekly" ${event.recurrence === 'weekly' ? 'selected' : ''}>Semanalmente</option>
                            <option value="monthly" ${event.recurrence === 'monthly' ? 'selected' : ''}>Mensalmente</option>
                        </select>
                    </div>
                    <div class="form-group" id="event-end-date-group"><label for="event-end-date">Data Final da Recorrência (Opcional)</label><input type="date" id="event-end-date" value="${event.endDate || ''}"></div>
                    <div class="form-group full-width"><label for="event-description">Descrição</label><textarea id="event-description">${event.description || ''}</textarea></div>
                </div>
            `;
        };

        document.getElementById('add-event-btn').addEventListener('click', () => {
            const today = new Date().toISOString().slice(0, 10);
            openModal('Novo Compromisso', getEventFormHtml({}, today), 'event');
            // INÍCIO DA CORREÇÃO: Esconde o campo de data final se a recorrência for 'Nunca'
            setTimeout(() => {
                const recurrenceSelect = document.getElementById('event-recurrence');
                if (recurrenceSelect) recurrenceSelect.dispatchEvent(new Event('change'));
            }, 100);
            // FIM DA CORREÇÃO
        });

        const getEventsForDate = (targetDate) => {
            const eventsOnDay = [];
            const targetDateObj = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());

            db.events.forEach(event => {
                if (!event.date) return;
                const startDate = new Date(event.date + 'T00:00:00');
                const endDate = event.endDate ? new Date(event.endDate + 'T00:00:00') : null;

                if (targetDateObj < startDate || (endDate && targetDateObj > endDate)) return;

                let isMatch = false;
                switch (event.recurrence) {
                    case 'none':
                        if (startDate.getTime() === targetDateObj.getTime()) isMatch = true;
                        break;
                    case 'daily':
                        isMatch = true;
                        break;
                    case 'weekly':
                        if (startDate.getDay() === targetDateObj.getDay()) isMatch = true;
                        break;
                    case 'monthly':
                        if (startDate.getDate() === targetDateObj.getDate()) isMatch = true;
                        break;
                    default:
                        if (startDate.getTime() === targetDateObj.getTime()) isMatch = true;
                }
                if (isMatch) eventsOnDay.push({ ...event, type: 'event' });
            });

            db.financialRecords.forEach(record => {
                record.payments.forEach((payment, index) => {
                    const paymentDate = new Date(payment.date + 'T00:00:00');
                    if (paymentDate.getTime() === targetDateObj.getTime()) {
                         eventsOnDay.push({
                            id: `${record.id}-${index}`,
                            title: record.description,
                            value: record.value,
                            type: record.type === 'income' ? 'income' : 'expense'
                        });
                    }
                });
            });

            return eventsOnDay;
        };


        const renderAgendaCalendar = () => {
            const grid = document.getElementById('calendar-grid');
            const monthYearEl = document.getElementById('month-year');
            const weekdaysEl = document.getElementById('weekdays');

            grid.innerHTML = '';
            weekdaysEl.innerHTML = '';
            
            const month = currentCalendarDate.getMonth();
            const year = currentCalendarDate.getFullYear();
            
            monthYearEl.textContent = new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].forEach(day => weekdaysEl.innerHTML += `<div>${day}</div>`);

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            for (let i = 0; i < firstDayOfMonth; i++) {
                grid.innerHTML += `<div class="calendar-day other-month"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().slice(0, 10);
                const isToday = date.toDateString() === today.toDateString();

                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                if(isToday) dayDiv.classList.add('today');
                dayDiv.dataset.date = dateString;
                dayDiv.innerHTML = `<div class="day-number">${day}</div><div class="events-container"></div>`;
                
                const eventsOnThisDay = getEventsForDate(date);
                const eventsContainer = dayDiv.querySelector('.events-container');

                eventsOnThisDay.forEach(event => {
                    const eventPill = document.createElement('div');
                    eventPill.className = 'event-pill';
                    eventPill.textContent = event.title;
                    
                    if (event.type === 'event') {
                        eventPill.dataset.eventId = event.id;
                        if(event.completed) eventPill.classList.add('completed');
                        const eventDateTime = new Date(`${event.date}T${event.time || '23:59:59'}`);
                        if(!event.completed && eventDateTime < today) eventPill.classList.add('overdue');
                    } else if (event.type === 'income') {
                        eventPill.classList.add('event-pill-income');
                        eventPill.innerHTML = `<i class="fas fa-arrow-up"></i> ${event.title}`;
                    } else if (event.type === 'expense') {
                         eventPill.classList.add('event-pill-expense');
                         eventPill.innerHTML = `<i class="fas fa-arrow-down"></i> ${event.title}`;
                    }
                    
                    eventsContainer.appendChild(eventPill);
                });

                grid.appendChild(dayDiv);
            }
        };

        document.getElementById('prev-month-btn').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderAgendaCalendar();
        });

        document.getElementById('next-month-btn').addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderAgendaCalendar();
        });

        document.getElementById('calendar-grid').addEventListener('click', e => {
            const dayElement = e.target.closest('.calendar-day');
            if (!dayElement) return;

            const date = dayElement.dataset.date;
            
            if(e.target.classList.contains('event-pill') && e.target.dataset.eventId) {
                const eventId = e.target.dataset.eventId;
                const event = db.events.find(ev => ev.id == eventId);
                if(event) {
                    openModal('Editar Compromisso', getEventFormHtml(event), 'event', eventId);
                    // INÍCIO DA CORREÇÃO: Esconde o campo de data final se a recorrência for 'Nunca'
                    setTimeout(() => {
                        const recurrenceSelect = document.getElementById('event-recurrence');
                        if (recurrenceSelect) recurrenceSelect.dispatchEvent(new Event('change'));
                    }, 100);
                    // FIM DA CORREÇÃO
                }
                return;
            }

            const eventsOnDay = db.events.filter(ev => {
                 if (!ev.date) return false;
                 // Lógica de recorrência simples (apenas data exata por enquanto)
                 const startDate = new Date(ev.date + 'T00:00:00');
                 if (ev.recurrence === 'none' || !ev.recurrence) {
                     return startDate.toISOString().slice(0,10) === date;
                 }
                 // (Lógica de recorrência complexa omitida por enquanto)
                 return startDate.toISOString().slice(0,10) === date;
            });

            const clientsBirthday = db.clients.filter(client => {
                if (!client.birthdate) return false;
                const birthDate = new Date(client.birthdate + 'T00:00:00');
                const clickedDate = new Date(date + 'T00:00:00');
                return birthDate.getDate() === clickedDate.getDate() && birthDate.getMonth() === clickedDate.getMonth();
            });

            if (eventsOnDay.length === 0 && clientsBirthday.length === 0) {
                 openModal('Novo Compromisso', getEventFormHtml({}, date), 'event');
            } else {
                openDayEventsModal(date, eventsOnDay, clientsBirthday);
            }
        });
        
        const openDayEventsModal = (date, events, birthdays) => {
            let content = '<div class="day-events-list">';
            const now = new Date();
            
            if (birthdays.length > 0) {
                content += '<h3><i class="fas fa-birthday-cake"></i> Aniversariantes</h3>';
                birthdays.forEach(client => {
                    content += `<div class="birthday-item event-item">Parabéns para <strong>${client.name}</strong>! <a href="https://wa.me/${(client.phone || '').replace(/\D/g, '')}?text=Olá, ${client.name.split(' ')[0]}! Parabéns pelo seu aniversário!" target="_blank"><i class="fab fa-whatsapp"></i> Enviar mensagem</a></div>`;
                });
            }

            if (events.length > 0) {
                content += '<h3>Compromissos</h3>';
                events.sort((a,b) => (a.time || '').localeCompare(b.time || ''));

                events.forEach(event => {
                    const client = db.clients.find(c => c.id == event.clientId);
                    const eventDateTime = new Date(`${event.date}T${event.time || '00:00:00'}`);
                    const isOverdue = !event.completed && eventDateTime < now;

                   // --- INÍCIO DA MODIFICAÇÃO (Etapa 1 de 2) ---
                    let whatsappButtonHtml = '';

                    // Verificamos as condições
                    if (client && client.phone && event.title.toLowerCase().includes('enviar mensagem')) {
                        const cleanPhone = (client.phone || '').replace(/\D/g, '');
                        
                        // TROCAMOS o <a> por <button> e adicionamos 'data-action'
                        whatsappButtonHtml = `
                            <button data-action="day-view-whatsapp" 
                                    data-client-id="${client.id}" 
                                    data-phone="${cleanPhone}" 
                                    title="Enviar WhatsApp e registrar contato" 
                                    style="font-size: 1.2rem; color: #25D366; margin-left: 10px; background:none; border:none; cursor:pointer; padding:0; vertical-align: middle;">
                                <i class="fab fa-whatsapp"></i>
                            </button>`;
                    }
                    // --- FIM DA MODIFICAÇÃO (Etapa 1 de 2) ---
                    
                    content += `
                        <div class="event-item ${event.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}" data-id="${event.id}">
                            <h4>${event.title} - ${event.time || 'horário não definido'} ${whatsappButtonHtml}</h4>
                            <p>${event.description}</p>
                            ${client ? `<p><strong>Cliente:</strong> ${client.name}</p>` : ''}
                            <div class="action-buttons" style="margin-top: 10px;">
                                <button title="${event.completed ? 'Marcar como não concluído' : 'Marcar como concluído'}" data-action="toggle-complete"><i class="fas fa-check-circle"></i></button>
                                <button title="Editar" data-action="edit"><i class="fas fa-edit"></i></button>
                                <button title="Excluir" data-action="delete"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                });
            }
            content += '</div>';
            openModal(`Eventos de ${formatDate(date)}`, content, 'day-view', null, false);
        };
        
        modalBody.addEventListener('click', e => {
            if(currentEntityType !== 'day-view') return;
            
            const button = e.target.closest('button');
            if (!button) return;
            
            const eventItem = button.closest('.event-item');
            if(!eventItem) return;
            const id = eventItem.dataset.id;
            const action = button.dataset.action;
            const event = db.events.find(ev => ev.id == id);
            
            if (action === 'edit') {
                closeModal();
                openModal('Editar Compromisso', getEventFormHtml(event), 'event', id);
            } else if (action === 'delete') {
                if (confirm('Deseja excluir este compromisso?')) {
                    db.events = db.events.filter(ev => ev.id != id);
                    saveData();
                    closeModal();
                    renderAgendaCalendar();
                }

            } else if (action === 'toggle-complete') {
                event.completed = !event.completed;
                saveData();
                closeModal();
                renderAgendaCalendar();
            }
            
            // --- INÍCIO DA ADIÇÃO ---
            // Nova ação para o botão WhatsApp do modal da agenda
            else if (action === 'day-view-whatsapp') {
                const clientId = button.dataset.clientId;
                const phone = (button.dataset.phone || '').replace(/\D/g, ''); // Garante que o tel. está limpo
                
                if (!phone) {
                    alert('Erro: Cliente não possui telefone cadastrado.');
                    return;
                }
                
                // 1. Abre o WhatsApp
                const url = `https://wa.me/${phone}`;
                window.open(url, '_blank');
                
                // 2. Registra o contato no cliente (ESSENCIAL)
                const client = db.clients.find(c => c.id == clientId);
                if (client) {
                    client.lastContact = new Date().toISOString().slice(0, 10);
                    if (!client.contactHistory) client.contactHistory = [];
                    
                    client.contactHistory.push({
                        date: client.lastContact,
                        stageId: client.stageId
                    });
                    
                    saveData();
                    showToast(`Contato com ${client.name.split(' ')[0]} registrado!`);
                }
            }
            // --- FIM DA ADIÇÃO ---

        });

         // ==========================================
        // GESTÃO DE LINKS ÚTEIS (COM ENCURTADOR)
        // ==========================================
        const getLinkFormHtml = (link = {}) => {
            return `
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="link-title">Título</label>
                        <input type="text" id="link-title" value="${link.title || ''}" placeholder="Ex: Portal Zap Imóveis">
                    </div>
                    <div class="form-group full-width">
                        <label for="link-url">URL (Endereço do Site)</label>
                        <input type="url" id="link-url" value="${link.url || ''}" placeholder="https://www.zapimoveis.com.br">
                    </div>
                </div>
            `;
        };

        document.getElementById('add-link-btn').addEventListener('click', () => {
            openModal('Adicionar Novo Link', getLinkFormHtml(), 'link');
        });

        const renderLinksTable = () => {
            const tbody = document.querySelector('#links-table tbody');
            tbody.innerHTML = '';

            if (!db.usefulLinks || db.usefulLinks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3">Nenhum link cadastrado.</td></tr>';
                return;
            }

            db.usefulLinks.forEach(link => {
                const shortUrl = link.url; // Fallback para links antigos
                tbody.innerHTML += `
                    <tr>
                        <td>${link.title}</td>
                        <td><a href="${shortUrl}" target="_blank">${shortUrl}</a></td>
                        <td class="action-buttons">
                            <a href="${shortUrl}" target="_blank" class="btn-link" title="Abrir Link"><i class="fas fa-external-link-alt"></i></a>
                            <button title="Copiar Link Curto" data-action="copy" data-short-url="${shortUrl}"><i class="fas fa-copy"></i></button>
                            <button title="Editar" data-action="edit" data-id="${link.id}"><i class="fas fa-edit"></i></button>
                            <button title="Excluir" data-action="delete" data-id="${link.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        };
        
        document.querySelector('#links-table tbody').addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.dataset.id;
            const action = button.dataset.action;

            if (action === 'edit') {
                const link = db.usefulLinks.find(l => l.id == id);
                openModal('Editar Link', getLinkFormHtml(link), 'link', id);
            } else if (action === 'delete') {
                if (confirm(`Deseja realmente excluir o link?`)) {
                    db.usefulLinks = db.usefulLinks.filter(l => l.id != id);
                    saveData();
                    renderLinksTable();
                }
            } else if (action === 'copy') {
                const urlToCopy = button.dataset.shortUrl;
                navigator.clipboard.writeText(urlToCopy).then(() => {
                    showToast('Link curto copiado!');
                }).catch(err => {
                    console.error('Falha ao copiar:', err);
                    showToast('Erro ao copiar o link.');
                });
            }
        });

        
        // ==========================================
        // CÁLCULOS E ANÁLISE DE FINANCIAMENTO
        // ==========================================
        const calculateMinimumIncomeForProperty = (propertyPrice) => {
            if (!propertyPrice || propertyPrice <= 0) return 0;
            const P = propertyPrice * 0.80; 
            const r = (1 + 0.079348)**(1/12) - 1; 
            const n = 420; 
            const pmt = (P * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
            const requiredIncome = pmt / 0.30;
            return requiredIncome;
        };
             
        /* ================================================================
        PASSO 3.2 - COLE ESTA NOVA FUNÇÃO INTEIRA AQUI
        ================================================================
        */
        const calculateSubsidy = (client) => {
            // 1. Regra básica (conforme sua solicitação)
            if (client.alreadyOwnsProperty) {
                console.log("Cálculo de Subsídio: Cliente já possui imóvel. Subsídio = 0.");
                return 0; // Não tem direito se já possui imóvel
            }

            // 2. Coleta de dados do cliente
            const income = client.income || 0;
            const birthdate = client.birthdate;
            
            // Se não tiver data de nascimento, não podemos calcular
            if (!birthdate) {
                console.log("Cálculo de Subsídio: Cliente sem data de nascimento. Subsídio = 0.");
                return 0;
            }

            const ageInYears = getAgeInMonths(birthdate) / 12;
            const hasFormalWork = client.hasFormalWork;
            
            // OBS: Faltam dados cruciais: Cidade/Estado (Maceió?), se tem dependentes, saldo FGTS.

            // =================================================================
            // !! AVISO IMPORTANTE !! 
            // A LÓGICA ABAIXO É APENAS UM EXEMPLO BASEADO NO QUE VOCÊ DISSE.
            // A FÓRMULA REAL É EXTREMAMENTE COMPLEXA.
            // VOCÊ DEVE SUBSTITUIR ESTA LÓGICA PELAS REGRAS REAIS DA CAIXA.
            // =================================================================

            // Usando os exemplos que você forneceu (nascido em 1990 -> 35 anos em 2025):
            // Vamos considerar uma faixa de idade, ex: entre 35 e 36 anos.
            if (income === 2000 && ageInYears >= 35 && ageInYears < 36) { 
                if (hasFormalWork) {
                    console.log("Cálculo de Subsídio: R$2000, 35 anos, com carteira. Subsídio = 10032.00");
                    return 10032.00;
                } else {
                    console.log("Cálculo de Subsídio: R$2000, 35 anos, sem carteira. Subsídio = 10215.00");
                    return 10215.00;
                }
            }
            
            // Exemplo de outra faixa de renda (fictícia)
            if (income > 2000 && income <= 2600) {
                 // return 8000.00; // (Lógica de exemplo)
            }
            
            // Retorna 0 (nenhum subsídio) se nenhuma regra for atendida
            console.log("Cálculo de Subsídio: Nenhuma regra atendida. Subsídio = 0.");
            return 0; 
        };
        
        // =========================================================
        // INÍCIO: FUNÇÃO DE CÁLCULO DE FINANCIAMENTO ATUALIZADA
        // =========================================================
        const calculateFinancing = (client, variation, property) => {
            // 1. Validação de dados de entrada
            // USA VALOR DE AVALIAÇÃO (ou tabela-desconto se avaliação for 0 ou não existir)
            const finalVariationPrice = variation.listPrice - (variation.discount || 0);
            const propertyPrice = (variation.evalPrice && variation.evalPrice > 0) ? variation.evalPrice : finalVariationPrice;

            if (!client || !variation || !property || !propertyPrice) {
                return { error: 'Dados insuficientes. Verifique se o cliente possui uma variação de imóvel com valor de avaliação (ou tabela) cadastrado.' };
            }

            /* ================================================================
            INÍCIO DA MODIFICAÇÃO (PASSO 4)
            ================================================================
            */
            
            // 2. CALCULAR O SUBSÍDIO PRIMEIRO
            // Usamos a nova função que criamos no Passo 3.2
            const subsidyAmount = calculateSubsidy(client);
            
            // 3. Regra de Elegibilidade (Não pode ter imóvel)
            if (client.alreadyOwnsProperty && subsidyAmount > 0) {
                 return { error: 'Cliente já possui imóvel. Não é elegível para programas de subsídio.' };
            }
            /* ================================================================
            FIM DA MODIFICAÇÃO
            ================================================================ */


            // --- INÍCIO DA MODIFICAÇÃO DE RENDA E IDADE ---
            let totalIncome = client.income || 0;
            let incomeReason = `Renda Titular: ${formatCurrency(totalIncome)}`;
            let oldestAgeInMonths = getAgeInMonths(client.birthdate);

            // Validação de data de nascimento do titular
            if (oldestAgeInMonths === null) {
                return { error: 'Data de nascimento do cliente (titular) é inválida.' };
            }

            // Verifica se o cônjuge compõe renda e tem dados válidos
            if (client.spouseComposesIncome && client.spouseIncome > 0 && client.spouseBirthdate) {
                const spouseAgeInMonths = getAgeInMonths(client.spouseBirthdate);
                if (spouseAgeInMonths === null) {
                     return { error: 'Data de nascimento do Cônjuge é inválida.' };
                }
                
                // Soma a renda
                totalIncome += client.spouseIncome;
                incomeReason += ` + Renda Cônjuge: ${formatCurrency(client.spouseIncome)}`;
                
                // Pega a idade do mais velho
                oldestAgeInMonths = Math.max(oldestAgeInMonths, spouseAgeInMonths);
            }

            // Validação da renda total
            if (totalIncome <= 0) {
                 return { error: 'Dados insuficientes. A renda total (titular ou + cônjuge) deve ser maior que zero para a simulação.' };
            }
            // --- FIM DA MODIFICAÇÃO DE RENDA E IDADE ---


            // --- INÍCIO DA MODIFICAÇÃO DAS TAXAS DE JUROS ---
            let INTEREST_RATE_YEARLY;
            let rateReason;

            // Lógica de taxas de juros por faixa de renda (espelhada da sua outra função)
            if (totalIncome <= 4000) {
                INTEREST_RATE_YEARLY = 0.056408; // 5,5% Nominal
                rateReason = 'Renda <= R$ 4.000 (Taxa 5,5% Nominal)';
            } else if (totalIncome <= 4700) {
                INTEREST_RATE_YEARLY = 0.066972; // 6,5% Nominal
                rateReason = 'Renda <= R$ 4.700 (Taxa 6,5% Nominal)';
            } else {
                // Acima de 4.700, usamos a lógica que já existia
                if (client.hasFormalWork) {
                    INTEREST_RATE_YEARLY = 0.079348;
                    rateReason = 'Renda > R$ 4.700 (Com 3+ anos CA)';
                } else {
                    INTEREST_RATE_YEARLY = 0.084723;
                    rateReason = 'Renda > R$ 4.700 (Sem 3+ anos CA)';
                }
            }
            // --- FIM DA MODIFICAÇÃO DAS TAXAS DE JUROS ---

            
            // 3. Constantes do financiamento (como antes)
            const MAX_AGE_MONTHS = 966; // 80 anos e 6 meses
            const MAX_TERM_MONTHS = 420; // 35 anos
            const MAX_LOAN_TO_VALUE = 0.80; // 80%
            const MAX_DEBT_TO_INCOME = 0.30; // 30%

            // 4. Cálculo do prazo (AGORA USANDO A IDADE DO MAIS VELHO)
            const maxTermByAge = MAX_AGE_MONTHS - oldestAgeInMonths; // <-- MODIFICADO
            
            if (maxTermByAge <= 0) {
                // Mensagem de erro personalizada
                if (oldestAgeInMonths === getAgeInMonths(client.birthdate)) {
                     return { error: 'Cliente (proponente mais velho) está acima da idade máxima para financiamento (80 anos e 6 meses).' };
                } else {
                     return { error: 'Cônjuge (proponente mais velho) está acima da idade máxima para financiamento (80 anos e 6 meses).' };
                }
            }
            
            // O prazo final continua sendo o menor valor entre o prazo máximo (420) e o prazo restante pela idade
            const finalTerm = Math.min(MAX_TERM_MONTHS, maxTermByAge);

            // 5. Cálculo da taxa MENSAL (baseada na taxa ANUAL que definimos)
            const monthlyInterestRate = (1 + INTEREST_RATE_YEARLY)**(1/12) - 1; 

            // 6. Cálculos de financiamento
            const maxLoanFromBank = propertyPrice * MAX_LOAN_TO_VALUE;
            const maxAffordablePayment = totalIncome * MAX_DEBT_TO_INCOME;
            const requiredPaymentForMaxLoan = (maxLoanFromBank * monthlyInterestRate) / (1 - Math.pow(1 + monthlyInterestRate, -finalTerm));

            // =========================================================
            // INÍCIO: CÁLCULO DA COMPATIBILIDADE
            // =========================================================
            let compatibilityScore = 0;
            if (requiredPaymentForMaxLoan > 0) {
                compatibilityScore = (maxAffordablePayment / requiredPaymentForMaxLoan) * 100;
            }
            // Limita o score a 100% (ou mais, se o cliente tiver muita folga)
            compatibilityScore = Math.floor(compatibilityScore); 
            // =========================================================
            // FIM: CÁLCULO DA COMPATIBILIDADE
            // =========================================================


            const isCompatible = requiredPaymentForMaxLoan <= maxAffordablePayment;
            let approvedLoanAmount, requiredDownPayment;

            if (isCompatible) {
                approvedLoanAmount = maxLoanFromBank;
                
                /* ================================================================
                   MODIFICAÇÃO AQUI: Subtrai o subsídio da entrada
                   ================================================================ */
                requiredDownPayment = finalVariationPrice - approvedLoanAmount - subsidyAmount;
                
            } else {
                approvedLoanAmount = (maxAffordablePayment / monthlyInterestRate) * (1 - Math.pow(1 + monthlyInterestRate, -finalTerm));
                
                /* ================================================================
                   MODIFICAÇÃO AQUI: Subtrai o subsídio da entrada
                   ================================================================ */
                requiredDownPayment = finalVariationPrice - approvedLoanAmount - subsidyAmount;
            }
            
            // Garante que a entrada não seja negativa se o subsídio for muito alto
            if (requiredDownPayment < 0) {
                requiredDownPayment = 0;
            }

            // 7. Retorna os resultados
            return {
                isCompatible, clientIncome: totalIncome, // Modificado
                incomeReason: incomeReason, // Adicionado
                propertyValue: propertyPrice, // Valor de Avaliação usado no cálculo
                listPrice: finalVariationPrice, // Valor de Tabela (com desconto) para cálculo da entrada
                maxAffordablePayment, requiredPaymentForMaxLoan, approvedLoanAmount, requiredDownPayment,
                finalTerm: Math.floor(finalTerm), 
                standardDownPayment: finalVariationPrice - (propertyPrice * MAX_LOAN_TO_VALUE),
                rateUsed: INTEREST_RATE_YEARLY, // Adicionado
                rateReason: rateReason, // Adicionado
                
                /* ================================================================
                   LINHA ADICIONADA AQUI: Passa o valor do subsídio para o resultado
                   ================================================================ */
                subsidyAmount: subsidyAmount,
                compatibilityScore: compatibilityScore // A NOVA CHAVE
            };
        };
        // =========================================================
        // FIM: FUNÇÃO DE CÁLCULO DE FINANCIAMENTO ATUALIZADA
        // =========================================================


        // =========================================================
        // INÍCIO: HTML DA ANÁLISE DE FINANCIAMENTO ATUALIZADO
        // =========================================================
        const getFinancingAnalysisHtml = (analysis, clientName, propertyName, variationName) => {
         if (analysis.error) {
            return `<div class="analysis-result"><p class="highlight-danger">${analysis.error}</p></div>`;
        }
        
        // --- Lógica de Cor para o Score ---
let scoreClass = 'danger'; // Vermelho por padrão
if (analysis.compatibilityScore >= 100) {
    scoreClass = 'success'; // Verde (somente 100% ou mais)
} else if (analysis.compatibilityScore >= 80) {
    scoreClass = 'warning'; // Amarelo/Aviso (entre 80% e 99.9%)
}
// Abaixo de 80% ele automaticamente fica 'danger' (definido na primeira linha)
// --- Fim da Lógica de Cor ---

        const resultClass = analysis.isCompatible ? 'highlight-success' : 'highlight-danger';
        const resultText = analysis.isCompatible ? 'RENDA COMPATÍVEL' : 'RENDA INSUFICIENTE PARA FINANCIAMENTO DE 80%';
        const rateUsedPercent = (analysis.rateUsed * 100).toFixed(4); // Mostra a taxa exata

        // Pega o novo motivo da análise
        const reasonText = analysis.rateReason ? `(${analysis.rateReason})` : '';
        // Pega a nova composição da renda
        const incomeComposition = analysis.incomeReason ? `<p style="margin-top: 5px;"><small><strong>Composição:</strong> ${analysis.incomeReason}</small></p>` : '';


        /* ================================================================
        INÍCIO DA MODIFICAÇÃO (PASSO 5)
        ================================================================
        */
        // Define o HTML do subsídio. Se for 0, mostra uma mensagem simples.
        const subsidyHtml = analysis.subsidyAmount > 0 
            ? `<p><strong>Subsídio Estimado (MCMV/Etc.):</strong> <strong style="color: var(--success-color);">${formatCurrency(analysis.subsidyAmount)}</strong></p>`
            : '<p><small>Subsídio não aplicável ou não calculado.</small></p>';
        /* ================================================================
        FIM DA MODIFICAÇÃO
        ================================================================ */


        return `
            <div class="compatibility-score-container ${scoreClass}">
                <h3>Nível de Compatibilidade</h3>
                <div class="compatibility-score-value">${analysis.compatibilityScore}%</div>
            </div>

            <div class="analysis-result">
                <h4>Análise para <strong>${clientName}</strong></h4>
                <p style="margin-top: 5px;"><strong>Empreendimento:</strong> ${propertyName} | <strong>Variação:</strong> ${variationName}</p>
                <hr>
                <p><strong>Valor de Tabela (Venda):</strong> ${formatCurrency(analysis.listPrice)}</p>
                <p><strong>Valor de Avaliação (Base do Cálculo):</strong> ${formatCurrency(analysis.propertyValue)}</p>
                <p><strong>Renda Total:</strong> ${formatCurrency(analysis.clientIncome)}</p>
                ${incomeComposition} 
                
                <p><strong>Taxa de Juros Efetiva (Anual):</strong> ${rateUsedPercent}% ${reasonText}</p>

                <p><strong>Parcela Máxima Suportada (30%):</strong> ${formatCurrency(analysis.maxAffordablePayment)}</p>
                <p><strong>Prazo Máximo de Financiamento:</strong> ${analysis.finalTerm} meses (${Math.floor(analysis.finalTerm / 12)} anos)</p><hr>
                <h4>Resultado da Simulação</h4>
                <p><strong>Parcela Estimada (para 80% da Avaliação):</strong> ${formatCurrency(analysis.requiredPaymentForMaxLoan)}</p>
                
                <p style="margin-top: 5px;"><small><strong>Atenção:</strong> O valor da parcela estimada não inclui o seguro Caixa (MIP/DFI), que varia conforme a apólice escolhida no momento da contratação.</small></p>

                <p><strong>Resultado:</strong> <span class="${resultClass}">${resultText}</span></p><br>
                <p><strong>Valor Máximo de Financiamento Aprovado:</strong> ${formatCurrency(analysis.approvedLoanAmount)}</p>
                
                ${subsidyHtml} <p><strong>ENTRADA (Valor Tabela - Financiamento - Subsídio):</strong> <strong class="${resultClass}">${formatCurrency(analysis.requiredDownPayment)}</strong></p>
                <p style="margin-top: 5px;"><small><strong>Forma de Pagamento da Entrada:</strong> Esse valor pode ser abatido com o saldo do FGTS (caso tenha) e recursos próprios. Para tanto, é necessário elaborar um plano de pagamento compatível com sua realidade financeira e que esteja dentro dos parâmetros estipulados pela construtora.</small></p>
                ${!analysis.isCompatible ? `<p><small>(A entrada padrão com base na avaliação seria de ${formatCurrency(analysis.standardDownPayment)})</small></p>` : ''}
            </div>
        `;
    };
        
        // =========================================================
        // INÍCIO: FUNÇÃO DE ANÁLISE ATUALIZADA
        // =========================================================
        const handleFinancingAnalysis = (clientId) => {
            const client = db.clients.find(c => c.id == clientId);
            
            // 1. Verifica se o cliente tem uma variação vinculada
            if (!client.propertyId || !client.variationId) {
                alert('Este cliente não está associado a uma Variação de imóvel. Edite o cadastro do cliente para selecionar uma.');
                return;
            }
            
            // 2. Encontra o empreendimento e a variação
            const property = db.properties.find(p => p.id == client.propertyId);
            if (!property) {
                 alert('O empreendimento (imóvel) associado a este cliente não foi encontrado.'); return;
            }
            const variation = property.variations.find(v => v.id == client.variationId);
            if (!variation) {
                 alert('A variação (unidade) associada a este cliente não foi encontrada.'); return;
            }

            // 3. Roda a nova função de cálculo
            const analysis = calculateFinancing(client, variation, property);
            
            // 4. Gera o HTML da análise (agora passando mais nomes)
            const analysisHtml = getFinancingAnalysisHtml(analysis, client.name, property.name, variation.name);
            
            // 5. Cria o HTML completo do modal, incluindo o novo botão no rodapé
            const modalHtml = `
                <div id="analysis-content-wrapper">
                    ${analysisHtml}
                </div>
                <div class="modal-footer" style="display:flex; justify-content: flex-end; margin-top: 1rem;">
                    <button id="download-analysis-pdf-btn" class="btn-primary"><i class="fas fa-file-pdf"></i> Baixar PDF</button>
                </div>
            `;
            
            // 6. Abrimos o modal
            openModal('Análise de Financiamento', modalHtml, 'analysis', null, false);

            // 7. Adicionamos o "ouvinte" para o novo botão que acabamos de criar
            document.getElementById('download-analysis-pdf-btn').addEventListener('click', () => {
                // Pegamos o cabeçalho padrão dos documentos
                const headerPdfHtml = getDocumentHeaderHtml();
                
                // Pegamos o conteúdo da análise que está no modal
                const analysisContent = document.getElementById('analysis-content-wrapper').innerHTML;
                
                // Montamos o documento completo para o PDF
                const pdfDocHtml = `
                    <div class="pdf-document-container">
                        ${headerPdfHtml}
                        // [COLE ESTE CÓDIGO CORRIGIDO NO LUGAR]

                        <div class="pdf-content">
                            <h1>Análise de Financiamento</h1>
                            <p><strong>Cliente:</strong> ${client.name}</p>
                            <p><strong>Empreendimento:</strong> ${property.name}</p>
                            <p><strong>Variação:</strong> ${variation.name}</p>
                        </div>
// ...
                        ${analysisContent}
                    </div>
                `;
                
                // Gera o PDF
                generatePdf(pdfDocHtml, `Analise_Financiamento_${client.name.replace(/\s/g, '_')}.pdf`);
            });
        };
        // =A-FIM: FUNÇÃO DE ANÁLISE ATUALIZADA
        
        
        // =========================================================
        // INÍCIO: DETALHES DA FICHA DO IMÓVEL (PARA VIEW/PRINT)
        // =========================================================
        const getPropertyDetailsHtml = (propertyId, forClient = false) => {
            const prop = db.properties.find(p => p.id == propertyId);
            if (!prop) return '<p>Imóvel não encontrado.</p>';
          // [COLE ESTE BLOCO AQUI]
// --- INÍCIO DA ADIÇÃO: Calcular Renda Mínima ---
let startingPrice = 0;
// Encontra o menor preço entre todas as variações do imóvel
if (prop.variations && prop.variations.length > 0) {
    const prices = prop.variations.map(v => v.listPrice - (v.discount || 0));
    startingPrice = Math.min(...prices);
}

let minIncome = 0;
// Se encontrou um preço, calcula a renda mínima necessária
if (startingPrice > 0) {
    // Usa a função que já existe no seu sistema para este cálculo
    minIncome = calculateMinimumIncomeForProperty(startingPrice); 
}

// Prepara o HTML que será exibido
const minIncomeHtml = minIncome > 0 
    ? `<p><strong>Renda Mínima Estimada:</strong> <strong style="color: var(--success-color);">${formatCurrency(minIncome)}/mês</strong> (para a unidade de menor valor)</p>`
    : ''; // Se não houver preço, não mostra nada
// --- FIM DA ADIÇÃO ---

            const mainImageUrl = (prop.images && prop.mainImageIndex > -1) ? prop.images[prop.mainImageIndex] : 'https://via.placeholder.com/600x400.png?text=Sem+Foto+Principal';
            
            let amenitiesHtml = '<li>Nenhum diferencial cadastrado.</li>';
            if (prop.amenities && prop.amenities.length > 0) {
                amenitiesHtml = prop.amenities.map(amenityName => {
                    const amenityData = db.amenities.find(a => a.name === amenityName);
                    const icon = amenityData ? amenityData.icon : 'fas fa-check-square';
                    return `<div class="amenity-display-item"><i class="${icon}"></i> ${amenityName}</div>`;
                }).join('');
            }
            
            let variationsHtml = '';
            if (!prop.variations || prop.variations.length === 0) {
                variationsHtml = '<p>Nenhuma variação (unidade) cadastrada.</p>';
            } else {
                variationsHtml = `
                    <div class="table-container" style="margin-top: 1rem;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome da Variação</th>
                                    <th>Área (m²)</th>
                                    <th>Valor de Tabela</th>
                                    <th>Desconto</th>
                                    <th>Valor Final</th>
                                    ${!forClient ? '<th>Avaliação</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${prop.variations.map(v => `
                                    <tr>
                                        <td>${v.name}</td>
                                        <td>${v.area || 'N/A'} m²</td>
                                        <td>${formatCurrency(v.listPrice)}</td>
                                        <td>${formatCurrency(v.discount || 0)}</td>
                                        <td><strong>${formatCurrency(v.listPrice - (v.discount || 0))}</strong></td>
                                        ${!forClient ? `<td>${formatCurrency(v.evalPrice || 0)}</td>` : ''}
                                    </tr>
                                    <tr style="background-color: #fdfdfd;">
                                        <td colspan="${forClient ? 5 : 6}" style="font-size: 0.9rem; line-height: 1.6;">
                                            <strong>Plano Construtora:</strong> 
                                            Sinal: ${formatCurrency(v.sinal || 0)} | 
                                            Entrada: ${v.entradaParcelas || 0}x de ${formatCurrency(v.entradaValor || 0)} | 
                                            Intercaladas: ${v.intercaladasParcelas || 0}x de ${formatCurrency(v.intercaladaValor || 0)} | 
                                            Chaves: ${formatCurrency(v.chaves || 0)}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            let videoHtml = '';
            if (prop.videoLink) {
                 videoHtml = `
                    <h3>Vídeo</h3>
                    <div class="video-container">
                        <iframe src="${prop.videoLink}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
                    </div>
                `;
            }

            return `
                <img src="${mainImageUrl}" alt="${prop.name}" class="main-image" style="width: 100%; max-height: 400px; object-fit: cover; border-radius: 8px;">
                <h3 style="margin-top: 1.5rem;">${prop.name}</h3>
                <p><strong>Localização:</strong> ${prop.location}</p>
                ${minIncomeHtml} <p><strong>Descrição:</strong> ${prop.description.replace(/\n/g, '<br>') || 'N/A'}</p>
                <p><strong>Descrição:</strong> ${prop.description.replace(/\n/g, '<br>') || 'N/A'}</p>
                
                <div class="link-for-screen">
                    <p><strong>Link:</strong> <a href="${prop.link || '#'}" target="_blank">${prop.link || 'N/A'}</a></p>
                </div>
                
                <div class="qr-code-for-print">
                    <p>Acesse o link do empreendimento:</p>
                    <div id="property-qr-code-container"></div>
                </div>

                ${videoHtml}

                <h3>Diferenciais e Comodidades</h3>
                <div class="amenities-display-grid">
                    ${amenitiesHtml}
                </div>

                <h3>Variações e Preços</h3>
                ${variationsHtml}
            `;
        };

        // Função para gerar o QR Code no local certo (usado na impressão)
        const generateQrCodeForPrint = (url) => {
            const container = document.getElementById('property-qr-code-container');
            if (container && url) {
                container.innerHTML = ''; // Limpa o anterior
                try {
                    new QRCode(container, {
                        text: url,
                        width: 100,
                        height: 100,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                } catch(e) {
                    console.error("Erro ao gerar QR Code:", e);
                    container.innerHTML = "<p>Erro ao gerar QR Code.</p>";
                }
            } else if (container) {
                container.innerHTML = "<p>Link não disponível.</p>";
            }
        };
        // =A-FIM: DETALHES DA FICHA DO IMÓVEL (PARA VIEW/PRINT)


        // =========================================================
        // INÍCIO: DETALHES DA FICHA DO CLIENTE (PARA VIEW/PRINT)
        // =========================================================
        const getClientDetailsHtml = (clientId) => {
            const client = db.clients.find(c => c.id == clientId);
            if (!client) return '<p>Cliente não encontrado.</p>';

            const stage = db.funnelStages.find(s => s.id === client.stageId);
            const source = client.leadSource ? (client.leadSource.charAt(0).toUpperCase() + client.leadSource.slice(1)) : 'N/A';
            const totalIncome = (client.income || 0) + (client.spouseComposesIncome ? (client.spouseIncome || 0) : 0);

            let propertyHtml = '<p><strong>Imóvel de Interesse:</strong> Nenhum selecionado.</p>';
            let property = null;
            let variation = null;
            let analysisHtml = '';

            if (client.propertyId && client.variationId) {
                property = db.properties.find(p => p.id == client.propertyId);
                if (property) {
                    variation = property.variations.find(v => v.id == client.variationId);
                }
                
                if (property && variation) {
                    const finalPrice = variation.listPrice - (variation.discount || 0);
                    propertyHtml = `
                        <p><strong>Empreendimento:</strong> ${property.name}</p>
                        <p><strong>Variação de Interesse:</strong> ${variation.name}</p>
                        <p><strong>Valor da Variação:</strong> ${formatCurrency(finalPrice)}</p>
                    `;
                    
                    // Roda a análise de financiamento para a ficha
                    const analysis = calculateFinancing(client, variation, property);
                    analysisHtml = getFinancingAnalysisHtml(analysis, client.name, property.name, variation.name);

                } else {
                     propertyHtml = '<p><strong>Imóvel de Interesse:</strong> Erro ao carregar (Imóvel ou Variação não encontrados).</p>';
                }
            }

            return `
                <h3>Dados Pessoais</h3>
                <p><strong>Nome:</strong> ${client.name}</p>
                <p><strong>Contato:</strong> ${client.phone} | <strong>E-mail:</strong> ${client.email || 'N/A'}</p>
                <p><strong>CPF:</strong> ${client.cpf || 'N/A'} | <strong>Nascimento:</strong> ${formatDate(client.birthdate)}</p>

                <h3>Perfil de Venda</h3>
                <p><strong>Etapa do Funil:</strong> ${stage ? stage.name : 'N/A'}</p>
                <p><strong>Origem do Lead:</strong> ${source}</p>

                <h3>Perfil Financeiro (Titular)</h3>
                <p><strong>Renda:</strong> ${formatCurrency(client.income || 0)}</p>
                <p><strong>+3 Anos de Carteira Assinada?</strong> ${client.hasFormalWork ? 'Sim' : 'Não'}</p>
                <p><strong>Já Possui Imóvel?</strong> ${client.alreadyOwnsProperty ? 'Sim' : 'Não'}</p>
                
                ${client.spouseName ? `
                    <h3>Perfil Financeiro (Cônjuge)</h3>
                    <p><strong>Nome:</strong> ${client.spouseName}</p>
                    <p><strong>CPF:</strong> ${client.spouseCpf || 'N/A'} | <strong>Nascimento:</strong> ${formatDate(client.spouseBirthdate)}</p>
                    <p><strong>Renda:</strong> ${formatCurrency(client.spouseIncome || 0)}</p>
                    <p><strong>Compõe Renda?</strong> ${client.spouseComposesIncome ? 'Sim' : 'Não'}</p>
                ` : ''}
                
                <hr style="margin: 1.5rem 0;">
                
                <h3>Imóvel de Interesse e Análise</h3>
                ${propertyHtml}
                <p><strong>Renda Total Considerada:</strong> ${formatCurrency(totalIncome)}</p>
                
                <div class="report-section" style="margin-top: 1rem;">
                    ${analysisHtml}
                </div>

                <h3>Observações</h3>
                <p>${client.notes ? client.notes.replace(/\n/g, '<br>') : 'Nenhuma observação.'}</p>
            `;
        };
        // =A-FIM: DETALHES DA FICHA DO CLIENTE (PARA VIEW/PRINT)


        // ==========================================
        // GESTÃO DE RELATÓRIOS DE PLANTÃO
        // ==========================================
        const getDutyReportFormHtml = (report = {}) => {
            // Se estiver editando, recria a lista de clientes atendidos
            let attendedClientsHtml = '';
            if (report.attendedClients && report.attendedClients.length > 0) {
                attendedClientsHtml = report.attendedClients.map(client => getAttendedClientRowHtml(client)).join('');
            }

            return `
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label for="duty-date">Data do Plantão</label>
                        <input type="date" id="duty-date" value="${report.date || new Date().toISOString().slice(0, 10)}">
                    </div>
                    <div class="form-group">
                        <label for="duty-location">Local/Empreendimento</label>
                        <input type="text" id="duty-location" value="${report.location || ''}" placeholder="Ex: Stand do Gran Via">
                    </div>
                </div>
                
                <h3 class="form-section-title">Clientes Atendidos</h3>
                <div id="attended-clients-list">
                    ${attendedClientsHtml}
                </div>
                <button type="button" id="add-attended-client-btn" class="btn-secondary"><i class="fas fa-plus"></i> Adicionar Cliente Atendido</button>
                
                <div class="form-group full-width" style="margin-top: 1.5rem;">
                    <label for="duty-summary">Resumo do Plantão e Observações</label>
                    <textarea id="duty-summary" rows="5" placeholder="Descreva o movimento, ocorrências, etc.">${report.summary || ''}</textarea>
                </div>
            `;
        };

        const getAttendedClientRowHtml = (client = {}) => {
    const clientId = client.id || `temp_${Date.now()}`; // ID da *linha* do relatório
    const selectedClientId = client.clientId || ''; // ID do *cliente* do db

    // Ordena os clientes por nome para o dropdown
    const clientOptions = db.clients
        .sort((a, b) => a.name.localeCompare(b.name))
        .map(c => 
        `<option value="${c.id}" ${selectedClientId == c.id ? 'selected' : ''}>${c.name}</option>`
    ).join('');

    return `
        <div class="attended-client-item" data-id="${clientId}" data-selected-client-id="${selectedClientId}" style="grid-template-columns: 1fr 1fr auto; align-items: end; gap: 0.8rem;">

            <div class="form-group" style="grid-column: 1 / -1;"> {/* Linha inteira de cima */}
                <label>Selecionar Cliente Existente (Opcional)</label>
                <select class="attended-client-select">
                    <option value="">-- Novo Cliente (digite abaixo) --</option>
                    ${clientOptions}
                </select>
            </div>

            <div class="form-group">
                <label>Nome do Cliente</label>
                <input type="text" class="attended-client-name" value="${client.name || ''}" placeholder="Nome do Cliente">
            </div>
            <div class="form-group">
                <label>Contato (Telefone)</label>
                <input type="text" class="attended-client-phone" value="${client.phone || ''}" placeholder="Contato (Telefone)">
            </div>

            <button type="button" class="btn-danger remove-attended-client-btn"><i class="fas fa-trash"></i></button>

            <div class="form-group" style="grid-column: 1 / -1; margin-top: 0.5rem;">
                <label>Observação sobre este cliente</label>
                <textarea class="attended-client-obs" rows="2" placeholder="Descreva o que o cliente procurou, se agendou visita, etc...">${client.obs || ''}</textarea>
            </div>
        </div>
    `;
};

        const addAttendedClientRow = () => {
            document.getElementById('attended-clients-list').insertAdjacentHTML('beforeend', getAttendedClientRowHtml());
        };

        const handleAttendedClientActions = (e) => {
            const removeBtn = e.target.closest('.remove-attended-client-btn');
            if (removeBtn) {
                removeBtn.closest('.attended-client-item').remove();
            }

            // --- INÍCIO DA NOVA LÓGICA ---
            // Detecta a mudança no <select> que acabamos de adicionar
            if (e.target.classList.contains('attended-client-select')) {
                const select = e.target;
                const selectedClientId = select.value;
                const row = select.closest('.attended-client-item');
                
                if (selectedClientId) {
                    // Se um cliente foi selecionado, busca ele no banco de dados
                    const client = db.clients.find(c => c.id == selectedClientId);
                    if (client) {
                        // Preenche os campos de nome e telefone
                        row.querySelector('.attended-client-name').value = client.name;
                        row.querySelector('.attended-client-phone').value = client.phone;
                        // Armazena o ID do cliente na própria linha
                        row.dataset.selectedClientId = client.id;
                    }
                } else {
                    // Se o usuário selecionou "Novo Cliente", limpa os campos
                    row.querySelector('.attended-client-name').value = '';
                    row.querySelector('.attended-client-phone').value = '';
                    row.dataset.selectedClientId = ''; // Limpa o ID
                }
            }
            // --- FIM DA NOVA LÓGICA ---
        };

        document.getElementById('add-duty-report-btn').addEventListener('click', () => {
            openModal('Novo Relatório de Plantão', getDutyReportFormHtml(), 'dutyReport');
        });

        const renderDutyReportsTable = (filter = '') => {
            const tbody = document.querySelector('#duty-reports-table tbody');
            tbody.innerHTML = '';
            
            const filtered = db.dutyReports.filter(r => 
                (r.location || '').toLowerCase().includes(filter.toLowerCase())
            );

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Nenhum relatório encontrado.</td></tr>';
                return;
            }

            // Ordena por data, do mais recente para o mais antigo
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            filtered.forEach(report => {
                const attendedCount = report.attendedClients?.length || 0;
                tbody.innerHTML += `
                    <tr>
                        <td>${formatDate(report.date)}</td>
                        <td>${report.location}</td>
                        <td>${attendedCount} cliente(s)</td>
                        <td class="action-buttons">
                            <button title="Visualizar/Imprimir" data-action="view" data-id="${report.id}"><i class="fas fa-eye"></i></button>
                            <button title="Editar" data-action="edit" data-id="${report.id}"><i class="fas fa-edit"></i></button>
                            <button title="Excluir" data-action="delete" data-id="${report.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        };

        const getDutyReportDetailsHtml = (reportId) => {
            const report = db.dutyReports.find(r => r.id == reportId);
            if (!report) return '<p>Relatório não encontrado.</p>';

            let clientsTableHtml = '<p>Nenhum cliente foi registrado neste plantão.</p>';
            if (report.attendedClients && report.attendedClients.length > 0) {
                clientsTableHtml = `
                    <table class="pdf-duty-report-table">
                        <thead>
                            <tr>
                                <th>Nome do Cliente</th>
                                <th>Contato</th>
                                <th>Observação</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${report.attendedClients.map(client => `
                               <tr>
                                    <td>
                                        ${client.clientId ? 
                                            // Se tiver um ID, cria um link
                                            `<a href="#" class="view-client-from-report" data-client-id="${client.clientId}" style="color: var(--accent-color); text-decoration: underline;">${client.name}</a>` :
                                            // Senão, só mostra o nome
                                            client.name
                                        }
                                    </td>
                                    <td>${client.phone}</td>
                                    <td>${client.obs}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            return `
                <div class="pdf-content">
                    <h2>Resumo do Plantão</h2>
                    <p><strong>Data:</strong> ${formatDate(report.date)}</p>
                    <p><strong>Local:</strong> ${report.location}</p>
                    <p><strong>Resumo/Observações:</strong></p>
                    <p>${report.summary ? report.summary.replace(/\n/g, '<br>') : 'N/A'}</p>

                    <h2>Clientes Atendidos</h2>
                    ${clientsTableHtml}
                </div>
            `;
        };

        document.querySelector('#duty-reports-table tbody').addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.dataset.id;
            const action = button.dataset.action;

            if (action === 'edit') {
                const report = db.dutyReports.find(r => r.id == id);
                openModal('Editar Relatório de Plantão', getDutyReportFormHtml(report), 'dutyReport', id);
            } else if (action === 'delete') {
                if (confirm('Deseja realmente excluir este relatório?')) {
                    db.dutyReports = db.dutyReports.filter(r => r.id != id);
                    saveData();
                    renderDutyReportsTable();
                }
            } else if (action === 'view') {
                const report = db.dutyReports.find(r => r.id == id);
                const reportHtml = getDutyReportDetailsHtml(id);
                const title = `Relatório de Plantão - ${report.location} - ${formatDate(report.date)}`;
                
                const modalBodyHtml = `
                    <div class="record-details">${reportHtml}</div>
                    <div class="modal-footer" style="display:flex; justify-content: flex-end; margin-top: 1rem;">
                        <button class="btn-primary" id="print-modal-btn"><i class="fas fa-print"></i> Imprimir</button>
                    </div>`;
                 openModal(title, modalBodyHtml, 'view', null, false);
                 
                 document.getElementById('print-modal-btn').addEventListener('click', () => {
                // const headerPdfHtml = getDocumentHeaderHtml(); // LINHA APAGADA
                const fullPrintHtml = `
                    <div class="pdf-document-container">
                        <h1>Relatório de Plantão</h1>
                        ${reportHtml}
                    </div>`;
                printContent(fullPrintHtml, title);
             });
            }
        });
        
        // ==========================================
        // GESTÃO DE INFORMES E NOTAS (KNOWLEDGE BASE)
        // ==========================================
        const getKnowledgeFormHtml = (note = {}) => {
            tempNoteImages = note.images ? [...note.images] : [];
            
            return `
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="note-title">Título</label>
                        <input type="text" id="note-title" value="${note.title || ''}" placeholder="Ex: Regras do Financiamento Caixa 2025">
                    </div>
                    <div class="form-group full-width">
                        <label for="note-content">Conteúdo da Nota</label>
                        <textarea id="note-content" rows="8" placeholder="Digite ou cole o conteúdo aqui...">${note.content || ''}</textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="note-video-links">Links de Vídeo (YouTube, Vimeo) - um por linha</label>
                        <textarea id="note-video-links" rows="3">${(note.videos || []).join('\n')}</textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="note-images">Imagens (Prints, etc.)</label>
                        <input type="file" id="note-images" multiple accept="image/*">
                        <div id="note-image-previews"></div>
                    </div>
                </div>
            `;
        };

        const renderNotePreviews = () => {
            const container = document.getElementById('note-image-previews');
            if (!container) return;
            container.innerHTML = tempNoteImages.map((imgData, index) => `
                <div class="img-preview-container">
                    <img src="${imgData}" alt="Pré-visualização ${index + 1}">
                    <button class="remove-img-btn" data-index="${index}">&times;</button>
                </div>
            `).join('');
        };

        const handleNoteImageSelection = (event) => {
            const files = event.target.files;
            if (!files) return;

            const imagePromises = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                imagePromises.push(new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result); // Para notas, não precisamos de compressão agressiva
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                }));
            }

            Promise.all(imagePromises).then(images => {
                tempNoteImages = [...tempNoteImages, ...images];
                renderNotePreviews();
            }).catch(error => {
                console.error("Erro ao carregar imagens da nota:", error);
                alert("Ocorreu um erro ao carregar as imagens.");
            });
        };

        const handleNoteImagePreviewActions = (event) => {
            if (event.target.classList.contains('remove-img-btn')) {
                const index = parseInt(event.target.dataset.index, 10);
                tempNoteImages.splice(index, 1);
                renderNotePreviews();
            }
        };

        document.getElementById('add-info-btn').addEventListener('click', () => {
            openModal('Nova Informação / Nota', getKnowledgeFormHtml(), 'knowledgeBase');
            renderNotePreviews();
        });
        
        const renderKnowledgeBase = (filter = '') => {
            const container = document.getElementById('info-cards-container');
            container.innerHTML = '';
            
            const lowerFilter = filter.toLowerCase();
            const filtered = db.knowledgeBase.filter(note => 
                (note.title || '').toLowerCase().includes(lowerFilter) ||
                (note.content || '').toLowerCase().includes(lowerFilter)
            );

            if (filtered.length === 0) {
                container.innerHTML = '<p>Nenhuma nota ou informe encontrado.</p>';
                return;
            }

            // Ordena por data de modificação, mais recente primeiro
            filtered.sort((a, b) => (b.lastModified || 0) - (a.lastModified || 0));

            filtered.forEach(note => {
                const firstImage = (note.images && note.images.length > 0) ? note.images[0] : 'https://via.placeholder.com/150x150.png?text=Nota';
                container.innerHTML += `
                    <div class="info-card">
                        <div class="info-card-header">
                            <img src="${firstImage}" alt="Thumbnail da nota" class="info-card-thumb">
                            <div class="info-card-title-section">
                                <h3>${note.title}</h3>
                                <small>Atualizado em: ${note.lastModified ? new Date(note.lastModified).toLocaleString('pt-BR') : 'N/A'}</small>
                            </div>
                        </div>
                        <div class="info-card-content">
                            ${note.content ? note.content.substring(0, 250).replace(/\n/g, '<br>') : ''}
                        </div>
                        <div class="info-card-footer">
                            <button title="Visualizar" data-action="view" data-id="${note.id}"><i class="fas fa-eye"></i></button>
                            <button title="Editar" data-action="edit" data-id="${note.id}"><i class="fas fa-edit"></i></button>
                            <button title="Excluir" data-action="delete" data-id="${note.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        };

        document.getElementById('info-search').addEventListener('input', e => renderKnowledgeBase(e.target.value));

        const getKnowledgeViewHtml = (noteId) => {
            const note = db.knowledgeBase.find(n => n.id == noteId);
            if (!note) return '<p>Nota não encontrada.</p>';

            let galleryHtml = '';
            if (note.images && note.images.length > 0) {
                galleryHtml = '<div class="view-note-gallery">';
                galleryHtml += note.images.map((img, index) => 
                    `<img src="${img}" alt="Imagem ${index+1}" data-action="open-gallery" data-index="${index}">`
                ).join('');
                galleryHtml += '</div>';
            }
            
            let videosHtml = '';
            if (note.videos && note.videos.length > 0) {
                videosHtml = '<h3>Vídeos</h3>';
                videosHtml += note.videos.map(videoUrl => {
                    const embedUrl = getEmbedVideoUrl(videoUrl); // Reutiliza a função de embed
                    if (embedUrl) {
                        return `
                            <div class="video-container" style="margin-bottom: 1rem;">
                                <iframe src="${embedUrl}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
                            </div>`;
                    }
                    return `<p><a href="${videoUrl}" target="_blank">${videoUrl}</a></p>`;
                }).join('');
            }

            return `
                <div class="record-details" data-note-id="${note.id}">
                    <p style="font-size: 0.9rem; color: #555;">Atualizado em: ${note.lastModified ? new Date(note.lastModified).toLocaleString('pt-BR') : 'N/A'}</p>
                    <div class="report-section">
                        <h3>Conteúdo</h3>
                        <p>${note.content ? note.content.replace(/\n/g, '<br>') : 'N/A'}</p>
                    </div>
                    
                    ${videosHtml}
                    
                    <h3>Imagens</h3>
                    ${galleryHtml || '<p>Nenhuma imagem anexada.</p>'}
                </div>
            `;
        };

        document.getElementById('info-cards-container').addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.closest('.info-card').querySelector('button[data-id]').dataset.id;
            const action = button.dataset.action;

            if (action === 'edit') {
                const note = db.knowledgeBase.find(n => n.id == id);
                openModal('Editar Nota', getKnowledgeFormHtml(note), 'knowledgeBase', id);
                renderNotePreviews();
            } else if (action === 'delete') {
                if (confirm('Deseja realmente excluir esta nota?')) {
                    db.knowledgeBase = db.knowledgeBase.filter(n => n.id != id);
                    saveData();
                    renderKnowledgeBase(document.getElementById('info-search').value);
                }
            } else if (action === 'view') {
                const note = db.knowledgeBase.find(n => n.id == id);
                const viewHtml = getKnowledgeViewHtml(id);
                openModal(`Nota: ${note.title}`, viewHtml, 'view-note', null, false);
            }
        });
        
        // Ouvinte para abrir a galeria de dentro do modal da nota
        modalBody.addEventListener('click', e => {
            if (currentEntityType === 'view-note') {
                const img = e.target.closest('img[data-action="open-gallery"]');
                if (img) {
                    const noteId = img.closest('.record-details').dataset.noteId;
                    const startIndex = parseInt(img.dataset.index, 10);
                    openImageGallery({ entity: 'note', id: noteId, startIndex: startIndex });
                }
            }
        });
// ==========================================
        // INÍCIO: NOVO CÓDIGO (Passo 7)
        // ==========================================
        // Adiciona o listener para o link do cliente no relatório de plantão
        modalBody.addEventListener('click', e => {
            const clientLink = e.target.closest('a.view-client-from-report');
            if (clientLink) {
                e.preventDefault(); // Impede o link de navegar
                const clientId = clientLink.dataset.clientId;
                const client = db.clients.find(c => c.id == clientId);
                
                if (client) {
                    // Fecha o modal atual (Relatório)
                    closeModal();
                    // Muda para a aba de clientes
                    switchPanel('clients');
                    
                    // Abre a ficha do cliente (reutilizando a lógica)
                    const clientHtml = getClientDetailsHtml(clientId);
                    const modalBodyHtml = `
                        <div class="record-details" data-client-id="${clientId}">${clientHtml}</div>
                        <div class="modal-footer" style="display:flex; justify-content: flex-end; margin-top: 1rem;">
                            <button class="btn-primary" id="print-modal-btn"><i class="fas fa-print"></i> Imprimir</button>
                        </div>`;
                    openModal(`Ficha de ${client.name}`, modalBodyHtml, 'view', null, false);
                    document.getElementById('print-modal-btn').addEventListener('click', () => {
                        printContent(clientHtml, `Ficha do Cliente: ${client.name}`);
                    });
                } else {
                    alert('Erro: Cliente não encontrado.');
                }
            }
        });

        // ==========================================
        // GESTÃO FINANCEIRA
        // ==========================================
        const getFinancialFormHtml = (record = {}, type = 'income') => {
            const isEditing = !!record.id;
            const title = type === 'income' ? 'Nova Receita' : 'Nova Despesa';
            if (isEditing) title = 'Editar Lançamento';
            
            const isRecurring = record.recurrence === 'monthly';
            const isRealized = record.status === 'paid'; // Se já foi pago/recebido

            return `
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="fin-description">Descrição</label>
                        <input type="text" id="fin-description" value="${record.description || ''}">
                    </div>
                    
                    <div class="form-group">
                        <label for="fin-value">Valor (R$)</label>
                        <input type="number" id="fin-value" value="${record.value || ''}">
                    </div>
                    
                    <div class="form-group">
                        <label for="fin-category">Categoria</label>
                        <input type="text" id="fin-category" value="${record.category || ''}" placeholder="Ex: Comissão, Marketing, Gasolina">
                    </div>

                    <div class="form-group full-width" style="background: #f8f9fa; padding: 1rem; border-radius: 5px;">
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="fin-date">Data da ${isRecurring ? 'Primeira Parcela' : 'Ocorrência'}</label>
                                <input type="date" id="fin-date" value="${record.startDate || new Date().toISOString().slice(0, 10)}">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="fin-status">Status</label>
                                <select id="fin-status">
                                    <option value="pending" ${record.status !== 'paid' ? 'selected' : ''}>Pendente (A Pagar / A Receber)</option>
                                    <option value="paid" ${record.status === 'paid' ? 'selected' : ''}>Realizado (Pago / Recebido)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <input type="checkbox" id="fin-recurring" ${isRecurring ? 'checked' : ''} style="width: auto; flex-grow: 0; margin-right: 10px;">
                        <label for="fin-recurring" style="margin: 0; font-weight: bold;">Este é um lançamento recorrente mensal? (Ex: Aluguel, Financiamento)</label>
                    </div>

                    <input type="hidden" id="fin-type" value="${record.type || type}">
                </div>
            `;
        };
        
        const getPaymentManagementHtml = (recordId) => {
            const record = db.financialRecords.find(r => r.id == recordId);
            if (!record) return '<p>Lançamento não encontrado.</p>';

            const today = new Date().toISOString().slice(0, 10);
            
            let html = `
                <p><strong>Descrição:</strong> ${record.description}</p>
                <p><strong>Valor por Parcela:</strong> ${formatCurrency(record.value)}</p>
                <div class="payment-status-section">
                    <h3>Status das Parcelas</h3>
                    <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                        <table>
                            <thead><tr><th>Data</th><th>Status</th><th>Ação</th></tr></thead>
                            <tbody>
            `;
            
            let upcomingPaymentFound = false;
            
            record.payments.forEach((payment, index) => {
                const isOverdue = payment.status === 'pending' && payment.date < today;
                
                let statusHtml = '';
                let actionHtml = '';

                if (payment.status === 'paid') {
                    statusHtml = '<strong style="color: var(--success-color);">Realizado</strong>';
                    actionHtml = `<button class="btn-link" data-action="toggle-payment" data-index="${index}">Marcar como Pendente</button>`;
                } else {
                    // É pendente
                    statusHtml = isOverdue ? '<strong style="color: var(--danger-color);">Vencido</strong>' : 'Pendente';
                    actionHtml = `<button class="btn-success" data-action="toggle-payment" data-index="${index}">Marcar como Realizado</button>`;
                }
                
                html += `
                    <tr style="${isOverdue ? 'background-color: #ffebee;' : ''}">
                        <td>${formatDate(payment.date)}</td>
                        <td>${statusHtml}</td>
                        <td class="action-buttons">${actionHtml}</td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            return html;
        };
        
        modalBody.addEventListener('click', e => {
            if (currentEntityType !== 'financialRecord' && currentEntityType !== 'paymentManager') return;

            const button = e.target.closest('button[data-action="toggle-payment"]');
            if (!button) return;

            const record = db.financialRecords.find(r => r.id == currentEditingId);
            if (!record) return;

            const index = parseInt(button.dataset.index, 10);
            const payment = record.payments[index];

            if (payment.status === 'pending') {
                payment.status = 'paid';
            } else {
                payment.status = 'pending';
            }

            saveData();
            // Re-renderiza o conteúdo do modal
            const newHtml = getPaymentManagementHtml(currentEditingId);
            modalBody.innerHTML = newHtml;
        });


        document.getElementById('add-income-btn').addEventListener('click', () => {
            openModal('Nova Receita', getFinancialFormHtml({}, 'income'), 'financialRecord');
        });
        document.getElementById('add-expense-btn').addEventListener('click', () => {
            openModal('Nova Despesa', getFinancialFormHtml({}, 'expense'), 'financialRecord');
        });

        const renderFinancialBI = () => {
            let realizedRevenue = 0;
            let realizedExpense = 0;
            let futureRevenue = 0;
            let futureExpense = 0;
            
            const today = new Date();
            const todayStr = today.toISOString().slice(0, 10);
            const next30Days = new Date(today.setDate(today.getDate() + 30)).toISOString().slice(0, 10);

            db.financialRecords.forEach(record => {
                record.payments.forEach(payment => {
                    if (payment.status === 'paid') {
                        if (record.type === 'income') {
                            realizedRevenue += record.value;
                        } else {
                            realizedExpense += record.value;
                        }
                    } else {
                        // Pendente
                        if (payment.date >= todayStr && payment.date <= next30Days) {
                             if (record.type === 'income') {
                                futureRevenue += record.value;
                            } else {
                                futureExpense += record.value;
                            }
                        }
                    }
                });
            });

            const balance = realizedRevenue - realizedExpense;

            document.getElementById('bi-realized-revenue').textContent = formatCurrency(realizedRevenue);
            document.getElementById('bi-realized-expense').textContent = formatCurrency(realizedExpense);
            document.getElementById('bi-balance').textContent = formatCurrency(balance);
            document.getElementById('bi-future-revenue').textContent = `+ ${formatCurrency(futureRevenue)}`;
            document.getElementById('bi-future-expense').textContent = `- ${formatCurrency(futureExpense)}`;
            
            document.getElementById('bi-balance').className = balance >= 0 ? 'financial-amount success' : 'financial-amount danger';
        };

        const renderFinancialRecordsTable = (filter = '') => {
    const tbody = document.querySelector('#financial-records-table tbody');
    tbody.innerHTML = '';

    // 1. Filtra os registros com base no ESTADO (All ou Upcoming)
    let baseRecords = [...db.financialRecords];

    if (financialFilterState === 'upcoming') {
        const today = new Date();
        const todayStr = today.toISOString().slice(0, 10);
        // Precisamos resetar 'today' pois setDate() modifica o objeto
        const next30DaysDate = new Date(); 
        const next30Days = new Date(next30DaysDate.setDate(next30DaysDate.getDate() + 30)).toISOString().slice(0, 10);

        baseRecords = db.financialRecords.filter(record => {
            // Verifica se *existe* alguma parcela pendente nos próximos 30 dias
            return record.payments.some(p => 
                p.status === 'pending' && 
                p.date >= todayStr && 
                p.date <= next30Days
            );
        });
    }

    // 2. Ordena os registros (se for 'upcoming', ordena pela data da próxima parcela)
    const sortedRecords = baseRecords.sort((a, b) => {
        if (financialFilterState === 'upcoming') {
            const todayStr = new Date().toISOString().slice(0, 10);
            const next30Days = new Date(new Date().setDate(new Date().getDate() + 30)).toISOString().slice(0, 10);

            const nextPaymentA = a.payments.find(p => p.status === 'pending' && p.date >= todayStr && p.date <= next30Days);
            const nextPaymentB = b.payments.find(p => p.status === 'pending' && p.date >= todayStr && p.date <= next30Days);

            return new Date(nextPaymentA.date) - new Date(nextPaymentB.date);
        }
        // Ordenação padrão
        return new Date(b.startDate) - new Date(a.startDate);
    });

    // 3. Aplica o filtro de BUSCA (como antes)
    const lowerFilter = filter.toLowerCase();
    const filteredRecords = sortedRecords.filter(record =>
        (record.description || '').toLowerCase().includes(lowerFilter) ||
        (record.category || '').toLowerCase().includes(lowerFilter)
    );

    // 4. Verifica se o resultado filtrado está vazio
    if (filteredRecords.length === 0) {
        if (financialFilterState === 'upcoming' && baseRecords.length === 0) {
             tbody.innerHTML = '<tr><td colspan="6">Nenhum lançamento a vencer nos próximos 30 dias.</td></tr>';
        } else if (db.financialRecords.length > 0 && filter) {
            tbody.innerHTML = '<tr><td colspan="6">Nenhum lançamento encontrado para a busca: "' + filter + '"</td></tr>';
        } else if (db.financialRecords.length === 0) {
             tbody.innerHTML = '<tr><td colspan="6">Nenhum lançamento financeiro.</td></tr>';
        } else if (financialFilterState === 'upcoming' && filteredRecords.length === 0) {
             tbody.innerHTML = '<tr><td colspan="6">Nenhum lançamento "A Vencer" corresponde à busca.</td></tr>';
        } else {
             tbody.innerHTML = '<tr><td colspan="6">Nenhum lançamento encontrado.</td></tr>';
        }
        return;
    }

    // 5. Desenha a tabela
    filteredRecords.forEach(record => {
        const typeClass = record.type === 'income' ? 'success' : 'danger';
        const typeText = record.type === 'income' ? 'Receita' : 'Despesa';

        const today = new Date().toISOString().slice(0, 10);
        const firstPayment = record.payments[0];
        const todayPayment = record.payments.find(p => p.date === today);

        // --- LÓGICA DE EXIBIÇÃO DA PARCELA ---
        let displayPayment;
        if (financialFilterState === 'upcoming') {
            // Se o filtro é 'upcoming', *devemos* mostrar a próxima parcela a vencer
            const todayDate = new Date();
            const todayStr = todayDate.toISOString().slice(0, 10);
            const next30DaysDate = new Date();
            const next30Days = new Date(next30DaysDate.setDate(next30DaysDate.getDate() + 30)).toISOString().slice(0, 10);

            // Encontra a primeira parcela pendente dentro da janela de 30 dias
            displayPayment = record.payments.find(p => 
                p.status === 'pending' && 
                p.date >= todayStr && 
                p.date <= next30Days
            );

            // Fallback (caso algo dê errado, improvável)
            if (!displayPayment) displayPayment = todayPayment || firstPayment;

        } else {
            // Lógica padrão
            displayPayment = todayPayment || firstPayment;
        }
        // --- FIM DA LÓGICA DE EXIBIÇÃO ---

        let statusHtml = '';
        if (displayPayment.status === 'paid') {
            statusHtml = `<span class="status-realizado">Realizado</span>`;
        } else if (displayPayment.date < today) {
            statusHtml = `<strong style="color: var(--danger-color);">Vencido</strong>`;
        } else {
            statusHtml = `Pendente`;
        }

        tbody.innerHTML += `
            <tr>
                <td>${formatDate(displayPayment.date)} ${record.recurrence === 'monthly' ? '<i class="fas fa-sync-alt" title="Recorrente"></i>' : ''}</td>
                <td>${record.description}</td>
                <td>${record.category}</td>
                <td><strong style="color: var(--${typeClass}-color);">${typeText}</strong></td>
                <td>${formatCurrency(record.value)} ${record.recurrence === 'monthly' ? '/mês' : ''}</td>
                <td class="action-buttons">
                    ${record.recurrence === 'monthly' ? `<button title="Gerenciar Parcelas" data-action="manage" data-id="${record.id}"><i class="fas fa-calendar-check"></i></button>` : ''}
                    <button title="Editar" data-action="edit" data-id="${record.id}"><i class="fas fa-edit"></i></button>
                    <button title="Excluir" data-action="delete" data-id="${record.id}"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `;
    });
};
        
document.querySelector('#financial-records-table tbody').addEventListener('click', e => {
    // 1. Encontra o botão exato que foi clicado (ou o ícone dentro dele)
    const button = e.target.closest('button');
// 2. Se o clique não foi em um botão, ignora.
if (!button) return;
// 3. Pega a 'action' e o 'id' DO BOTÃO QUE FOI CLICADO.
//    Esta é a correção principal.
const action = button.dataset.action;
const id = button.dataset.id;
// 4. Se o botão clicado não tiver um ID (como um botão 'fechar' de modal, etc.), ignora.
if (!id) return;
// 5. Encontra o registro financeiro correspondente
const record = db.financialRecords.find(r => r.id == id);
// 6. Se, por algum motivo, não encontrar o registro, avisa no console.
if (!record) {
    console.error("Erro: Registro financeiro não encontrado com o ID:", id);
    return;
}
// 7. Executa a ação correta
if (action === 'edit') {
    // Abre o modal de edição
    openModal('Editar Lançamento', getFinancialFormHtml(record), 'financialRecord', id);
// ...
} else if (action === 'delete') {
    if (confirm(`Deseja realmente excluir o lançamento "${record.description}" e todas as suas parcelas?`)) {
        db.financialRecords = db.financialRecords.filter(r => r.id != id);
        saveData();
        renderFinancialBI();
        renderFinancialRecordsTable(document.getElementById('financial-search')?.value || '');
    } // <-- ADICIONE ESTA CHAVE } AQUI
} else if (action === 'manage') { // <-- AGORA ESTÁ CORRETO
    // Abre o gerenciador de parcelas
    const manageHtml = getPaymentManagementHtml(id);
    openModal(`Gerenciar Parcelas: ${record.description}`, manageHtml, 'paymentManager', id, false);
}
});
        
        // ==========================================
        // GESTÃO DE DOCUMENTOS (CONTRATOS, RECIBOS)
        // ==========================================
        const getDocumentHeaderHtml = (isPrintable = false) => {
            const className = isPrintable ? 'printable-header' : 'pdf-header';
            const logoClass = isPrintable ? 'printable-header-logo' : 'pdf-header-logo';
            const infoClass = isPrintable ? 'printable-header-info' : 'pdf-header-info';
            return `
                <div class="${className}">
                    <img src="${db.settings.logoUrl}" alt="Logo" class="${logoClass}">
                    <div class="${infoClass}">
                        <h1>${db.settings.brokerName}</h1>
                        <p>${db.settings.brokerCreci}</p>
                        <p>Telefone: ${db.settings.brokerPhone}</p>
                    </div>
                </div>
            `;
        };
        
        const getReceiptFormHtml = () => {
            const clientOptions = db.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            // Apenas propriedades que tenham variações
            const propertyOptions = db.properties
                .filter(p => p.variations && p.variations.length > 0)
                .map(p => `<option value="${p.id}">${p.name}</option>`).join('');

            return `
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="doc-client-id">Pagador (Cliente)</label>
                        <select id="doc-client-id">${clientOptions}</select>
                    </div>
                    <div class="form-group">
                        <label for="doc-value">Valor Recebido (R$)</label>
                        <input type="number" id="doc-value" placeholder="Ex: 5000.00">
                    </div>
                    <div class="form-group">
                        <label for="doc-date">Data do Recebimento</label>
                        <input type="date" id="doc-date" value="${new Date().toISOString().slice(0, 10)}">
                    </div>
                    <div class="form-group full-width">
                        <label for="doc-referente">Referente a</label>
                        <input type="text" id="doc-referente" placeholder="Ex: Sinal de pagamento do Apto 101">
                    </div>
                    <div class="form-group">
                        <label for="doc-prop-id">Empreendimento (Opcional)</label>
                        <select id="doc-prop-id"><option value="">Nenhum</option>${propertyOptions}</select>
                    </div>
                    <div class="form-group">
                        <label for="doc-var-id">Variação (Opcional)</label>
                        <select id="doc-var-id" disabled><option value="">Selecione o empreendimento</option></select>
                    </div>
                </div>
            `;
        };
        
        // Listener para o dropdown de recibos (igual ao de clientes)
        modalBody.addEventListener('change', e => {
            if (currentEntityType === 'receipt' && e.target.id === 'doc-prop-id') {
                const propSelect = e.target;
                const variationSelect = document.getElementById('doc-var-id');
                const propId = propSelect.value;
                
                variationSelect.innerHTML = '<option value="">Selecione a variação...</option>';
                variationSelect.disabled = true;

                if (propId) {
                    const prop = db.properties.find(p => p.id == propId);
                    if (prop && prop.variations && prop.variations.length > 0) {
                        prop.variations.forEach(v => {
                            const finalPrice = v.listPrice - (v.discount || 0);
                            variationSelect.innerHTML += `<option value="${v.id}">${v.name} - ${formatCurrency(finalPrice)}</option>`;
                        });
                        variationSelect.disabled = false;
                    }
                }
            }
        });


        const getReceiptPdfHtml = (doc) => {
            const client = db.clients.find(c => c.id == doc.clientId);
            const value = doc.value;
            const valueInWords = numberToWords(value);

            return `
                <div class="pdf-document-container">
                    ${getDocumentHeaderHtml()}
                    <div class="pdf-content">
                        <h1>Recibo de Pagamento</h1>
                        
                        <div class="receipt-value-box">
                            Valor: <span class="value">${formatCurrency(value)}</span>
                        </div>
                        
                        <p>Recebi de <strong>${client.name}</strong> (CPF/CNPJ: ${client.cpf || 'Não informado'}), a importância de <strong>${formatCurrency(value)}</strong>.</p>
                        
                        <p>Valor por extenso: (<strong>${valueInWords}</strong>).</p>
                        
                        <p>Referente a: <strong>${doc.referente}</strong>.</p>
                        
                        <p>Para clareza, firmo o presente recibo.</p>
                        
                        <p class="pdf-centered-text" style="margin-top: 10mm;">Maceió, ${new Date(doc.date + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' })}.</p>
                        
                        <div class="pdf-signatures">
                            <div class="pdf-signature-line">
                                ${db.settings.brokerName}<br>
                                ${db.settings.brokerCreci}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };
        
        // (A função getContractFormHtml e getContractPdfHtml seriam muito complexas e específicas)
        // Por enquanto, vamos focar nos recibos.
        document.getElementById('add-receipt-btn').addEventListener('click', () => {
            openModal('Gerar Novo Recibo', getReceiptFormHtml(), 'receipt');
        });
        
        document.getElementById('add-contract-btn').addEventListener('click', () => {
            alert('A geração de contratos personalizados ainda não foi implementada.');
        });


        const renderDocumentsTable = () => {
            const tbody = document.querySelector('#documents-table tbody');
            tbody.innerHTML = '';
            
            if (db.contracts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">Nenhum documento gerado.</td></tr>';
                return;
            }

            db.contracts.forEach(doc => {
                const client = db.clients.find(c => c.id == doc.clientId);
                let propName = 'N/A';
                if (doc.propertyId && doc.variationId) {
                    const prop = db.properties.find(p => p.id == doc.propertyId);
                    if (prop) {
                        const variation = prop.variations.find(v => v.id == doc.variationId);
                        propName = `${prop.name} (${variation.name})`;
                    }
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td>${doc.type === 'receipt' ? 'Recibo' : 'Contrato'}</td>
                        <td>${client ? client.name : 'N/A'}</td>
                        <td>${propName}</td>
                        <td>${formatCurrency(doc.value)}</td>
                        <td>${formatDate(doc.date)}</td>
                        <td class="action-buttons">
                            <button title="Visualizar/Baixar" data-action="view" data-id="${doc.id}"><i class="fas fa-file-pdf"></i></button>
                            <button title="Excluir" data-action="delete" data-id="${doc.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        };
        
        document.querySelector('#documents-table tbody').addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.closest('tr').querySelector('button[data-id]').dataset.id;
            const action = button.dataset.action;
            const doc = db.contracts.find(d => d.id == id);

            if (action === 'delete') {
                if (confirm('Deseja excluir este documento?')) {
                    db.contracts = db.contracts.filter(d => d.id != id);
                    saveData();
                    renderDocumentsTable();
                }
            } else if (action === 'view') {
                if (doc.type === 'receipt') {
                    const pdfHtml = getReceiptPdfHtml(doc);
                    document.getElementById('pdf-generator').innerHTML = pdfHtml;
                    const fileName = `Recibo_${doc.referente.replace(/\s/g, '_')}.pdf`;
                    generatePdf(pdfHtml, fileName);
                }
            }
        });

        // ==========================================
        // GESTÃO DE PORTFÓLIO (PDF)
        // ==========================================
        const getPortfolioFormHtml = () => {
            const propertyOptions = db.properties.map(prop => {
                if (!prop.images || prop.images.length === 0) return ''; // Só mostra se tiver imagem
                return `<option value="${prop.id}">${prop.name}</option>`;
            }).join('');
            
            return `
                <div class="form-group full-width">
                    <label>Selecione os imóveis para incluir no portfólio (arraste para reordenar).</label>
                    <p>Aparecerão aqui apenas imóveis que possuem fotos cadastradas.</p>
                </div>
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div class="form-group" style="background: #f9f9f9; padding: 1rem; border-radius: 5px;">
                        <label for="portfolio-prop-select">Imóveis Disponíveis</label>
                        <select id="portfolio-prop-select" size="10" style="height: 200px;">
                            ${propertyOptions}
                        </select>
                        <button id="portfolio-add-prop" class="btn-primary" style="width: 100%; margin-top: 10px;">Adicionar <i class="fas fa-arrow-right"></i></button>
                    </div>
                    
                    <div class="form-group" style="background: #f9f9f9; padding: 1rem; border-radius: 5px;">
                        <label>Imóveis Selecionados</label>
                        <div id="portfolio-list" style="border: 1px solid #ccc; height: 200px; overflow-y: auto; padding: 5px; background: white;">
                            </div>
                        <button id="portfolio-clear-list" class="btn-danger" style="width: 100%; margin-top: 10px;">Limpar Lista</button>
                    </div>
                </div>
                
                <div class="form-group full-width" style="margin-top: 1rem;">
                    <label for="portfolio-client-name">Nome do Cliente (Opcional - para a capa)</label>
                    <input type="text" id="portfolio-client-name" placeholder="Ex: Sr. Alex Peixoto">
                </div>
            `;
        };

        // Lógica de Arrastar e Soltar (Drag and Drop) para o Portfólio
        let portfolioDragItem = null;
        modalBody.addEventListener('dragstart', e => {
            if (e.target.classList.contains('portfolio-item')) {
                portfolioDragItem = e.target;
                setTimeout(() => e.target.classList.add('dragging'), 0);
            }
        });
        modalBody.addEventListener('dragend', e => {
            if (e.target.classList.contains('portfolio-item')) {
                e.target.classList.remove('dragging');
                portfolioDragItem = null;
            }
        });
        modalBody.addEventListener('dragover', e => {
            const list = e.target.closest('#portfolio-list');
            if (!list || !portfolioDragItem) return;
            e.preventDefault();
            const afterElement = getDragAfterElement(list, e.clientY);
            if (afterElement == null) {
                list.appendChild(portfolioDragItem);
            } else {
                list.insertBefore(portfolioDragItem, afterElement);
            }
        });
        
        document.getElementById('generate-portfolio-btn').addEventListener('click', () => {
            const availableProps = db.properties.filter(p => p.images && p.images.length > 0);
            if (availableProps.length === 0) {
                alert('Você não possui imóveis com fotos cadastradas. Adicione fotos aos imóveis antes de gerar um portfólio.');
                return;
            }
            openModal('Gerar Portfólio de Imóveis (PDF)', getPortfolioFormHtml(), 'portfolio');
        });

        modalBody.addEventListener('click', e => {
            if (currentEntityType !== 'portfolio') return;

            if (e.target.id === 'portfolio-add-prop') {
                const select = document.getElementById('portfolio-prop-select');
                const list = document.getElementById('portfolio-list');
                const selectedOption = select.options[select.selectedIndex];
                if (!selectedOption) return;

                const propId = selectedOption.value;
                const propName = selectedOption.text;
                
                // Verifica se já não está na lista
                if (list.querySelector(`[data-id="${propId}"]`)) {
                    alert('Este imóvel já foi adicionado.');
                    return;
                }
                
                list.innerHTML += `
                    <div class="portfolio-item" draggable="true" data-id="${propId}">
                        <span>${propName}</span>
                        <button data-action="remove-portfolio-item" class="btn-danger" style="padding: 2px 5px; font-size: 0.8rem;">&times;</button>
                    </div>
                `;
            }
            
            if (e.target.id === 'portfolio-clear-list') {
                document.getElementById('portfolio-list').innerHTML = '';
            }
            
            if (e.target.dataset.action === 'remove-portfolio-item') {
                e.target.closest('.portfolio-item').remove();
            }
        });
        
        const getPortfolioPageHtml = (property, clientName, pageNum, totalPages) => {
            const prop = db.properties.find(p => p.id == property.id);
            if (!prop) return '';

            const clientText = clientName ? `Portfólio para ${clientName}` : 'Portfólio de Oportunidades';
            
            const mainImage = (prop.images && prop.mainImageIndex > -1) ? prop.images[prop.mainImageIndex] : 'https://via.placeholder.com/600x400.png?text=Sem+Foto+Principal';
            const secondaryImage1 = (prop.images && prop.images.length > 1) ? prop.images.find((img, i) => i !== prop.mainImageIndex) : 'https://via.placeholder.com/300x200.png?text=Sem+Foto';
            const secondaryImage2 = (prop.images && prop.images.length > 2) ? prop.images.find((img, i) => i !== prop.mainImageIndex && img !== secondaryImage1) : 'https://via.placeholder.com/300x200.png?text=Sem+Foto';

            let amenitiesHtml = '';
            if (prop.amenities && prop.amenities.length > 0) {
                 amenitiesHtml = prop.amenities.slice(0, 10).map(amenityName => { // Limita para caber
                    const amenityData = db.amenities.find(a => a.name === amenityName);
                    const icon = amenityData ? amenityData.icon : 'fas fa-check-square';
                    return `<div class="portfolio-v2-amenity-item"><i class="${icon}"></i> <span>${amenityName}</span></div>`;
                }).join('');
            } else {
                amenitiesHtml = '<p>Diferenciais não informados.</p>';
            }

            // Pega o menor preço
            let startingPrice = 0;
            if (prop.variations && prop.variations.length > 0) {
                const prices = prop.variations.map(v => v.listPrice - (v.discount || 0));
                startingPrice = Math.min(...prices);
            }
            
            // Pega a menor área
            let startingArea = 0;
            if (prop.variations && prop.variations.length > 0) {
                const areas = prop.variations.filter(v => v.area > 0).map(v => v.area);
                if (areas.length > 0) startingArea = Math.min(...areas);
            }

            return `
                <div class="portfolio-page-v2">
                    <header class="portfolio-v2-header">
                        <img src="${db.settings.logoUrl}" alt="Logo" class="portfolio-v2-logo">
                        <div class="portfolio-v2-broker-info">
                            <h1>${db.settings.brokerName}</h1>
                            <p>${db.settings.brokerCreci} | ${db.settings.brokerPhone}</p>
                        </div>
                        <img src="${db.settings.logoUrl}" alt="Logo" class="portfolio-v2-logo" style="opacity: 0;">
                    </header>

                    <div class="portfolio-v2-title">
                        <h2>${prop.name}</h2>
                        <p>${prop.location}</p>
                    </div>

                    <div class="portfolio-v2-image-gallery">
                        <div class="portfolio-v2-main-image" style="background-image: url('${mainImage}');"></div>
                        <div class="portfolio-v2-secondary-image-1" style="background-image: url('${secondaryImage1}');"></div>
                        <div class="portfolio-v2-secondary-image-2" style="background-image: url('${secondaryImage2}');"></div>
                    </div>

                    <div class="portfolio-v2-content-area">
                        <div class="portfolio-v2-details">
                            <h3>Descrição</h3>
                            <div class="portfolio-v2-description">
                                ${prop.description ? prop.description.substring(0, 600).replace(/\n/g, '<br>') : 'Descrição não disponível.'}
                                ${prop.description && prop.description.length > 600 ? '...' : ''}
                            </div>
                            
                            <div class="portfolio-v2-key-info">
                                <p><strong>Valores:</strong> ${startingPrice > 0 ? `A partir de ${formatCurrency(startingPrice)}` : 'Consultar'}</p>
                                <p><strong>Área:</strong> ${startingArea > 0 ? `A partir de ${startingArea} m²` : 'Consultar'}</p>
                            </div>
                        </div>
                        <div class="portfolio-v2-amenities">
                            <h3>Diferenciais</h3>
                            <div class="portfolio-v2-amenities-list">
                                ${amenitiesHtml}
                            </div>
                        </div>
                    </div>

                    <footer class="portfolio-v2-footer">
                        <div class="portfolio-v2-motivational-text">
                            "O melhor momento para comprar um imóvel foi ontem. O segundo melhor é agora."
                        </div>
                        <div class="portfolio-v2-page-number">
                            ${pageNum} / ${totalPages}
                        </div>
                    </footer>
                </div>
            `;
        };
        
        // ==========================================
        // GESTÃO DE CONFIGURAÇÕES
        // ==========================================
        const renderSettings = () => {
            // Dados do Corretor
            document.getElementById('setting-broker-name').value = db.settings.brokerName;
            document.getElementById('setting-broker-creci').value = db.settings.brokerCreci;
            document.getElementById('setting-broker-phone').value = db.settings.brokerPhone;
            // Metas
            document.getElementById('setting-leads-goal').value = db.settings.goals.leads;
            document.getElementById('setting-revenue-goal').value = db.settings.goals.revenue;
            document.getElementById('setting-default-commission').value = db.settings.defaultCommission;
            // Gestão do Funil
            renderFunnelEditor();
            // Gestão de Diferenciais
            renderAmenitiesEditor();
        };

        // Salvar Dados do Corretor
        document.getElementById('save-broker-info').addEventListener('click', () => {
            db.settings.brokerName = document.getElementById('setting-broker-name').value;
            db.settings.brokerCreci = document.getElementById('setting-broker-creci').value;
            db.settings.brokerPhone = document.getElementById('setting-broker-phone').value;
            
            const logoFile = document.getElementById('setting-logo-upload').files[0];
            if (logoFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    db.settings.logoUrl = e.target.result;
                    saveData();
                    updateHeader();
                    showToast('Dados e logo salvos!');
                };
                reader.readAsDataURL(logoFile);
            } else {
                saveData();
                updateHeader();
                showToast('Dados salvos!');
            }
        });

        // Salvar Metas
        document.getElementById('save-goals').addEventListener('click', () => {
            db.settings.goals.leads = parseInt(document.getElementById('setting-leads-goal').value) || 50;
            db.settings.goals.revenue = parseFloat(document.getElementById('setting-revenue-goal').value) || 50000;
            db.settings.defaultCommission = parseFloat(document.getElementById('setting-default-commission').value) || 5;
            saveData();
            showToast('Metas salvas!');
        });

        // Gestão do Funil (Drag and Drop)
        let dragStage = null;
        
        const renderFunnelEditor = () => {
            const editor = document.getElementById('funnel-editor');
            editor.innerHTML = '';
            db.funnelStages.forEach(stage => {
                editor.innerHTML += `
                    <div class="stage-item" draggable="true" data-id="${stage.id}">
                        <i class="fas fa-grip-vertical" style="cursor: move; margin-right: 10px;"></i>
                        <input type="text" class="stage-name-input" value="${stage.name}" data-id="${stage.id}">
                        <input type="number" class="stage-prob-input" value="${stage.probability}" data-id="${stage.id}" style="max-width: 80px;" placeholder="Prob. %">
                        <button class="remove-stage-btn" data-id="${stage.id}">&times;</button>
                    </div>
                `;
            });
        };
        
        document.getElementById('funnel-editor').addEventListener('dragstart', e => {
            if (e.target.classList.contains('stage-item')) {
                dragStage = e.target;
                e.target.classList.add('dragging');
            }
        });
        document.getElementById('funnel-editor').addEventListener('dragend', e => {
            if (e.target.classList.contains('stage-item')) {
                e.target.classList.remove('dragging');
                dragStage = null;
                
                // Salva a nova ordem
                const newStages = [];
                document.querySelectorAll('#funnel-editor .stage-item').forEach(item => {
                    const id = item.dataset.id;
                    const stage = db.funnelStages.find(s => s.id == id);
                    if (stage) newStages.push(stage);
                });
                db.funnelStages = newStages;
                saveData();
                renderFunnelFilters(); // Atualiza os filtros do funil
            }
        });
        document.getElementById('funnel-editor').addEventListener('dragover', e => {
            const editor = document.getElementById('funnel-editor');
            if (!dragStage) return;
            e.preventDefault();
            const afterElement = getDragAfterElement(editor, e.clientY);
            if (afterElement == null) {
                editor.appendChild(dragStage);
            } else {
                editor.insertBefore(dragStage, afterElement);
            }
        });
        
        // Adicionar, remover e editar etapas do funil
        document.getElementById('add-stage-btn').addEventListener('click', () => {
            const name = document.getElementById('new-stage-name').value;
            const prob = parseInt(document.getElementById('new-stage-prob').value) || 0;
            if (name) {
                db.funnelStages.push({ id: Date.now(), name, probability: prob });
                saveData();
                renderFunnelEditor();
                document.getElementById('new-stage-name').value = '';
                document.getElementById('new-stage-prob').value = '';
            }
        });
        document.getElementById('funnel-editor').addEventListener('click', e => {
            if (e.target.classList.contains('remove-stage-btn')) {
                const id = e.target.dataset.id;
                if (confirm('Deseja remover esta etapa?')) {
                    db.funnelStages = db.funnelStages.filter(s => s.id != id);
                    saveData();
                    renderFunnelEditor();
                }
            }
        });
        document.getElementById('funnel-editor').addEventListener('change', e => {
            const id = e.target.dataset.id;
            const stage = db.funnelStages.find(s => s.id == id);
            if (stage) {
                if (e.target.classList.contains('stage-name-input')) {
                    stage.name = e.target.value;
                }
                if (e.target.classList.contains('stage-prob-input')) {
                    stage.probability = parseInt(e.target.value) || 0;
                }
                saveData();
            }
        });
        
        // Gestão de Diferenciais
        const renderAmenitiesEditor = () => {
            const list = document.getElementById('amenities-list');
            list.innerHTML = '';
            db.amenities.forEach(amenity => {
                list.innerHTML += `
                    <div class="amenity-list-item" data-name="${amenity.name}">
                        <span><i class="${amenity.icon || 'fas fa-check-square'}"></i> ${amenity.name}</span>
                        <button class="remove-amenity-btn" data-name="${amenity.name}">&times;</button>
                    </div>
                `;
            });
        };
        
        document.getElementById('amenities-list').addEventListener('click', e => {
            const btn = e.target.closest('.remove-amenity-btn');
            if (btn) {
                const name = btn.dataset.name;
                if (confirm(`Deseja remover o diferencial "${name}"? Ele será removido de todos os imóveis.`)) {
                    db.amenities = db.amenities.filter(a => a.name !== name);
                    // Remove de todos os imóveis que o usam
                    db.properties.forEach(prop => {
                        if (prop.amenities) {
                            prop.amenities = prop.amenities.filter(a => a !== name);
                        }
                    });
                    saveData();
                    renderAmenitiesEditor();
                }
            }
        });

        // ==========================================
        // DASHBOARD
        // ==========================================
        // Função auxiliar nova para buscar alertas de lista de espera
        const getWaitingListAlertsHtml = () => {
            const alerts = [];
            
            db.clients.forEach(client => {
                // Se o cliente está na lista de espera E tem um imóvel selecionado
                if (client.waitingList && client.propertyId) {
                    const prop = db.properties.find(p => p.id == client.propertyId);
                    
                    // Se o imóvel existe e o status AGORA é 'lancamento'
                    if (prop && prop.status === 'lancamento') {
                        alerts.push({
                            clientName: client.name,
                            propName: prop.name,
                            clientId: client.id,
                            phone: client.phone
                        });
                    }
                }
            });

            if (alerts.length === 0) return '<li>Nenhum cliente na lista de espera de imóveis lançados.</li>';

            return alerts.map(alert => `
                <li class="dashboard-event-item" style="border-left: 4px solid #28a745; padding-left: 10px;">
                    <strong>🚀 OPORTUNIDADE:</strong> ${alert.propName} virou Lançamento!
                    <br>Avise <strong>${alert.clientName}</strong> agora.
                    <br><small>
                        <a href="https://wa.me/${(alert.phone || '').replace(/\D/g, '')}?text=Olá ${alert.clientName.split(' ')[0]}! Tenho uma ótima notícia: O ${alert.propName} acabou de ser lançado oficialmente!" target="_blank" style="color: #25D366; text-decoration: none; font-weight: bold;">
                        <i class="fab fa-whatsapp"></i> Enviar Notícia
                        </a>
                         | <span class="btn-link" onclick="document.querySelector('.nav-btn[data-panel=\\'clients\\']').click(); setTimeout(() => { document.querySelector('button[data-action=\\'edit\\'][data-id=\\'${alert.clientId}\\']').click(); }, 500);" style="cursor:pointer;">Editar Cliente (remover da lista)</span>
                    </small>
                </li>
            `).join('');
        };

        const renderDashboard = () => {
            const container = document.getElementById('dashboard-content');
            container.innerHTML = ''; // Limpa o dashboard
            
            // NOVO CARD: Alertas de Lançamento (Lista de Espera)
            // Colocamos ele em PRIMEIRO lugar para dar destaque
            container.innerHTML += getDashboardCardHtml('Lista de Espera (Lançamentos Ativos)', 'fas fa-bullhorn', getWaitingListAlertsHtml());

            // 1. Próximos Eventos
            container.innerHTML += getDashboardCardHtml('Proximos Compromissos', 'fas fa-calendar-check', getUpcomingEventsHtml());
            
            // 2. Aniversariantes da Semana
            container.innerHTML += getDashboardCardHtml('Aniversariantes da Semana', 'fas fa-birthday-cake', getBirthdaysHtml());

            // 3. Alertas Financeiros
            container.innerHTML += getDashboardCardHtml('Alertas Financeiros', 'fas fa-dollar-sign', getFinancialAlertsHtml());
            
            // 4. Clientes Estagnados
            container.innerHTML += getDashboardCardHtml('Oportunidades Estagnadas', 'fas fa-user-clock', getStaleClientsHtml());
            
            // Renderiza o gráfico do funil
            renderFunnelChart();
        };
        
        const getDashboardCardHtml = (title, icon, content) => {
            return `
                <div class="dashboard-card">
                    <h3><i class="${icon}"></i> ${title}</h3>
                    <ul>
                        ${content}
                    </ul>
                </div>
            `;
        };

        const getUpcomingEventsHtml = () => {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const sevenDaysFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);

            const upcoming = db.events.filter(event => {
                if (event.completed || !event.date) return false;
                const eventDate = new Date(event.date + 'T00:00:00');
                return eventDate >= today && eventDate <= sevenDaysFromNow;
            }).sort((a,b) => new Date(a.date) - new Date(b.date));

            if (upcoming.length === 0) return '<li>Nenhum compromisso nos próximos 7 dias.</li>';

            return upcoming.map(event => {
                const client = db.clients.find(c => c.id == event.clientId);
                return `
                    <li class="dashboard-event-item" data-event-id="${event.id}">
                        <strong>${event.title}</strong> (${formatDate(event.date)})
                        ${client ? `<br><small>Cliente: ${client.name}</small>` : ''}
                    </li>
                `;
            }).join('');
        };
        
        const getBirthdaysHtml = () => {
             const today = new Date();
             const todayDay = today.getDate();
             const todayMonth = today.getMonth();
             const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);

             const upcoming = db.clients.filter(client => {
                 if (!client.birthdate) return false;
                 const birthDate = new Date(client.birthdate + 'T00:00:00');
                 const birthDay = birthDate.getDate();
                 const birthMonth = birthDate.getMonth();
                 
                 // Cria datas de aniversário deste ano e do próximo
                 const thisYearBirthday = new Date(today.getFullYear(), birthMonth, birthDay);
                 const nextYearBirthday = new Date(today.getFullYear() + 1, birthMonth, birthDay);
                 
                 return (thisYearBirthday >= today && thisYearBirthday <= nextWeek) || 
                        (nextYearBirthday >= today && nextYearBirthday <= nextWeek);
             });

            if (upcoming.length === 0) return '<li>Nenhum aniversariante na próxima semana.</li>';

            return upcoming.map(client => `
                <li class="dashboard-event-item" data-client-id="${client.id}">
                    <strong>${client.name}</strong> (${new Date(client.birthdate + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })})
                    <br><small><a href="https://wa.me/${(client.phone || '').replace(/\D/g, '')}?text=Olá, ${client.name.split(' ')[0]}! Parabéns pelo seu aniversário!" target="_blank"><i class="fab fa-whatsapp"></i> Enviar Parabéns</a></small>
                </li>
            `).join('');
        };
        
        const getFinancialAlertsHtml = () => {
            const today = new Date().toISOString().slice(0, 10);
            const alerts = [];

            db.financialRecords.forEach(record => {
                record.payments.forEach(payment => {
                    if (payment.status === 'pending' && payment.date <= today) {
                        alerts.push({
                            record: record,
                            payment: payment,
                            isOverdue: payment.date < today
                        });
                    }
                });
            });

            if (alerts.length === 0) return '<li>Nenhum lançamento vencido ou vencendo hoje.</li>';
            
            alerts.sort((a,b) => new Date(a.payment.date) - new Date(b.payment.date)); // Vencidos primeiro

            return alerts.map(alert => `
                <li class="financial-alert-item ${alert.isOverdue ? 'overdue' : ''}" data-record-id="${alert.record.id}">
                    ${alert.record.description} (${formatCurrency(alert.record.value)})
                    <span class="alert-details">
                        ${alert.isOverdue ? 'Venceu em' : 'Vence hoje'}: ${formatDate(alert.payment.date)}
                        (${alert.record.type === 'income' ? 'A Receber' : 'A Pagar'})
                    </span>
                </li>
            `).join('');
        };
        
        const getStaleClientsHtml = () => {
            const staleClients = getStaleClientsForArchiving();
            if (staleClients.length === 0) return '<li>Nenhum cliente estagnado (com 3+ contatos na mesma etapa).</li>';

            return staleClients.map(client => {
                const stage = db.funnelStages.find(s => s.id === client.stageId);
                return `
                    <li class="dashboard-event-item" data-client-id="${client.id}">
                        <strong>${client.name}</strong>
                        <br><small>Estagnado em: "${stage ? stage.name : 'N/A'}"</small>
                    </li>
                `;
            }).join('');
        };
        
        // Listeners para cliques no Dashboard
        document.getElementById('dashboard-content').addEventListener('click', e => {
            const eventItem = e.target.closest('.dashboard-event-item[data-event-id]');
            const clientItem = e.target.closest('.dashboard-event-item[data-client-id]');
            const financialItem = e.target.closest('.financial-alert-item[data-record-id]');

            if (eventItem) {
                const eventId = eventItem.dataset.eventId;
                const event = db.events.find(ev => ev.id == eventId);
                if (event) {
                    switchPanel('agenda');
                    openModal('Editar Compromisso', getEventFormHtml(event), 'event', eventId);
                }
            } else if (clientItem) {
                const clientId = clientItem.dataset.clientId;
                const client = db.clients.find(c => c.id == clientId);
                if (client) {
                    switchPanel('clients');
                    const clientHtml = getClientDetailsHtml(clientId);
                    const modalBodyHtml = `<div class="record-details">${clientHtml}</div>`;
                    openModal(`Ficha de ${client.name}`, modalBodyHtml, 'view', null, false);
                }
            } else if (financialItem) {
                const recordId = financialItem.dataset.recordId;
                const record = db.financialRecords.find(r => r.id == recordId);
                if(record) {
                    switchPanel('financial');
                    if (record.recurrence === 'monthly') {
                        const manageHtml = getPaymentManagementHtml(recordId);
                        openModal(`Gerenciar Parcelas: ${record.description}`, manageHtml, 'paymentManager', recordId, false);
                    } else {
                        openModal('Editar Lançamento', getFinancialFormHtml(record), 'financialRecord', recordId);
                    }
                }
            }
        });


        // ==========================================
        // GRÁFICO DO FUNIL (DASHBOARD)
        // ==========================================
        const renderFunnelChart = () => {
            const container = document.getElementById('funnel-chart');
            container.innerHTML = '';
            
            const stageCounts = {};
            db.funnelStages.forEach(stage => stageCounts[stage.id] = { name: stage.name, count: 0, color: '' });
            
            db.clients.forEach(client => {
                if (stageCounts[client.stageId]) {
                    stageCounts[client.stageId].count++;
                }
            });

            const totalClients = db.clients.length;
            if (totalClients === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem;">Nenhum cliente cadastrado para exibir o funil.</p>';
                return;
            }
            
            const colors = ['#D4AF37', '#2C3E50', '#3498DB', '#2ECC71', '#E74C3C', '#9B59B6', '#F39C12'];
            let colorIndex = 0;
            
            const stagesData = db.funnelStages.map(stage => {
                const data = stageCounts[stage.id];
                data.color = colors[colorIndex % colors.length];
                colorIndex++;
                return data;
            });
            
            // Calcula a altura máxima
            const maxCount = Math.max(...stagesData.map(s => s.count));
            if (maxCount === 0) {
                 container.innerHTML = '<p style="text-align: center; padding: 2rem;">Nenhum cliente no funil.</p>';
                return;
            }

            stagesData.forEach(stage => {
                const heightPercent = (stage.count / maxCount) * 100;
                container.innerHTML += `
                    <div class="funnel-bar-wrapper">
                        <div class="funnel-bar" style="height: ${heightPercent}%; background-color: ${stage.color};">
                            <span class="funnel-bar-label">${stage.count}</span>
                        </div>
                        <div class="funnel-stage-name">${stage.name}</div>
                    </div>
                `;
            });
        };

        // ==========================================
        // LÓGICA PRINCIPAL DE SALVAMENTO (MODAL)
        // ==========================================
        modalSaveBtn.addEventListener('click', async () => {
            try {
                // Desabilita o botão para evitar cliques duplos
                modalSaveBtn.disabled = true;
                modalSaveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

                // --- GESTÃO DE CLIENTES ---
                if (currentEntityType === 'client') {
                    const clientData = {
                        id: currentEditingId || Date.now(),
                        name: document.getElementById('client-name').value,
                        phone: document.getElementById('client-phone').value,
                        email: document.getElementById('client-email').value,
                        cpf: document.getElementById('client-cpf').value,
                        birthdate: document.getElementById('client-birthdate').value,
                        income: parseFloat(document.getElementById('client-income').value) || 0,
                        waitingList: document.getElementById('client-waiting-list').checked, // <--- ADICIONE ESSA LINHA
                        hasFormalWork: document.getElementById('client-formal-work').checked,
                        alreadyOwnsProperty: document.getElementById('client-has-property').checked,
                        commission: parseFloat(document.getElementById('client-commission').value) || null,
                        stageId: parseInt(document.getElementById('client-stageId').value),
                        leadSource: document.getElementById('client-lead-source').value,
                        propertyId: document.getElementById('client-propertyId').value ? parseFloat(document.getElementById('client-propertyId').value) : null,
                        variationId: document.getElementById('client-variationId').value ? parseFloat(document.getElementById('client-variationId').value) : null,
                        notes: document.getElementById('client-notes').value,
                        // Dados do Cônjuge
                        spouseName: document.getElementById('spouse-name').value,
                        spouseCpf: document.getElementById('spouse-cpf').value,
                        spouseBirthdate: document.getElementById('spouse-birthdate').value,
                        spouseIncome: parseFloat(document.getElementById('spouse-income').value) || 0,
                        spouseComposesIncome: document.getElementById('client-spouse-composes-income').checked,
                        // Histórico
                        contactHistory: currentEditingId ? db.clients.find(c=>c.id==currentEditingId).contactHistory : [],
                        lastContact: currentEditingId ? db.clients.find(c=>c.id==currentEditingId).lastContact : null,
                    };

                    if (!clientData.name || !clientData.phone) {
                        throw new Error('Nome e Contato são obrigatórios.');
                    }
                    
                    if (currentEditingId) {
                        const index = db.clients.findIndex(c => c.id == currentEditingId);
                        db.clients[index] = clientData;
                    } else {
                        db.clients.push(clientData);
                    }
                    triggerClientTableRender();
                }
                
                // --- GESTÃO DE IMÓVEIS (EMPREENDIMENTOS) ---
                else if (currentEntityType === 'property') {
                    const selectedAmenities = Array.from(document.querySelectorAll('input[name="amenities"]:checked')).map(cb => cb.value);
                    const videoLink = document.getElementById('prop-video-link').value;
                    
                    const propData = {
                        id: currentEditingId || Date.now(),
                        name: document.getElementById('prop-name').value,
                        status: document.getElementById('prop-status').value, // <--- ADICIONE ESSA LINHA
                        location: document.getElementById('prop-location').value,
                        link: document.getElementById('prop-link').value,
                        videoLink: getEmbedVideoUrl(videoLink),
                        description: document.getElementById('prop-description').value,
                        images: tempPropertyImages,
                        mainImageIndex: tempMainImageIndex,
                        amenities: selectedAmenities,
                        variations: tempPropertyVariations
                    };
                    
                    if (!propData.name) {
                        throw new Error('O Nome do Empreendimento é obrigatório.');
                    }
                    if (propData.variations.length === 0) {
                         if (!confirm('Este empreendimento não possui nenhuma variação (unidade) cadastrada. Deseja salvar mesmo assim?')) {
                            throw new Error('Salvamento cancelado pelo usuário.');
                         }
                    }

                    if (currentEditingId) {
                        const index = db.properties.findIndex(p => p.id == currentEditingId);
                        db.properties[index] = propData;
                    } else {
                        db.properties.push(propData);
                    }
                    renderPropertiesTable();
                }
                
                // --- GESTÃO DA AGENDA ---
                else if (currentEntityType === 'event') {
                    const eventData = {
                        id: currentEditingId || Date.now(),
                        title: document.getElementById('event-title').value,
                        clientId: document.getElementById('event-client').value ? parseInt(document.getElementById('event-client').value) : null,
                        date: document.getElementById('event-date').value,
                        time: document.getElementById('event-time').value,
                        recurrence: document.getElementById('event-recurrence').value,
                        endDate: document.getElementById('event-end-date').value,
                        description: document.getElementById('event-description').value,
                        completed: currentEditingId ? db.events.find(e=>e.id==currentEditingId).completed : false,
                    };
                    
                    if (!eventData.title || !eventData.date) {
                         throw new Error('Título e Data são obrigatórios.');
                    }

                    if (currentEditingId) {
                        const index = db.events.findIndex(e => e.id == currentEditingId);
                        db.events[index] = eventData;
                    } else {
                        db.events.push(eventData);
                    }
                    renderAgendaCalendar();
                }

                // --- GESTÃO DE LINKS ---
                else if (currentEntityType === 'link') {
                    const linkData = {
                        id: currentEditingId || Date.now(),
                        title: document.getElementById('link-title').value,
                        url: document.getElementById('link-url').value,
                        shortUrl: '' // Será gerado
                    };
                    
                    if (!linkData.title || !linkData.url) {
                        throw new Error('Título e URL são obrigatórios.');
                    }
                    
                    // Gera um "encurtador" local
                    linkData.shortUrl = linkData.url;
                    
                    if (currentEditingId) {
                        const index = db.usefulLinks.findIndex(l => l.id == currentEditingId);
                        db.usefulLinks[index] = linkData;
                    } else {
                        db.usefulLinks.push(linkData);
                    }
                    renderLinksTable();
                }
                
                // --- GESTÃO FINANCEIRA ---
                else if (currentEntityType === 'financialRecord') {
                    const isRecurring = document.getElementById('fin-recurring').checked;
                    
                    // ======================= INÍCIO DA ADIÇÃO =======================
                    // 1. Lemos o status selecionado (paid ou pending) e
                    // salvamos em uma propriedade temporária.
                    const tempStatus = document.getElementById('fin-status').value;
                    // ======================== FIM DA ADIÇÃO =========================
                    
                    const recordData = {
                        id: currentEditingId || Date.now(),
                        description: document.getElementById('fin-description').value,
                        value: parseFloat(document.getElementById('fin-value').value) || 0,
                        category: document.getElementById('fin-category').value,
                        type: document.getElementById('fin-type').value,
                        startDate: document.getElementById('fin-date').value,
                        recurrence: isRecurring ? 'monthly' : 'none',
                        // ======================= INÍCIO DA ADIÇÃO =======================
                        // 2. Passamos o status temporário para o objeto.
                        // A função generatePaymentsArray (que é chamada agora)
                        // vai ler isso.
                        _tempNewStatus: tempStatus 
                        // ======================== FIM DA ADIÇÃO =========================
                    };

                    if (!recordData.description || recordData.value <= 0 || !recordData.startDate) {
                         throw new Error('Descrição, Valor e Data são obrigatórios.');
                    }
                    
                    // (Re)Gera o array de pagamentos
                    recordData.payments = generatePaymentsArray(recordData);
                    
                    if (currentEditingId) {
                        const index = db.financialRecords.findIndex(r => r.id == currentEditingId);
                        db.financialRecords[index] = recordData;
                    } else {
                        db.financialRecords.push(recordData);
                    }
                    renderFinancialBI();
                    renderFinancialRecordsTable();
                }
                
                // --- GESTÃO DE RELATÓRIOS DE PLANTÃO ---
            else if (currentEntityType === 'dutyReport') {
                const attendedClients = [];
                document.querySelectorAll('.attended-client-item').forEach(item => {
                    attendedClients.push({
                        id: item.dataset.id.startsWith('temp_') ? Date.now() + Math.random() : item.dataset.id,
                        name: item.querySelector('.attended-client-name').value,
                        phone: item.querySelector('.attended-client-phone').value,
                        obs: item.querySelector('.attended-client-obs').value,
                        clientId: item.dataset.selectedClientId || null
                    });
                }); // <-- **A CORREÇÃO PRINCIPAL ESTÁ AQUI**

                const reportData = {
                    id: currentEditingId || Date.now(),
                    date: document.getElementById('duty-date').value,
                    location: document.getElementById('duty-location').value,
                    summary: document.getElementById('duty-summary').value,
                    attendedClients: attendedClients
                };

                if (!reportData.date || !reportData.location) {
                    throw new Error('Data e Local do plantão são obrigatórios.');
                }

                if (currentEditingId) {
                    const index = db.dutyReports.findIndex(r => r.id == currentEditingId);
                    db.dutyReports[index] = reportData;
                } else {
                    db.dutyReports.push(reportData);
                }
                renderDutyReportsTable();
            } // <-- Este '}' fecha o 'else if' do dutyReport

            // --- GESTÃO DE NOTAS (KNOWLEDGE BASE) ---
            else if (currentEntityType === 'knowledgeBase') {
                const videoLinks = document.getElementById('note-video-links').value
                    .split('\n')
                    .filter(Boolean) // Remove linhas em branco
                    .map(url => getEmbedVideoUrl(url)); // Converte para embed

                const noteData = {
                    id: currentEditingId || Date.now(),
                    title: document.getElementById('note-title').value,
                    content: document.getElementById('note-content').value,
                    images: tempNoteImages,
                    videos: videoLinks,
                    lastModified: Date.now()
                };

                if (!noteData.title) {
                    throw new Error('O Título da nota é obrigatório.');
                }

                if (currentEditingId) {
                    const index = db.knowledgeBase.findIndex(n => n.id == currentEditingId);
                    db.knowledgeBase[index] = noteData;
                } else {
                    db.knowledgeBase.push(noteData);
                }
                renderKnowledgeBase();
            }

                // --- GESTÃO DE DOCUMENTOS (RECIBO) ---
                else if (currentEntityType === 'receipt') {
                    const docData = {
                        id: Date.now(),
                        type: 'receipt',
                        clientId: parseInt(document.getElementById('doc-client-id').value),
                        value: parseFloat(document.getElementById('doc-value').value) || 0,
                        date: document.getElementById('doc-date').value,
                        referente: document.getElementById('doc-referente').value,
                        propertyId: document.getElementById('doc-prop-id').value ? parseInt(document.getElementById('doc-prop-id').value) : null,
                        variationId: document.getElementById('doc-var-id').value ? parseFloat(document.getElementById('doc-var-id').value) : null,
                    };
                    
                    if (!docData.clientId || docData.value <= 0 || !docData.referente) {
                        throw new Error('Cliente, Valor e "Referente a" são obrigatórios.');
                    }
                    
                    db.contracts.push(docData);
                    renderDocumentsTable();
                    
                    // Gera o PDF
                    const pdfHtml = getReceiptPdfHtml(docData);
                    const fileName = `Recibo_${docData.referente.replace(/\s/g, '_')}.pdf`;
                    generatePdf(pdfHtml, fileName);
                }
                
                // --- GESTÃO DE PORTFÓLIO (PDF) ---
                else if (currentEntityType === 'portfolio') {
                    const selectedPropIds = Array.from(document.querySelectorAll('#portfolio-list .portfolio-item')).map(item => item.dataset.id);
                    if (selectedPropIds.length === 0) {
                        throw new Error('Selecione pelo menos um imóvel para o portfólio.');
                    }
                    
                    const clientName = document.getElementById('portfolio-client-name').value;
                    const properties = selectedPropIds.map(id => db.properties.find(p => p.id == id));
                    
                    // Prepara o gerador de PDF
                    const pdfGenerator = document.getElementById('pdf-generator');
                    pdfGenerator.innerHTML = ''; // Limpa
                    
                    // Adiciona as páginas
                    properties.forEach((prop, index) => {
                        pdfGenerator.innerHTML += getPortfolioPageHtml(prop, clientName, index + 1, properties.length);
                    });

                    // Mostra o toast e gera o PDF
                    showToast('Gerando Portfólio PDF... Isso pode levar alguns segundos.');
                    await generateMultiPagePdfFrom('.portfolio-page-v2', `Portfolio_${clientName || 'Imoveis'}.pdf`);
                }


                // --- SALVAMENTO FINAL E FECHAMENTO ---
                await saveData();
                closeModal();
                showToast('Dados salvos com sucesso!');

            } catch (error) {
                console.warn("Erro ao salvar:", error);
                alert(`Erro ao salvar: ${error.message}`);
            } finally {
                // Reabilita o botão
                modalSaveBtn.disabled = false;
                modalSaveBtn.textContent = 'Salvar'; // Restaura o texto original
            }
        });

        // ==========================================
        // LÓGICA DE PDF (GERAL)
        // ==========================================
        const { jsPDF } = window.jspdf;
        
        const generatePdf = async (htmlContent, fileName) => {
            const pdfGenerator = document.getElementById('pdf-generator');
            pdfGenerator.innerHTML = htmlContent;
            
            try {
                const canvas = await html2canvas(pdfGenerator, {
                    scale: 2, // Aumenta a resolução
                    useCORS: true,
                    logging: false,
                    onclone: (clonedDoc) => {
                        // Garante que o container esteja visível para o html2canvas
                        const tempContainer = clonedDoc.getElementById('pdf-generator');
                        tempContainer.style.left = '0px';
                        tempContainer.style.top = '0px';
                    }
                });
                
                const imgData = canvas.toDataURL('image/jpeg', 0.90);
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(fileName);
                
            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                alert("Ocorreu um erro ao gerar o PDF.");
            } finally {
                 pdfGenerator.innerHTML = ''; // Limpa
            }
        };

        const generateMultiPagePdfFrom = async (selector, fileName) => {
            const pdf = new jsPDF('p', 'mm', 'a4');
            const elements = document.querySelectorAll(selector);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();

            for (let i = 0; i < elements.length; i++) {
                const element = elements[i];
                
                try {
                    const canvas = await html2canvas(element, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        width: element.offsetWidth,
                        height: element.offsetHeight,
                        windowWidth: 210 * 3.78, // A4 width in pixels
                        windowHeight: 297 * 3.78 // A4 height in pixels
                    });
                    
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    
                    if (i > 0) {
                        pdf.addPage();
                    }
                    
                    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                    
                } catch (error) {
                    console.error(`Erro ao processar página ${i+1} do PDF:`, error);
                }
            }
            
            pdf.save(fileName);
            document.getElementById('pdf-generator').innerHTML = ''; // Limpa
        };


        // ==========================================
        // LÓGICA DE IMPRESSÃO (GERAL)
        // ==========================================
        const printContent = (htmlContent, title) => {
            const printArea = document.getElementById('print-area');
            const headerHtml = getDocumentHeaderHtml(true); // Pega o cabeçalho de impressão
            
            document.title = title; // Define o título da página (aparece na impressão)
            
            printArea.innerHTML = `
                <div class="printable-document">
                    ${headerHtml}
                    ${htmlContent}
                </div>
            `;
            
            // Se for um imóvel, gera o QR Code
            const propLink = db.properties.find(p => htmlContent.includes(p.name))?.link;
            if (propLink) {
                generateQrCodeForPrint(propLink);
            }

            window.print(); // Abre a caixa de diálogo de impressão
            printArea.innerHTML = ''; // Limpa após a impressão
            document.title = 'CRM Imobiliário de Luxo'; // Restaura o título
        };

        // ==========================================
        // LÓGICA DE IMPORTAÇÃO/EXPORTAÇÃO (Excel, JSON)
        // ==========================================
        
        // --- EXPORTAÇÃO EXCEL ---
        const exportToExcel = (data, fileName, headers) => {
            const ws = XLSX.utils.json_to_sheet(data, { header: headers });
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Dados");
            XLSX.writeFile(wb, fileName);
        };
        
        document.getElementById('export-clients-excel').addEventListener('click', () => {
            // Pega os clientes *atualmente visíveis* na tabela
            const searchValue = document.getElementById('client-search').value;
            const stageValue = document.querySelector('.funnel-filter-btn.active')?.dataset.stageId;
            const sourceValue = document.getElementById('client-source-filter').value;

            let filteredClients = db.clients.filter(c => 
                (c.name || '').toLowerCase().includes(searchValue.toLowerCase())
            );
            if (stageValue && stageValue !== 'all') {
                filteredClients = filteredClients.filter(c => c.stageId == stageValue);
            }
            if (sourceValue && sourceValue !== 'all') {
                filteredClients = filteredClients.filter(c => c.leadSource === sourceValue);
            }
            
            const dataToExport = filteredClients.map(c => {
                 const stage = db.funnelStages.find(s => s.id === c.stageId);
                 let propName = '';
                 let varName = '';
                 if(c.propertyId && c.variationId) {
                     const prop = db.properties.find(p => p.id == c.propertyId);
                     if(prop) {
                         const variation = prop.variations.find(v => v.id == c.variationId);
                         if(variation) {
                             propName = prop.name;
                             varName = variation.name;
                         }
                     }
                 }
                 return {
                    "Nome": c.name,
                    "Contato": c.phone,
                    "Email": c.email,
                    "CPF": c.cpf,
                    "Nascimento": c.birthdate,
                    "Renda": c.income,
                    "Etapa": stage ? stage.name : 'N/A',
                    "Origem": c.leadSource,
                    "Empreendimento": propName,
                    "Variacao": varName,
                    "Obs": c.notes
                 };
            });
            
            const headers = ["Nome", "Contato", "Email", "CPF", "Nascimento", "Renda", "Etapa", "Origem", "Empreendimento", "Variacao", "Obs"];
            exportToExcel(dataToExport, "Clientes_CRM.xlsx", headers);
        });
        
        document.getElementById('export-properties-excel').addEventListener('click', () => {
            const dataToExport = [];
            db.properties.forEach(prop => {
                if (prop.variations && prop.variations.length > 0) {
                    prop.variations.forEach(v => {
                        dataToExport.push({
                            "Empreendimento": prop.name,
                            "Localizacao": prop.location,
                            "Variacao": v.name,
                            "Area (m²)": v.area,
                            "Valor Tabela": v.listPrice,
                            "Desconto": v.discount,
                            "Valor Final": v.listPrice - (v.discount || 0),
                            "Avaliacao": v.evalPrice,
                            "Sinal": v.sinal,
                            "Nº Parc. Entrada": v.entradaParcelas,
                            "Valor Parc. Entrada": v.entradaValor,
                            "Nº Intercaladas": v.intercaladasParcelas,
                            "Valor Intercalada": v.intercaladaValor,
                            "Chaves": v.chaves
                        });
                    });
                } else {
                     dataToExport.push({ "Empreendimento": prop.name, "Localizacao": prop.location });
                }
            });
            
            const headers = [
                "Empreendimento", "Localizacao", "Variacao", "Area (m²)", "Valor Tabela", "Desconto", 
                "Valor Final", "Avaliacao", "Sinal", "Nº Parc. Entrada", "Valor Parc. Entrada", 
                "Nº Intercaladas", "Valor Intercalada", "Chaves"
            ];
            exportToExcel(dataToExport, "Imoveis_CRM.xlsx", headers);
        });

        // --- BACKUP JSON ---
        document.getElementById('export-backup-btn').addEventListener('click', () => {
            const backupData = JSON.stringify(db);
            const blob = new Blob([backupData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_crm_luxo_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup completo exportado!');
        });// ▼▼▼ COLE ESTE BLOCO NOVO ▼▼▼
// Botão para EXPORTAR apenas imóveis
document.getElementById('export-properties-btn').addEventListener('click', () => {
    // 1. Pega apenas os dados dos imóveis
    const propertiesData = db.properties;
    
    // 2. Converte para JSON
    const backupData = JSON.stringify(propertiesData, null, 2); // O 'null, 2' formata o JSON
    
    // 3. Cria o arquivo e o link para download
    const blob = new Blob([backupData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup_APENAS_IMOVEIS_${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    // 4. Avisa o usuário
    showToast('Backup dos imóveis exportado!');
});
// ▲▲▲ FIM DO BLOCO NOVO ▲▲▲
        document.getElementById('import-backup-btn').addEventListener('click', () => {
            const file = document.getElementById('import-backup').files[0];
            if (!file) {
                alert('Selecione um arquivo de backup (.json).');
                return;
            }
            if (confirm('Tem certeza? Isso irá SOBRESCREVER todos os dados atuais do sistema.')) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedDb = JSON.parse(e.target.result);
                        // Validação simples
                        if (importedDb.settings && importedDb.clients && importedDb.properties) {
                            db = { ...defaultDb, ...importedDb }; // Mescla para garantir que novos campos existam
                            await saveData();
                            showToast('Backup importado com sucesso! Recarregando...');
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            throw new Error('Arquivo JSON inválido ou não é um backup do CRM.');
                        }
                    } catch (error) {
                        alert(`Erro ao importar o backup: ${error.message}`);
                    }
                };
                reader.readAsText(file);
            }
        });
        // ▼▼▼ COLE ESTE BLOCO NOVO ▼▼▼
// Botão para IMPORTAR apenas imóveis
document.getElementById('import-properties-btn').addEventListener('click', () => {
    const file = document.getElementById('import-properties').files[0];
    if (!file) {
        alert('Selecione um arquivo .json de imóveis.');
        return;
    }
    
    // 1. Confirmação de segurança
    if (confirm('Tem certeza? Isso irá SOBRESCREVER sua lista de imóveis atual. Clientes, agenda e configurações NÃO serão afetados.')) {
        const reader = new FileReader();
        
        reader.onload = async (e) => {
            try {
                const importedProperties = JSON.parse(e.target.result);
                
                // 2. Validação simples (verifica se é uma lista)
                if (Array.isArray(importedProperties)) {
                    
                    // 3. O PONTO CRÍTICO: Substitui SÓ os imóveis
                    db.properties = importedProperties;
                    
                    // 4. Salva a mudança no banco de dados
                    await saveData();
                    
                    showToast('Imóveis importados com sucesso! Atualizando lista...');
                    
                    // 5. Atualiza a tabela na tela (para você ver a mudança na hora)
                    if (document.getElementById('panel-properties').classList.contains('active')) {
                        renderPropertiesTable();
                    }
                    
                } else {
                    throw new Error('Arquivo JSON inválido. O arquivo deve ser uma lista (array) de imóveis.');
                }
            } catch (error) {
                alert(`Erro ao importar os imóveis: ${error.message}`);
            }
        };
        
        reader.readAsText(file);
    }
});
// ▲▲▲ FIM DO BLOCO NOVO ▲▲▲
        // --- LIMPEZA DE DADOS ---
        document.getElementById('clear-system-btn').addEventListener('click', async () => {
            if (confirm('!!! ATENÇÃO !!!\n\nDeseja realmente APAGAR TODOS OS DADOS do sistema? Clientes, imóveis, agenda, TUDO será perdido. Esta ação não pode ser desfeita.')) {
                if (prompt('Para confirmar, digite "DELETAR TUDO" (em maiúsculas)') === 'DELETAR TUDO') {
                    db = JSON.parse(JSON.stringify(defaultDb)); // Reseta para o padrão
                    await saveData();
                    showToast('Sistema resetado. Recarregando...');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    alert('Ação cancelada.');
                }
            }
        });

        // ==========================================
        // FUNÇÕES UTILITÁRIAS (Extras)
        // ==========================================
        
        // Toast (alerta rápido)
        const showToast = (message) => {
            const toast = document.getElementById('quick-actions-toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        };

        // Pega o elemento após o qual o item arrastado deve ser inserido
        const getDragAfterElement = (container, y) => {
            const draggableElements = [...container.querySelectorAll('[draggable="true"]:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        };

        // Converte links do YouTube/Vimeo para o formato de embed
        const getEmbedVideoUrl = (url) => {
            if (!url) return null;
            let embedUrl = null;
            try {
                const urlObj = new URL(url);
                if (urlObj.hostname.includes('youtube.com')) {
                    const videoId = urlObj.searchParams.get('v');
                    if (videoId) embedUrl = `https://www.youtube.com/embed/${videoId}`;
                } else if (urlObj.hostname.includes('youtu.be')) {
                    const videoId = urlObj.pathname.slice(1);
                    if (videoId) embedUrl = `https://www.youtube.com/embed/${videoId}`;
                } else if (urlObj.hostname.includes('vimeo.com')) {
                    const videoId = urlObj.pathname.split('/')[1];
                    if (videoId) embedUrl = `https://player.vimeo.com/video/${videoId}`;
                }
            } catch (error) {
                console.warn("URL de vídeo inválida:", url);
                return null;
            }
            return embedUrl;
        };
        

        // ==========================================
        // INICIALIZAÇÃO DO SISTEMA
        // ==========================================
        const init = async () => {
            await loadData();
            updateHeader();
            switchPanel('dashboard'); // Começa no dashboard
            checkStartupAlerts(); // Mostra alertas de inicialização
            
            // --- OUVINTES GLOBAIS ---
            
            // --- Ouvinte para WhatsApp na agenda (passo 2 de 2) ---
            modalBody.addEventListener('click', e => {
                const whatsappBtn = e.target.closest('button[data-action="day-view-whatsapp"]');
                if (whatsappBtn) {
                    const clientId = whatsappBtn.dataset.clientId;
                    const phone = whatsappBtn.dataset.phone;
                    
                    // 1. Abre o WhatsApp
                    const url = `https://wa.me/${phone}`;
                    window.open(url, '_blank');
                    
                    // 2. Registra o contato no cliente
                    const client = db.clients.find(c => c.id == clientId);
                    if (client) {
                        client.lastContact = new Date().toISOString().slice(0, 10);
                        if (!client.contactHistory) client.contactHistory = [];
                        
                        client.contactHistory.push({
                            date: client.lastContact,
                            stageId: client.stageId
                        });
                        
                        saveData();
                        showToast(`Contato com ${client.name.split(' ')[0]} registrado!`);
                    }
                }
            });
        };
// --- Ouvinte para o card "A Vencer" ---
document.getElementById('card-pending-payments').addEventListener('click', () => {
    financialFilterState = 'upcoming'; // Define o estado do filtro
    switchPanel('financial'); // Muda para o painel financeiro
    // Limpa a busca de texto para não confundir os filtros
    const searchInput = document.getElementById('financial-search');
    if (searchInput) searchInput.value = '';
    renderFinancialRecordsTable(); // Renderiza com o novo filtro de estado
});
// --- Ouvinte para a nova barra de busca financeira ---
document.getElementById('panel-financial').addEventListener('input', e => {
    if (e.target.id === 'financial-search') {
        renderFinancialRecordsTable(e.target.value);
    }
});
const getFinancialReportHtml = () => {
    // Pega os valores dos cards de BI
    const realizedRevenue = document.getElementById('bi-realized-revenue').textContent;
    const realizedExpense = document.getElementById('bi-realized-expense').textContent;
    const balance = document.getElementById('bi-balance').textContent;
    const futureRevenue = document.getElementById('bi-future-revenue').textContent;
    const futureExpense = document.getElementById('bi-future-expense').textContent;

    let recordsHtml = '';
    const allRecords = [...db.financialRecords].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

    if (allRecords.length === 0) {
        recordsHtml = '<p>Nenhum lançamento financeiro registrado.</p>';
    } else {
        // Reutiliza o estilo da tabela do Relatório de Plantão para um visual consistente
        recordsHtml = `
        <table class="pdf-duty-report-table"> 
            <thead>
                <tr>
                    <th>Data (1ª Parc.)</th>
                    <th>Descrição</th>
                    <th>Categoria</th>
                    <th>Tipo</th>
                    <th>Valor</th>
                </tr>
            </thead>
            <tbody>
                ${allRecords.map(record => `
                   <tr>
                        <td>${formatDate(record.startDate)} ${record.recurrence === 'monthly' ? '(Recorrente)' : ''}</td>
                        <td>${record.description}</td>
                        <td>${record.category}</td>
                        <td>${record.type === 'income' ? 'Receita' : 'Despesa'}</td>
                        <td>${formatCurrency(record.value)}</td>
                   </tr>
                `).join('')}
            </tbody>
        </table>
        `;
    }

    return `
        <div class="pdf-content">
            <p>Gerado em: ${new Date().toLocaleString('pt-BR')}</p>

            <h2>Resumo (BI)</h2>
            <div class="report-grid">
                <div class="report-card">
                    <div class="value">${realizedRevenue}</div>
                    <div class="label">Receita Realizada</div>
                </div>
                <div class="report-card">
                    <div class="value">${realizedExpense}</div>
                    <div class="label">Despesa Realizada</div>
                </div>
                <div class="report-card">
                    <div class="value">${balance}</div>
                    <div class="label">Saldo Atual</div>
                </div>
                <div class="report-card">
                    <div class="value" style="font-size: 1.1rem;">${futureRevenue} / ${futureExpense}</div>
                    <div class="label">A Vencer (Rec/Desp)</div>
                </div>
            </div>

            <h2 style="margin-top: 10mm;">Todos os Lançamentos Registrados</h2>
            ${recordsHtml}
        </div>
    `;
};
document.getElementById('generate-financial-report-btn').addEventListener('click', () => {
    const reportHtml = getFinancialReportHtml();
    const title = "Relatorio_Financeiro_" + new Date().toISOString().slice(0, 10);
    // Chama a função de impressão que já existe no sistema
    printContent(reportHtml, title); 
});
        // Inicia o CRM
        init();
    });
    </script>
</body>
</html>
